public Article Article that this dictionaryUUID that dictionaryUUID this volumeId that volumeId this title that title this section that section this pointer that pointer this redirect that redirect this text that text this redirectedFromTitle that redirectedFromTitle 
public Article Article that this dictionaryUUID that this volumeId that volumeId this title that title this section that section this pointer that pointer this redirect that redirect this redirectedFromTitle that redirectedFromTitle 
Override public boolean equals Object obj if this obj return true if obj null return false if getClass obj getClass return false Article other Article obj if pointer other pointer return false if section null if other section null return false else if section equals other section return false if volumeId null if other volumeId null return false else if volumeId equals other volumeId return false return true 
public boolean equalsIgnoreSection Article other return volumeId equals other volumeId pointer other pointer 
SuppressWarnings "rawtypes" static Article fromJsonStr String serializedArticle throws IOException Object[] articleTuple Volume mapper readValue serializedArticle, Object[] class Article article new Article article text String valueOf articleTuple[0] if articleTuple length 3 Map metadata Map articleTuple[2] if metadata containsKey "r" article redirect String valueOf metadata get "r" else if metadata containsKey "redirect" article redirect String valueOf metadata get "redirect" return article 
public String getRedirect if this redirect null this section null return this redirect "#" this section return this redirect 
Override public int hashCode final int prime 31 int result 1 result prime result int pointer ^ pointer 32 result prime result section null ? 0 section hashCode result prime result volumeId null ? 0 volumeId hashCode return result 
public boolean isRedirect return this redirect null 
public boolean sectionEquals Article other return section null other section null section null other section null section equals other section 
ArticleNotFound LookupWord word this word word 
JavascriptInterface public void armScroll this scrollToArmed true 
public ArticleView Context context, AttributeSet attrs, int defStyle super context, attrs, defStyle 
Override protected void onScrollChanged int l, int t, int oldl, int oldt super onScrollChanged l, t, oldl, oldt if scrollListener null scrollListener onScroll l, t, oldl, oldt 
public void realScrollTo int x, int y super scrollTo x, y 
Override public void scrollTo int x, int y On Android 4 1 and 4 2 WebViewClassic setNewPicture ultimately calls scrollTo 0, 0 This happens after page load is finished and after ArticleViewActivity restored scroll position Overriding scrollTo to do nothing reliably prevents this However, this also prevents programmatic scrolling from JavaScript, so now JavaScript must call armScroll before calling any scrolling methods if mustBeArmedToScroll scrollToArmed super scrollTo x, y scrollToArmed false 
public void setOnScrollListener ScrollListener l this scrollListener l 
TargetApi android os Build VERSION_CODES ICE_CREAM_SANDWICH private void applyTextZoomPref SharedPreferences prefs getPreferences MODE_PRIVATE int textZoom prefs getInt "articleView textZoom", 100 articleView getSettings setTextZoom textZoom 
private MapArticle, ScrollXY getScrollPositions int orientation getWindowManager getDefaultDisplay getOrientation switch orientation case Surface ROTATION_0 case Surface ROTATION_180 return scrollPositionsV default return scrollPositionsH 
private void goBack if backItems size 1 finish if currentTask null return if backItems size 1 HistoryItem current backItems remove backItems size 1 HistoryItem prev backItems get backItems size 1 Article prevArticle prev article if prevArticle equalsIgnoreSection current article resetTitleToCurrent if prevArticle sectionEquals current article restoreScrollPos goToSection prevArticle section else showCurrentArticle 
private void goToSection String section Log d TAG, "Go to section " section if section null section trim equals "" scrollTo 0, 0 else articleView loadUrl String format "javascriptscrollToMatch \"s\" ", section 
Override void initUI this scrollPositionsH Collections synchronizedMap new HashMapArticle, ScrollXY this scrollPositionsV Collections synchronizedMap new HashMapArticle, ScrollXY loadAssets if DeviceInfo EINK_SCREEN useAnimation false setContentView R layout eink_article_view articleView ArticleView findViewById R id EinkArticleView N2EpdController n2MainActivity this EinkScreen ResetController 2, articleView force full screen refresh when changing articles Setup animations only on noneink screens else useAnimation true fadeOutAnimation new AlphaAnimation 1f, 0f fadeOutAnimation setDuration 600 fadeOutAnimation setAnimationListener new AnimationAdapter public void onAnimationEnd Animation animation Button nextButton Button findViewById R id NextButton nextButton setVisibility Button GONE getWindow requestFeature Window FEATURE_PROGRESS setContentView R layout article_view articleView ArticleView findViewById R id ArticleView timer new Timer backItems Collections synchronizedList new LinkedListHistoryItem if android os Build VERSION SDK_INT 11 try showFindDialogMethod articleView getClass getMethod "showFindDialog", String class, boolean class catch NoSuchMethodException e1 Log d TAG, "showFindDialog method not found" articleView setOnScrollListener new ArticleView ScrollListener public void onScroll int l, int t, int oldl, int oldt saveScrollPos l, t articleView getSettings setJavaScriptEnabled true articleView addJavascriptInterface new SectionMatcher , "matcher" articleView addJavascriptInterface articleView, "scrollControl" articleView setWebChromeClient new WebChromeClient Override public boolean onJsAlert WebView view, String url, String message, JsResult result Log d TAG " js", String format "[s] s", url, message result cancel return true public void onProgressChanged WebView view, int newProgress Log d TAG, "Progress " newProgress setProgress 5000 newProgress 50 articleView setWebViewClient new WebViewClient Override public void onPageFinished WebView view, String url Log d TAG, "Page finished " url currentTask null String section null if url contains "#" LookupWord lookupWord LookupWord splitWord url section lookupWord section if backItems size 0 HistoryItem currentHistoryItem backItems get backItems size 1 HistoryItem h new HistoryItem currentHistoryItem h article section section backItems add h else if backItems size 0 Article current backItems get backItems size 1 article section current section if restoreScrollPos goToSection section updateNextButtonVisibility articleView armScroll Override public boolean shouldOverrideUrlLoading WebView view, String origUrl Log d TAG, "URL clicked " origUrl final String url if origUrl startsWith BASE_URL url origUrl substring BASE_URL length if currentTask null currentTask new TimerTask public void run try Article currentArticle backItems get backItems size 1 article try IteratorEntry currentIterator dictionaryService followLink url, currentArticle volumeId ListEntry result new ArrayListEntry while currentIterator hasNext result size 20 result add currentIterator next showNext new HistoryItem result catch ArticleNotFound e showMessage getString R string msgArticleNotFound, e word toString catch Exception e StringBuilder msgBuilder new StringBuilder "There was an error following link " append "\"" append url append "\"" if e getMessage null msgBuilder append " " append e getMessage final String msg msgBuilder toString Log e TAG, msg, e showError msg try timer schedule currentTask, 0 catch Exception e Log d TAG, "Failed to schedule task", e else try Uri uri Uri parse origUrl Intent browserIntent new Intent Intent ACTION_VIEW, uri startActivity browserIntent catch Exception e Toast makeText ArticleViewActivity this, String format "Failed to parse URL s", origUrl , Toast LENGTH_SHORT show return true final Button nextButton Button findViewById R id NextButton nextButton getBackground setAlpha 180 nextButton setOnClickListener new View OnClickListener public void onClick View v if nextButton getVisibility View VISIBLE updateNextButtonVisibility nextArticle updateNextButtonVisibility articleView setOnTouchListener new View OnTouchListener public boolean onTouch View v, MotionEvent event updateNextButtonVisibility return false setProgressBarVisibility true 
private void loadAssets try this sharedCSS wrapCSS readFile "shared css" this mediawikiSharedCSS wrapCSS readFile "mediawiki_shared css" this mediawikiMonobookCSS wrapCSS readFile "mediawiki_monobook css" this js wrapJS readFile "aar js" catch IOException e Log e TAG, "Failed to load assets", e 
private void nextArticle HistoryItem current backItems get backItems size 1 if current hasNext showNext current 
TargetApi Build VERSION_CODES HONEYCOMB Override public void onActionModeFinished ActionMode mode super onActionModeFinished mode articleView mustBeArmedToScroll true 
TargetApi Build VERSION_CODES HONEYCOMB Override public void onActionModeStarted ActionMode mode super onActionModeStarted mode articleView mustBeArmedToScroll false 
Override protected void onCreate Bundle savedInstanceState super onCreate savedInstanceState if android os Build VERSION SDK_INT android os Build VERSION_CODES ICE_CREAM_SANDWICH applyTextZoomPref else SharedPreferences prefs getPreferences MODE_PRIVATE float scale prefs getFloat "articleView scale", 1 0f int initialScale Math round scale 100 Log d TAG, "Setting initial article view scale to " initialScale articleView setInitialScale initialScale if android os Build VERSION SDK_INT 11 try Method getActionBar getClass getMethod "getActionBar" Object actionBar getActionBar invoke this Method setDisplayHomeAsUpEnabled actionBar getClass getMethod "setDisplayHomeAsUpEnabled", boolean class setDisplayHomeAsUpEnabled invoke actionBar, true catch Exception e 
Override public boolean onCreateOptionsMenu Menu menu if showFindDialogMethod null MenuItem miFindInPage menu add 0, MENU_FIND_IN_PAGE, 0, R string mnFindInPage setIcon android R drawable ic_menu_search MenuItemCompat setShowAsAction miFindInPage, MenuItemCompat SHOW_AS_ACTION_ALWAYS miViewOnline menu add 0, MENU_VIEW_ONLINE, 0, R string mnViewOnline setIcon android R drawable ic_menu_view menu add 0, MENU_NEW_LOOKUP, 0, R string mnNewLookup setIcon android R drawable ic_menu_search menu add 0, MENU_ZOOM_OUT, 0, R string mnZoomOut setIcon R drawable ic_menu_zoom_out menu add 0, MENU_ZOOM_IN, 0, R string mnZoomIn setIcon R drawable ic_menu_zoom_in miNextArticle menu add 0, MENU_NEXT, 0, R string mnNext setIcon android R drawable ic_media_next MenuItemCompat setShowAsAction miNextArticle, MenuItemCompat SHOW_AS_ACTION_ALWAYS return true 
Override protected void onDestroy super onDestroy timer cancel scrollPositionsH clear scrollPositionsV clear backItems clear 
Override void onDictionaryServiceReady if this backItems isEmpty final Intent intent getIntent if intent null intent getAction null String action intent getAction String _word null if action equals Intent ACTION_SEARCH _word intent getStringExtra "query" else if action equals Intent ACTION_SEND _word intent getStringExtra Intent EXTRA_TEXT final String word _word if word null if currentTask null currentTask cancel currentTask new TimerTask Override public void run setProgress 500 String currentWord word Log d TAG, "intent getDataString " intent getDataString while currentWord length 0 IteratorEntry results dictionaryService lookup currentWord Log d TAG, "Looked up " word if results hasNext currentTask null Entry entry results next showArticle entry break else currentWord currentWord substring 0, currentWord length 1 if currentWord length 0 onSearchRequested try timer schedule currentTask, 0 catch Exception e Log d TAG, "Failed to schedule task", e showError getString R string msgErrorLoadingArticle, word else String word intent getStringExtra "word" String section intent getStringExtra "section" String volumeId intent getStringExtra "volumeId" long articlePointer intent getLongExtra "articlePointer", 1 dictionaryService setPreferred volumeId showArticle volumeId, articlePointer, word, section else showCurrentArticle 
Override public boolean onKeyDown int keyCode, KeyEvent event switch keyCode case KeyEvent KEYCODE_BACK goBack break case NOOK_KEY_PREV_LEFT case NOOK_KEY_PREV_RIGHT case KeyEvent KEYCODE_VOLUME_UP if articleView pageUp false goBack break case KeyEvent KEYCODE_VOLUME_DOWN case NOOK_KEY_NEXT_LEFT case NOOK_KEY_NEXT_RIGHT if articleView pageDown false nextArticle break default return super onKeyDown keyCode, event return true 
public boolean onKeyLongPress int keyCode, KeyEvent event if keyCode KeyEvent KEYCODE_SEARCH finish return true return super onKeyLongPress keyCode, event 
Override public boolean onKeyUp int keyCode, KeyEvent event eat key ups corresponding to key downs so that volume keys don't beep switch keyCode case KeyEvent KEYCODE_BACK case KeyEvent KEYCODE_VOLUME_UP case KeyEvent KEYCODE_VOLUME_DOWN break default return super onKeyDown keyCode, event return true 
Override public boolean onOptionsItemSelected MenuItem item switch item getItemId case MENU_VIEW_ONLINE viewOnline break case android R id home case MENU_NEW_LOOKUP onSearchRequested break case MENU_ZOOM_IN zoomIn break case MENU_ZOOM_OUT zoomOut break case MENU_NEXT nextArticle break case MENU_FIND_IN_PAGE showFindDialog break default return super onOptionsItemSelected item return true 
Override protected void onPause super onPause if android os Build VERSION SDK_INT android os Build VERSION_CODES ICE_CREAM_SANDWICH saveTextZoomPref else SharedPreferences prefs getPreferences MODE_PRIVATE Editor e prefs edit e putFloat "articleView scale", articleView getScale boolean success e commit if success Log w TAG, "Failed to save article view scale pref" 
Override public boolean onPrepareOptionsMenu Menu menu boolean enableViewOnline false boolean hasNextArticle false if this backItems size 0 HistoryItem historyItem backItems get backItems size 1 Article current historyItem article Volume d dictionaryService getVolume current volumeId enableViewOnline d null d getArticleURLTemplate null hasNextArticle historyItem hasNext miViewOnline setEnabled enableViewOnline miNextArticle setVisible hasNextArticle return true 
SuppressWarnings "unchecked", "rawtypes" Override protected void onRestoreInstanceState Bundle savedInstanceState super onRestoreInstanceState savedInstanceState backItems Collections synchronizedList List savedInstanceState getSerializable "backItems" scrollPositionsH Collections synchronizedMap Map savedInstanceState getSerializable "scrollPositionsH" scrollPositionsV Collections synchronizedMap Map savedInstanceState getSerializable "scrollPositionsV" 
SuppressWarnings "unchecked", "rawtypes" Override protected void onSaveInstanceState Bundle outState super onSaveInstanceState outState outState putSerializable "backItems", new LinkedList backItems outState putSerializable "scrollPositionsH", new HashMap scrollPositionsH outState putSerializable "scrollPositionsV", new HashMap scrollPositionsV 
Override public boolean onSearchRequested Intent intent getIntent String action intent null ? null intent getAction if action null String word null if action equals Intent ACTION_SEARCH word intent getStringExtra "query" else if action equals Intent ACTION_SEND word intent getStringExtra Intent EXTRA_TEXT if word null Intent next new Intent next setClass this, LookupActivity class next setAction Intent ACTION_SEARCH next putExtra SearchManager QUERY, word startActivity next finish return true 
private String readFile String name throws IOException final char[] buffer new char[0x1000] StringBuilder out new StringBuilder InputStream is getResources getAssets open name Reader in new InputStreamReader is, "UTF8" int read do read in read buffer, 0, buffer length if read 0 out append buffer, 0, read while read 0 return out toString 
private void resetTitleToCurrent if backItems isEmpty HistoryItem current backItems get backItems size 1 setTitle current 
private boolean restoreScrollPos if backItems size 0 Article a backItems get backItems size 1 article ScrollXY s getScrollPositions get a if s null return false scrollTo s return true return false 
private void saveScrollPos int x, int y if saveScrollPos Log d TAG, "Not saving scroll position disabled " return if backItems size 0 Article a backItems get backItems size 1 article MapArticle, ScrollXY positions getScrollPositions ScrollXY s positions get a if s null s new ScrollXY x, y positions put a, s else s x x s y y Log d TAG, String format "Saving scroll position s for s", s, a title getScrollPositions put a, s 
TargetApi android os Build VERSION_CODES ICE_CREAM_SANDWICH private void saveTextZoomPref SharedPreferences prefs getPreferences MODE_PRIVATE int textZoom articleView getSettings getTextZoom Editor e prefs edit e putInt "articleView textZoom", textZoom boolean success e commit if success Log w TAG, "Failed to save article view text zoom pref" 
private void scrollTo int x, int y saveScrollPos false Log d TAG, "Scroll to " x ", " y articleView realScrollTo x, y saveScrollPos true 
private void setTitle HistoryItem item StringBuilder title new StringBuilder boolean hasNextArticle false if item entries size 1 title append item entryIndex 1 append "" append item entries size append " " hasNextArticle item hasNext if miNextArticle null miNextArticle setVisible hasNextArticle Entry entry item current title append entry title setTitle title, dictionaryService getDisplayTitle entry volumeId 
private void showArticle Entry entry ListEntry result new ArrayListEntry result add entry try IteratorEntry currentIterator dictionaryService followLink entry title, entry volumeId while currentIterator hasNext result size 20 Entry next currentIterator next if next equals entry result add next catch ArticleNotFound e Log d TAG, String format "Article \"s\" not found unexpected", e word showNext new HistoryItem result 
private void showCurrentArticle runOnUiThread new Runnable public void run setProgress 5000 resetTitleToCurrent Article a backItems get backItems size 1 article Log d TAG, "Show article " a text articleView loadDataWithBaseURL BASE_URL, wrap a text , "texthtml", "utf8", null 
private void showError final String message runOnUiThread new Runnable public void run currentTask null setProgress 10000 resetTitleToCurrent AlertDialog Builder dialogBuilder new AlertDialog Builder ArticleViewActivity this dialogBuilder setTitle R string titleError setMessage message setNeutralButton R string btnDismiss, new OnClickListener public void onClick DialogInterface dialog, int which dialog dismiss if backItems isEmpty finish dialogBuilder show 
private void showFindDialog if showFindDialogMethod null try showFindDialogMethod invoke articleView, "", true catch Exception e Log e TAG, "", e 
private void showMessage final String message runOnUiThread new Runnable public void run currentTask null setProgress 10000 resetTitleToCurrent Toast makeText ArticleViewActivity this, message, Toast LENGTH_LONG show if backItems isEmpty finish 
private void showNext HistoryItem item_ final HistoryItem item new HistoryItem item_ final Entry entry item next runOnUiThread new Runnable public void run setTitle item setProgress 1000 currentTask new TimerTask public void run try Article a dictionaryService getArticle entry try a dictionaryService redirect a item article new Article a catch ArticleNotFound e showMessage getString R string msgRedirectNotFound, e word toString return catch RedirectTooManyLevels e showMessage getString R string msgTooManyRedirects, a getRedirect return catch Exception e Log e TAG, "Redirect failed", e showError getString R string msgErrorLoadingArticle, a title return HistoryItem oldCurrent null if backItems isEmpty oldCurrent backItems get backItems size 1 backItems add item if oldCurrent null HistoryItem newCurrent item if newCurrent article equalsIgnoreSection oldCurrent article final String section oldCurrent article sectionEquals newCurrent article ? null newCurrent article section runOnUiThread new Runnable public void run resetTitleToCurrent if section null goToSection section setProgress 10000 currentTask null else showCurrentArticle else showCurrentArticle catch Exception e String msg getString R string msgErrorLoadingArticle, entry title Log e TAG, msg, e showError msg try timer schedule currentTask, 0 catch Exception e Log d TAG, "Failed to schedule task", e 
TargetApi android os Build VERSION_CODES ICE_CREAM_SANDWICH private boolean textZoomIn int newZoom articleView getSettings getTextZoom 20 if newZoom 200 articleView getSettings setTextZoom newZoom return true else return false 
TargetApi android os Build VERSION_CODES ICE_CREAM_SANDWICH private boolean textZoomOut int newZoom articleView getSettings getTextZoom 20 if newZoom 40 articleView getSettings setTextZoom newZoom return true else return false 
private void updateNextButtonVisibility if android os Build VERSION SDK_INT 11 return if currentHideNextButtonTask null currentHideNextButtonTask cancel currentHideNextButtonTask null boolean hasNextArticle false if backItems size 0 HistoryItem historyItem backItems get backItems size 1 hasNextArticle historyItem hasNext final Button nextButton Button findViewById R id NextButton if hasNextArticle if nextButton getVisibility View GONE nextButton setVisibility View VISIBLE currentHideNextButtonTask new TimerTask Override public void run runOnUiThread new Runnable public void run if useAnimation nextButton startAnimation fadeOutAnimation else nextButton setVisibility View GONE currentHideNextButtonTask null try timer schedule currentHideNextButtonTask, 1800 catch IllegalStateException e this may happen if orientation changes while users touches screen Log d TAG, "Failed to schedule \"Next\" button hide", e else nextButton setVisibility View GONE 
private void viewOnline if this backItems size 0 Article current this backItems get this backItems size 1 article Volume d dictionaryService getVolume current volumeId String url d null ? null d getArticleURL current title if url null Intent browserIntent new Intent Intent ACTION_VIEW, Uri parse url startActivity browserIntent 
private String wrap String articleText StringBuilder sb new StringBuilder "html" append "head" if android os Build VERSION SDK_INT android os Build VERSION_CODES ICE_CREAM_SANDWICH sb append "meta name'viewport' content'widthdevicewidth, initialscale1 0, userscalable0'" return sb append this sharedCSS append this mediawikiSharedCSS append this mediawikiMonobookCSS append this js append "head" append "body" append "div id\"globalWrapper\"" append articleText append "div" append "body" append "html" toString 
private String wrapCSS String css return String format "style type\"textcss\"sstyle", css 
private String wrapJS String js return String format "script type\"textjavascript\"sscript", js 
private boolean zoomIn if android os Build VERSION SDK_INT android os Build VERSION_CODES ICE_CREAM_SANDWICH return textZoomIn else return articleView zoomIn 
private boolean zoomOut if android os Build VERSION SDK_INT android os Build VERSION_CODES ICE_CREAM_SANDWICH return textZoomOut else return articleView zoomOut 
protected void onCreate android os Bundle savedInstanceState super onCreate savedInstanceState if android os Build VERSION SDK_INT 11 getWindow requestFeature Window FEATURE_LEFT_ICON registerProgressReceiver initUI if android os Build VERSION SDK_INT 11 getWindow setFeatureDrawableResource Window FEATURE_LEFT_ICON, R drawable aarddict Intent dictServiceIntent new Intent this, DictionaryService class startService dictServiceIntent bindService dictServiceIntent, connection, 0 
protected void onDestroy super onDestroy unregisterReceiver broadcastReceiver unbindService connection 
void onDictionaryServiceConnected if dictionaryService getDictionaries isEmpty new Thread new Runnable public void run dictionaryService openDictionaries Log d TAG, String format "After openDictionaries we have d dictionaries", dictionaryService getDictionaries size if dictionaryService getDictionaries isEmpty runOnUiThread new Runnable public void run Intent next new Intent next setAction ACTION_NO_DICTIONARIES next setClass getApplicationContext , DictionariesActivity class Log d TAG, "No dictionaries, starting Dictionaries activity" startActivity next finish else runOnUiThread new Runnable public void run onDictionaryServiceReady start else onDictionaryServiceReady 
private void registerProgressReceiver IntentFilter intentFilter new IntentFilter intentFilter addAction DictionaryService DICT_OPEN_FAILED intentFilter addAction DictionaryService DISCOVERY_STARTED intentFilter addAction DictionaryService DISCOVERY_FINISHED intentFilter addAction DictionaryService OPEN_FINISHED intentFilter addAction DictionaryService OPEN_STARTED intentFilter addAction DictionaryService OPENED_DICT broadcastReceiver new BroadcastReceiver ProgressDialog discoveryProgress ProgressDialog openProgress Override public void onReceive Context context, Intent intent String a intent getAction if a equals DictionaryService DISCOVERY_STARTED Log d TAG, "dictionary disconvery started" if discoveryProgress null discoveryProgress new DiscoveryProgressDialog context discoveryProgress show else if a equals DictionaryService DISCOVERY_FINISHED Log d TAG, "dictionary discovery finished" if discoveryProgress null discoveryProgress dismiss discoveryProgress null else if a equals DictionaryService OPEN_STARTED Log d TAG, "dictionary open started" int count intent getIntExtra "count", 0 if openProgress null openProgress new OpeningProgressDialog context openProgress setMax count openProgress show else if a equals DictionaryService DICT_OPEN_FAILED a equals DictionaryService OPENED_DICT if openProgress null openProgress incrementProgressBy 1 if a equals DictionaryService DICT_OPEN_FAILED intent getBooleanExtra "displayErrorMessage", true String file intent getStringExtra "file" String reason intent getStringExtra "reason" String msg getResources getString R string toastDictFileFailed, file null ? "" file if reason null reason equals "" msg " " reason Toast makeText BaseDictionaryActivity this, msg, Toast LENGTH_LONG show else if a equals DictionaryService OPEN_FINISHED if openProgress null openProgress dismiss openProgress null onDictionaryOpenFinished registerReceiver broadcastReceiver, intentFilter 
private static String getBuildField String fieldName try return String Build class getField fieldName get null catch Exception e Log d "aarddict", "Exception while trying to check Build " fieldName return "" 
Override void initUI setContentView R layout dictionaries listView ListView findViewById R id dictionariesList Button scanSDButton Button findViewById R id scanSDButton scanSDButton setOnClickListener new View OnClickListener public void onClick View v scandSDCard TextView messageView TextView findViewById R id dictionariesMessageView messageView setMovementMethod LinkMovementMethod getInstance messageView setText Html fromHtml getString R string noDictionaries String appName getString R string appName setTitle getString R string titleDictionariesActivity, appName try loadVerifyData catch Exception e Log e TAG, "Failed to load verify data", e 
SuppressWarnings "unchecked" void loadVerifyData throws IOException, ClassNotFoundException File verifyDir getDir "verify", 0 File verifyFile new File verifyDir, "verifydata" if verifyFile exists FileInputStream fin new FileInputStream verifyFile ObjectInputStream oin new ObjectInputStream fin verifyData MapUUID, VerifyRecord oin readObject 
Override public boolean onCreateOptionsMenu Menu menu menu add 0, MENU_INFO, 0, R string mnDictDetails setIcon android R drawable ic_menu_info_details menu add 0, MENU_VERIFY, 1, R string mnDictVerify setIcon android R drawable ic_menu_manage menu add 0, MENU_REFRESH, 2, R string mnDictRefresh setIcon R drawable ic_menu_refresh return true 
Override protected void onDestroy super onDestroy if dataAdapter null dataAdapter destroy 
Override void onDictionaryServiceConnected Intent intent getIntent String action intent getAction if action null action equals Intent ACTION_VIEW final Uri data intent getData Log d TAG, "Path " data getPath if data null data getPath null Runnable r new Runnable public void run final String path data getPath Log d TAG, "opening " path final MapFile, Exception errors dictionaryService open new File path runOnUiThread new Runnable public void run if errors size 0 Toast makeText getApplicationContext , getString R string toastDictFileLoaded, path , Toast LENGTH_LONG show else Toast makeText getApplicationContext , getString R string toastDictFileFailed, path , Toast LENGTH_LONG show finish new Thread r start Log d TAG, "started " data getPath if action null action equals ACTION_NO_DICTIONARIES showNoDictionariesView else super onDictionaryServiceConnected 
Override void onDictionaryServiceReady if aboutToFinish return Log d TAG, "service ready" if dictionaryService getDictionaries isEmpty showNoDictionariesView else Intent intent getIntent String action intent getAction Log d TAG, "Action " action if action null action equals ACTION_NO_DICTIONARIES aboutToFinish true Intent next new Intent next setClass this, LookupActivity class Log d TAG, "Starting Lookup Activity" startActivity next finish else TextView messageView TextView findViewById R id dictionariesMessageView Button scanSDButton Button findViewById R id scanSDButton messageView setVisibility View GONE scanSDButton setVisibility View GONE listView setVisibility View VISIBLE dataAdapter new DictListAdapter dictionaryService getVolumes listView setAdapter dataAdapter listView setOnItemClickListener dataAdapter listView setOnItemLongClickListener dataAdapter 
Override public boolean onOptionsItemSelected MenuItem item int selected listView getSelectedItemPosition boolean validSelection selected ListView INVALID_POSITION switch item getItemId case MENU_INFO if validSelection dataAdapter showDetail selected break case MENU_VERIFY if validSelection dataAdapter verify selected break case MENU_REFRESH scandSDCard break return true 
Override public boolean onPrepareOptionsMenu Menu menu int selected listView getSelectedItemPosition boolean validSelection selected ListView INVALID_POSITION menu getItem 0 setEnabled validSelection menu getItem 1 setEnabled validSelection menu getItem 2 setEnabled true return true 
void saveVerifyData throws IOException File verifyDir getDir "verify", 0 File verifyFile new File verifyDir, "verifydata" FileOutputStream fout new FileOutputStream verifyFile ObjectOutputStream oout new ObjectOutputStream fout oout writeObject verifyData 
private void scandSDCard new Thread new Runnable public void run dictionaryService refresh runOnUiThread new Runnable public void run onDictionaryServiceReady start 
private void showNoDictionariesView TextView messageView TextView findViewById R id dictionariesMessageView Button scanSDButton Button findViewById R id scanSDButton messageView setVisibility View VISIBLE scanSDButton setVisibility View VISIBLE listView setVisibility View GONE 
private TwoLineListItem createView ViewGroup parent TwoLineListItem item TwoLineListItem inflater inflate android R layout simple_list_item_2, parent, false return item 
public void destroy timer cancel 
SuppressWarnings "unchecked", "rawtypes" public DictListAdapter MapUUID, ListVolume volumes this volumes new ArrayList this volumes addAll volumes values inflater LayoutInflater getSystemService Context LAYOUT_INFLATER_SERVICE timer scheduleAtFixedRate new TimerTask public void run updateView , TIME_UPDATE_PERIOD, TIME_UPDATE_PERIOD 
public int getCount return volumes size 
public Object getItem int position return position 
public long getItemId int position return position 
CharSequence getTitle Volume d, boolean withVol StringBuilder s new StringBuilder d getDisplayTitle withVol if d metadata version null s append " " append d metadata version return s 
public View getView int position, View convertView, ViewGroup parent ListVolume allDictVols volumes get position int volCount allDictVols size Volume d allDictVols get 0 TwoLineListItem view convertView null ? TwoLineListItem convertView createView parent view getText1 setText getTitle d, false Resources r getResources String articleStr r getQuantityString R plurals articles, d metadata article_count, d metadata article_count String totalVolumesStr r getQuantityString R plurals volumes, d header of, d header of String volumesStr r getQuantityString R plurals volumes, volCount, volCount String shortInfo r getString R string shortDictInfo, articleStr, totalVolumesStr, volumesStr if verifyData containsKey d getDictionaryId VerifyRecord record verifyData get d getDictionaryId CharSequence dateStr DateUtils getRelativeTimeSpanString record date getTime String resultStr getString record ok ? R string verifyOk R string verifyCorrupted view getText2 setText getString R string msgDataIntegrityVerified, shortInfo, dateStr, resultStr else view getText2 setText getString R string msgDataIntegrityNotVerified, shortInfo return view 
public void onItemClick AdapterView? parent, View view, int position, long id showDetail position 
public boolean onItemLongClick AdapterView? parent, View view, int position, long id verify position return true 
private void recordVerifyData UUID uuid, boolean ok VerifyRecord record new VerifyRecord record uuid uuid record ok ok record date new Date verifyData put record uuid, record try saveVerifyData catch Exception e Log e TAG, "Failed to save verify data", e updateView 
private void showDetail int position Intent i new Intent DictionariesActivity this, DictionaryInfoActivity class i putExtra "volumeId", volumes get position get 0 getId startActivity i 
private void showError final CharSequence message runOnUiThread new Runnable public void run AlertDialog Builder dialogBuilder new AlertDialog Builder DictionariesActivity this dialogBuilder setTitle R string titleError setMessage message setNeutralButton R string btnDismiss, new OnClickListener public void onClick DialogInterface dialog, int which dialog dismiss dialogBuilder show 
private void updateView runOnUiThread new Runnable public void run notifyDataSetChanged 
private void verify int position final ListVolume allDictVols volumes get position final ProgressDialog progressDialog new ProgressDialog DictionariesActivity this progressDialog setIndeterminate false progressDialog setProgressStyle ProgressDialog STYLE_HORIZONTAL progressDialog setTitle R string titleVerifying progressDialog setMessage getTitle allDictVols get 0 , false progressDialog setCancelable true final ProgressListener progressListener new ProgressListener progressDialog, allDictVols size Runnable verify new Runnable public void run for Volume d allDictVols try d verify progressListener catch Exception e Log e TAG, "There was an error verifying volume " d getId , e progressListener proceed false progressDialog dismiss showError getString R string msgErrorVerifying, d getDisplayTitle , e getLocalizedMessage progressDialog setButton DialogInterface BUTTON_NEGATIVE, getString R string btnCancel , new OnClickListener public void onClick DialogInterface dialog, int which progressListener proceed false progressDialog setOnCancelListener new OnCancelListener public void onCancel DialogInterface dialog progressListener proceed false Thread t new Thread verify t setPriority Thread MIN_PRIORITY t start progressDialog show 
public View createTabContent String tag Intent intent getIntent String volumeId intent getStringExtra "volumeId" Volume d dictionaryService getVolume volumeId setTitle new StringBuilder d getDisplayTitle false append " " append d metadata version Metadata m d metadata TextView textView new TextView this textView setAutoLinkMask Linkify WEB_URLS Linkify EMAIL_ADDRESSES CharSequence text "" if tag equals "d" text m description else if tag equals "c" text m copyright else if tag equals "s" text m source else if tag equals "l" text m license textView setHorizontallyScrolling true textView setText text return textView 
Override void initUI setContentView R layout dict_info tabs TabHost findViewById android R id tabhost tabs setup setTitle R string titleDictionaryInfoActivity 
Override void onDictionaryServiceReady tabs addTab tabs newTabSpec "d" setIndicator getString R string tabDescription setContent this tabs addTab tabs newTabSpec "c" setIndicator getString R string tabCopyright setContent this tabs addTab tabs newTabSpec "s" setIndicator getString R string tabSource setContent this tabs addTab tabs newTabSpec "l" setIndicator getString R string tabLicense setContent this 
public ListFile discover sendBroadcast new Intent DISCOVERY_STARTED Thread yield File scanRoot new File "" ListFile result new ArrayListFile result addAll scanDir scanRoot Intent intent new Intent DISCOVERY_FINISHED intent putExtra "count", result size sendBroadcast intent Thread yield return result 
public IteratorEntry followLink CharSequence word, String fromVolumeId throws ArticleNotFound return library followLink word toString , fromVolumeId 
public Article getArticle Entry entry throws IOException return library getArticle entry 
private DeleteObserver getDeleteObserver File file File parent file getParentFile String dir parent getAbsolutePath DeleteObserver observer deleteObservers get dir if observer null observer new DeleteObserver dir observer startWatching deleteObservers put dir, observer return observer 
public Library getDictionaries return library 
public CharSequence getDisplayTitle String volumeId return library getVolume volumeId getDisplayTitle 
public Volume getVolume String volumeId return library getVolume volumeId 
SuppressWarnings "unchecked", "rawtypes" public MapUUID, ListVolume getVolumes MapUUID, ListVolume result new LinkedHashMap for Volume d library UUID dictionaryId d getDictionaryId if result containsKey dictionaryId result put dictionaryId, new ArrayListVolume result get dictionaryId add d return result 
static boolean isSymlink File file throws IOException File fileInCanonicalDir null if file getParent null fileInCanonicalDir file else File canonicalDir file getParentFile getCanonicalFile fileInCanonicalDir new File canonicalDir, file getName if fileInCanonicalDir getCanonicalFile equals fileInCanonicalDir getAbsoluteFile return false else return true 
SuppressWarnings "unchecked" void loadDictFileList try File dir getDir DICTDIR, 0 File file new File dir, DICTFILE if file exists FileInputStream fin new FileInputStream file ObjectInputStream oin new ObjectInputStream fin ListString data ListString oin readObject dictionaryFileNames addAll data catch Exception e Log e TAG, "Failed to load dictionary file list", e 
public IteratorEntry lookup CharSequence word return library bestMatch word toString 
Override public IBinder onBind Intent intent return binder 
Override public void onCreate Log d TAG, "On create" library new Library loadDictFileList broadcastReceiver new BroadcastReceiver Override public void onReceive Context context, Intent intent String action intent getAction Uri path intent getData Log d TAG, String format "action s, path s", action, path stopSelf IntentFilter intentFilter new IntentFilter intentFilter addDataScheme "file" intentFilter addAction Intent ACTION_MEDIA_EJECT intentFilter addAction Intent ACTION_MEDIA_BAD_REMOVAL intentFilter addAction Intent ACTION_MEDIA_REMOVED registerReceiver broadcastReceiver, intentFilter 
Override public void onDestroy super onDestroy unregisterReceiver broadcastReceiver for Volume d library try d close catch IOException e Log e TAG, "Failed to close " d, e library clear for DeleteObserver observer deleteObservers values observer stopWatching Log i TAG, "destroyed" 
Override public void onStart Intent intent, int startId String action intent null ? null intent getAction if action null action equals Intent ACTION_VIEW final Uri data intent getData Log d TAG, "Path " data getPath if data null data getPath null Runnable r new Runnable public void run Log d TAG, "opening " data getPath open new File data getPath new Thread r start 
synchronized private MapFile, Exception open ListFile files MapFile, Exception errors new HashMapFile, Exception if files size 0 return errors Intent notifyOpenStarted new Intent OPEN_STARTED notifyOpenStarted putExtra "count", files size sendBroadcast notifyOpenStarted Thread yield File cacheDir getCacheDir File metaCacheDir new File cacheDir, "metadata" if metaCacheDir exists if metaCacheDir mkdir Log w TAG, "Failed to create metadata cache directory" MapUUID, Metadata knownMeta new HashMapUUID, Metadata for int i 0 i files size i File file files get i Volume d null try Log d TAG, "Opening " file getName d new Volume file, metaCacheDir, knownMeta Volume existing library getVolume d getId if existing null Log d TAG, "Dictionary " d getId " is not in current collection" library add d DeleteObserver observer getDeleteObserver file observer add file getName else Log d TAG, "Dictionary " d getId " is already open" Intent notifyOpened new Intent OPENED_DICT notifyOpened putExtra "title", d getDisplayTitle notifyOpened putExtra "count", files size notifyOpened putExtra "i", i sendBroadcast notifyOpened Thread yield catch Exception e Log e TAG, "Failed to open " file, e boolean displayErrorMessage e instanceof java io FileNotFoundException Intent notifyFailed new Intent DICT_OPEN_FAILED notifyFailed putExtra "file", file getAbsolutePath notifyFailed putExtra "count", files size notifyFailed putExtra "reason", e getMessage notifyFailed putExtra "displayErrorMessage", displayErrorMessage notifyFailed putExtra "i", i sendBroadcast notifyFailed Thread yield errors put file, e sendBroadcast new Intent OPEN_FINISHED Thread yield return errors 
synchronized public void openDictionaries Log d TAG, "opening dictionaries" long t0 System currentTimeMillis ListFile candidates new ArrayListFile for String path dictionaryFileNames candidates add new File path MapFile, Exception errors open candidates boolean saveFileNames false for File file errors keySet String fileName file getAbsolutePath Log d TAG, "Removing file name from dictionary file names " fileName saveFileNames dictionaryFileNames remove fileName if saveFileNames saveDictFileList Log d TAG, "dictionaries opened in " System currentTimeMillis t0 
public Article redirect Article article throws RedirectTooManyLevels, ArticleNotFound, IOException return library redirect article 
synchronized public void refresh Log d TAG, "starting dictionary discovery" long t0 System currentTimeMillis ListFile candidates discover MapFile, Exception errors open candidates for File file candidates String absolutePath file getAbsolutePath if errors containsKey file dictionaryFileNames add absolutePath else Log w TAG, "Failed to open file " absolutePath, errors get file saveDictFileList Log d TAG, "dictionary discovery took " System currentTimeMillis t0 
void saveDictFileList try File dir getDir DICTDIR, 0 File file new File dir, DICTFILE FileOutputStream fout new FileOutputStream file ObjectOutputStream oout new ObjectOutputStream fout oout writeObject new ArrayListString dictionaryFileNames catch Exception e Log e TAG, "Failed to save dictionary file list", e 
private ListFile scanDir File dir String absolutePath dir getAbsolutePath if excludedScanDirs contains absolutePath Log d TAG, String format "s is excluded", absolutePath return Collections emptyList boolean symlink false try symlink isSymlink dir catch IOException e Log e TAG, String format "Failed to check if s is symlink", dir getAbsolutePath if symlink Log d TAG, String format "s is a symlink", absolutePath return Collections emptyList if dir isHidden Log d TAG, String format "s is hidden", absolutePath return Collections emptyList Log d TAG, "Scanning " absolutePath ListFile candidates new ArrayListFile File[] files dir listFiles fileFilter if files null for int i 0 i files length i File file files[i] if file isDirectory candidates addAll scanDir file else if file isHidden file isFile candidates add file return candidates 
public void setPreferred String volumeId library makeFirst volumeId 
public void add String pathToWatch Log d TAG, String format "Watch file s in s", pathToWatch, dir dictFilesToWatch add pathToWatch 
DeleteObserver String dir super dir, DELETE dictFilesToWatch new HashSetString this dir dir 
Override public void onEvent int event, String path if event FileObserver DELETE 0 Log d TAG, String format "Received file event s s", event, path if dictFilesToWatch contains path Log d TAG, String format "Dictionary file s in s has been deleted, stopping service", path, dir if dictionaryFileNames remove new File dir, path getAbsolutePath saveDictFileList stopSelf 
DictionaryService getService return DictionaryService this 
DiscoveryProgressDialog Context context super context setCancelable false setIndeterminate true setProgressStyle ProgressDialog STYLE_SPINNER setMessage context getString R string msgLooking 
public EinkArticleView Context context, AttributeSet attrs, int defStyle super context, attrs, defStyle 
Override protected void onDraw Canvas canvas if partial EinkScreen PrepareController this, false partial refresh else EinkScreen ResetController 1, this super onDraw canvas partial false 
public void onSizeChanged int w, int h, int ow, int oh super onSizeChanged w, h, ow, oh articleView ArticleView findViewById R id EinkArticleView HSCROLL_SIZE articleView getHeight 20 
public boolean pageDown boolean bottom int cury articleView getScrollY int hmax 0 if HSCROLL_SIZE articleView getContentHeight hmax int articleView getContentHeight articleView getScale HSCROLL_SIZE if cury hmax return false int newy cury HSCROLL_SIZE if newy hmax newy hmax if cury newy articleView realScrollTo 0, newy partial true return true 
public boolean pageUp boolean top int cury articleView getScrollY if cury 0 return false int newy cury HSCROLL_SIZE if newy 0 newy 0 articleView realScrollTo 0, newy partial true return true 
public static void PrepareController View view, boolean isPartially if isPartially IsSleep isPartially SleepController isPartially, view if isPartially return if RefreshNumber 1 switch UpdateMode case cmodeClear SetMode view, cmodeClear break case cmodeActive if UpdateModeInterval 0 SetMode view, cmodeActive break RefreshNumber 0 return if UpdateMode cmodeClear SetMode view, cmodeClear return if UpdateMode 0 UpdateModeInterval 0 UpdateMode 1 if RefreshNumber 0 UpdateMode cmodeOneshot RefreshNumber UpdateModeInterval switch UpdateMode case cmodeActive SetMode view, cmodeActive break case cmodeOneshot SetMode view, cmodeOneshot break else if UpdateModeInterval RefreshNumber SetMode view, cmodeClear RefreshNumber 1 if UpdateModeInterval 0 RefreshNumber return if UpdateMode 1 UpdateModeInterval 0 if RefreshNumber 0 быстрый режим, один раз устанавливается N2EpdController setMode N2EpdController REGION_APP_3, N2EpdController WAVE_GL16, N2EpdController MODE_ACTIVE, view why not MODE_ACTIVE_ALL? else if UpdateModeInterval RefreshNumber одно качественное обновление для быстрого режима N2EpdController setMode N2EpdController REGION_APP_3, N2EpdController WAVE_GU, N2EpdController MODE_CLEAR_ALL, view RefreshNumber 1 RefreshNumber 
public static void ResetController View view if UpdateMode cmodeClear return System err println "Soft reset Controller " SetMode view, cmodeClear RefreshNumber 1 
private static void SetMode View view, int mode switch mode case cmodeClear N2EpdController setMode N2EpdController REGION_APP_3, N2EpdController WAVE_GC, N2EpdController MODE_ONESHOT_ALL N2EpdController MODE_CLEAR, view break case cmodeOneshot N2EpdController setMode N2EpdController REGION_APP_3, N2EpdController WAVE_GU, N2EpdController MODE_ONESHOT_ALL N2EpdController MODE_ONESHOT_ALL, view break case cmodeActive N2EpdController setMode N2EpdController REGION_APP_3, N2EpdController WAVE_GL16, N2EpdController MODE_ACTIVE_ALL N2EpdController MODE_ACTIVE_ALL, view break 
public static void SleepController boolean toSleep, View view if toSleep IsSleep return System err println "SleepController " toSleep IsSleep toSleep if IsSleep switch UpdateMode case cmodeClear break case cmodeOneshot break case cmodeActive SetMode view, cmodeClear RefreshNumber 1 else ResetController UpdateMode, view return 
public Entry String volumeId, String title, long articlePointer this volumeId volumeId this title title null ? "" title this articlePointer articlePointer 
Override public boolean equals Object obj if this obj return true if obj null return false if getClass obj getClass return false Entry other Entry obj if articlePointer other articlePointer return false if section null if other section null return false else if section equals other section return false if title null if other title null return false else if title equals other title return false if volumeId null if other volumeId null return false else if volumeId equals other volumeId return false return true 
Override public int hashCode final int prime 31 int result 1 result prime result int articlePointer ^ articlePointer 32 result prime result section null ? 0 section hashCode result prime result title null ? 0 title hashCode result prime result volumeId null ? 0 volumeId hashCode return result 
Override public String toString return title 
public int compare Entry e1, Entry e2 return collator compare e1 title, e2 title 
EntryComparator int strength try collator Collator Collator getInstance ROOT_LOCALE clone catch CloneNotSupportedException e throw new RuntimeException e collator setStrength strength 
Override public int compare Entry e1, Entry e2 String k2 e2 title String k1 k2 length e1 title length ? e1 title substring 0, k2 length e1 title int result collator compare k1, k2 return result 
EntryStartComparator int strength super strength 
static int calcSize String structSpec int size 0 int length structSpec length ignore byte order spec at index 0 for int i 1 i length i char c structSpec charAt i Integer unitSize structSizes get c if unitSize null size unitSize return size 
Header RandomAccessFile file throws IOException int specLen 0 this signature file readUTF8 4 specLen 4 this sha1sum file readUTF8 40 specLen 40 this version file readUnsignedShort specLen 2 this uuid file readUUID specLen 16 this volume file readUnsignedShort specLen 2 this of file readUnsignedShort specLen 2 this metaLength file readUnsignedInt specLen 4 this indexCount file readUnsignedInt specLen 4 this articleOffset file readUnsignedInt specLen 4 this index1ItemFormat file readUTF8 4 specLen 4 this keyLengthFormat file readUTF8 2 specLen 2 this keyLengthSpec this keyLengthFormat charAt 1 this articleLengthFormat file readUTF8 2 specLen 2 this articleLengthSpec this articleLengthFormat charAt 1 this index1ItemSize calcSize this index1ItemFormat this index1Offset specLen this metaLength this index2Offset this index1Offset this indexCountthis index1ItemSize this keyPointerSpec this index1ItemFormat charAt 1 this articlePointerSpec this index1ItemFormat charAt 2 
Entry current return entries get entryIndex 
boolean hasNext return entryIndex entries size 1 
HistoryItem HistoryItem that this entries that entries this entryIndex that entryIndex if that article null this article new Article that article 
Entry next entryIndex return current 
public IteratorEntry bestMatch String word LookupWord lookupWord LookupWord splitWord word best match is used with human input, assume "" is never used as namespace separator lookupWord mergeNameSpace return new MatchIterator EntryComparators ALL, this, lookupWord 
private ListUUID findMatchingDicts String serverUrl Log d TAG, "Looking for dictionary with server url " serverUrl SetUUID seen new HashSetUUID ListUUID result new ArrayListUUID if serverUrl null Log d TAG, "Server url is null" return result for Volume d this String articleURLTemplate d getArticleURLTemplate Log d TAG, "Looking at article url template " articleURLTemplate if articleURLTemplate null serverUrl equals articleURLTemplate Log d TAG, String format "Dictionary with server url s found s", serverUrl, d getDictionaryId if seen contains d getDictionaryId result add d getDictionaryId if result isEmpty Log d TAG, String format "Dictionary with server url s not found", serverUrl return result 
public IteratorEntry followLink final String word, String fromVolumeId throws ArticleNotFound Log d TAG, String format "Follow link \"s\", s", word, fromVolumeId Volume fromDict getVolume fromVolumeId Metadata fromMeta fromDict metadata LookupWord lookupWord LookupWord splitWord word Log d TAG, lookupWord toString String nameSpace lookupWord nameSpace Log d TAG, String format "Name space s", nameSpace MapString, String interwikiMap fromMeta getInterwikiMap String nsServerUrl interwikiMap get nameSpace ListUUID matchingDicts findMatchingDicts nsServerUrl if matchingDicts isEmpty matchingDicts add fromDict getDictionaryId if nsServerUrl null namespace did not resolve into server url, maybe it's not a name space, just article title with "" in it lookupWord mergeNameSpace ComparatorEntry[] comparators EntryComparators ALL_FULL if lookupWord word null if lookupWord word length 1 comparators EntryComparators EXACT else if lookupWord word length 2 comparators EntryComparators EXACT_IGNORE_CASE final ListVolume dicts new ArrayListVolume this for int i 0 i matchingDicts size i UUID target matchingDicts get i ComparatorVolume c new PreferredDictionaryComparator target Collections sort dicts subList i, dicts size , c MatchIterator result new MatchIterator comparators, dicts, lookupWord if result hasNext return result else throw new ArticleNotFound lookupWord 
public Article getArticle Entry e throws IOException Volume d getVolume e volumeId Article a d readArticle e articlePointer a title e title a section e section return a 
public Volume getVolume String volumeId for Volume d this if d sha1sum equals volumeId return d return null 
public void makeFirst String volumeId Volume d getVolume volumeId if d null ComparatorVolume c new PreferredDictionaryComparator d getDictionaryId Collections sort this, c 
public Article redirect Article article throws RedirectTooManyLevels, ArticleNotFound, IOException Article result redirect article, 0 if result article result redirectedFromTitle article title return result 
private void doLookup CharSequence word if dictionaryService null return word trimLeft word toString if word equals "" Log d TAG, "Nothing to look up" updateWordListUI empty return runOnUiThread updateProgress long t0 System currentTimeMillis try IteratorEntry results dictionaryService lookup word Log d TAG, "Looked up " word " in " System currentTimeMillis t0 updateWordListUI results catch Exception e StringBuilder msgBuilder new StringBuilder "There was an error while looking up " append "\"" append word append "\"" if e getMessage null msgBuilder append " " append e getMessage final String msg msgBuilder toString Log e TAG, msg, e 
Override void initUI getWindow requestFeature Window FEATURE_INDETERMINATE_PROGRESS if DeviceInfo EINK_SCREEN setContentView R layout eink_lookup listView ListView findViewById R id einkLookupResult else setContentView R layout lookup listView ListView findViewById R id lookupResult timer new Timer editText EditText findViewById R id wordInput textWatcher new TextWatcher TimerTask currentLookupTask public void onTextChanged CharSequence s, int start, int before, int count public void beforeTextChanged CharSequence s, int start, int count, int after public void afterTextChanged Editable s if currentLookupTask null currentLookupTask cancel final Editable textToLookup s currentLookupTask new TimerTask Override public void run Log d TAG, "running lookup task for " textToLookup " in " Thread currentThread if textToLookup toString equals editText getText toString doLookup textToLookup try timer schedule currentLookupTask, 600 catch IllegalStateException e this may happen if orientation changes while loading Log d TAG, "Failed to schedule lookup task", e editText addTextChangedListener textWatcher editText setOnKeyListener new OnKeyListener public boolean onKey View v, int keyCode, KeyEvent event if event getAction KeyEvent ACTION_DOWN keyCode KeyEvent KEYCODE_ENTER InputMethodManager inputManager InputMethodManager getSystemService Context INPUT_METHOD_SERVICE inputManager hideSoftInputFromWindow editText getApplicationWindowToken , 0 return true return false editText setInputType InputType TYPE_CLASS_TEXT Button btnClear Button findViewById R id clearButton btnClear setOnClickListener new View OnClickListener public void onClick View v editText setText "" editText requestFocus InputMethodManager inputMgr InputMethodManager getSystemService Context INPUT_METHOD_SERVICE inputMgr showSoftInput editText, InputMethodManager SHOW_IMPLICIT 
private void launchWord Entry theWord Intent next new Intent next setClass this, ArticleViewActivity class next putExtra "word", theWord title next putExtra "section", theWord section next putExtra "volumeId", theWord volumeId next putExtra "articlePointer", theWord articlePointer startActivity next 
Override public boolean onCreateOptionsMenu Menu menu menu add 0, MENU_DICT_INFO, 0, R string mnInfo setIcon android R drawable ic_menu_info_details menu add 0, MENU_ABOUT, 0, R string mnAbout setIcon R drawable ic_menu_aarddict return true 
Override protected void onDestroy super onDestroy timer cancel 
Override void onDictionaryOpenFinished onDictionaryServiceReady 
Override void onDictionaryServiceReady updateTitle Intent intent getIntent if intent null intent getAction null intent getAction equals Intent ACTION_SEARCH final String word intent getStringExtra "query" editText setText word try timer schedule new TimerTask Override public void run Log d TAG, "running lookup task for " word " in " Thread currentThread doLookup word , 0 catch IllegalStateException e Log e TAG, "Failed to schedule lookup task", e else textWatcher afterTextChanged editText getText 
Override public boolean onOptionsItemSelected MenuItem item switch item getItemId case MENU_DICT_INFO startActivity new Intent this, DictionariesActivity class break case MENU_ABOUT showAbout break return true 
private void showAbout PackageManager manager getPackageManager String versionName "" try PackageInfo info manager getPackageInfo getPackageName , 0 versionName info versionName catch NameNotFoundException e Log e TAG, "Failed to load package info for " getPackageName , e LinearLayout layout new LinearLayout this layout setOrientation LinearLayout HORIZONTAL layout setLayoutParams new LinearLayout LayoutParams LinearLayout LayoutParams FILL_PARENT, LinearLayout LayoutParams FILL_PARENT, 1 layout setPadding 10, 10, 10, 10 ImageView logo new ImageView this logo setImageResource R drawable aarddict logo setPadding 0, 0, 20, 0 logo setLayoutParams new ViewGroup LayoutParams ViewGroup LayoutParams WRAP_CONTENT, ViewGroup LayoutParams FILL_PARENT TextView textView new TextView this textView setGravity Gravity CENTER_HORIZONTAL textView setLineSpacing 2f, 1 textView setLayoutParams new ViewGroup LayoutParams ViewGroup LayoutParams WRAP_CONTENT, ViewGroup LayoutParams FILL_PARENT textView setMovementMethod LinkMovementMethod getInstance textView setText Html fromHtml getString R string about, getString R string appName , versionName LinearLayout textViewLayout new LinearLayout this textViewLayout setOrientation LinearLayout VERTICAL textViewLayout setPadding 0, 0, 0, 10 textViewLayout addView textView layout addView logo layout addView textViewLayout AlertDialog Builder dialogBuilder new AlertDialog Builder this dialogBuilder setTitle R string titleAbout setView layout setNeutralButton R string btnDismiss, new OnClickListener public void onClick DialogInterface dialog, int which dialog dismiss dialogBuilder show 
static String trimLeft String s return s replaceAll "^\\s", "" 
void updateTitle int dictCount dictionaryService getVolumes size Resources r getResources String dictionaries r getQuantityString R plurals dictionaries, dictCount String appName r getString R string appName String mainTitle r getString R string titleLookupActivity, appName, String format dictionaries, dictCount setTitle mainTitle 
private void updateWordListUI final IteratorEntry results runOnUiThread new Runnable public void run TextView messageView TextView findViewById R id messageView if results hasNext Editable text editText getText if text null text toString equals "" messageView setText Html fromHtml getString R string nothingFound messageView setVisibility View VISIBLE else messageView setVisibility View GONE else messageView setVisibility View GONE WordAdapter wordAdapter new WordAdapter results listView setAdapter wordAdapter listView setOnItemClickListener wordAdapter setProgressBarIndeterminateVisibility false 
private void bindView TwoLineListItem view, Entry word view getText1 setText word title view getText2 setText dictionaryService getDisplayTitle word volumeId 
private TwoLineListItem createView ViewGroup parent TwoLineListItem item if DeviceInfo EINK_SCREEN item TwoLineListItem mInflater inflate R layout eink_simple_list_item_2, parent, false else item TwoLineListItem mInflater inflate android R layout simple_list_item_2, parent, false item getText2 setSingleLine item getText2 setEllipsize TextUtils TruncateAt END return item 
public int getCount return itemCount 
public Object getItem int position return position 
public long getItemId int position return position 
public View getView int position, View convertView, ViewGroup parent if displayMore position itemCount 1 loadMore position TwoLineListItem view convertView null ? TwoLineListItem convertView createView parent bindView view, words get position return view 
private void loadBatch int count 0 while results hasNext count 20 count words add results next displayMore results hasNext itemCount words size 
private void loadMore int forPos if loadingMoreForPos forPos return loadingMoreForPos forPos new Thread new Runnable public void run loadBatch runOnUiThread new Runnable public void run notifyDataSetChanged start 
public void onItemClick AdapterView? parent, View view, int position, long id launchWord words get position 
public WordAdapter IteratorEntry results this results results this words new ArrayListEntry loadBatch mInflater LayoutInflater LookupActivity this getSystemService Context LAYOUT_INFLATER_SERVICE 
static boolean isEmpty String s return s null s equals "" 
public LookupWord String nameSpace, String word, String section this nameSpace nameSpace this word word this section section 
void mergeNameSpace if isEmpty nameSpace word nameSpace "" word nameSpace null 
public static LookupWord splitWord String word if word null word equals "" word equals "#" return new LookupWord try return splitWordAsURI word catch URISyntaxException e Log d TAG, "Word is not proper URI " word return splitWordSimple word 
static LookupWord splitWordAsURI String word throws URISyntaxException URI uri try uri new URI word catch URISyntaxException e uri new URI word replace " ", "20" String nameSpace uri getScheme String lookupWord uri getSchemeSpecificPart lookupWord lookupWord replace "_", " " String section uri getFragment return new LookupWord nameSpace, lookupWord, section 
static LookupWord splitWordSimple String word String[] parts word split "#", 2 String section parts length 1 ? null parts[1] String nsWord isEmpty parts[0] isEmpty section ? parts[0] word String[] nsParts nsWord split "", 2 String lookupWord nsParts length 1 ? nsParts[0] nsParts[1] lookupWord lookupWord replace "_", " " String nameSpace nsParts length 1 ? null nsParts[0] return new LookupWord nameSpace, lookupWord, section 
Override public String toString StringBuilder s new StringBuilder if isEmpty nameSpace s append nameSpace s append "" s append word null ? "" word if isEmpty section s append "#" s append section return s toString 
public boolean hasNext return next null 
MatchIterator ComparatorEntry[] comparators, IterableVolume dictionaries, LookupWord word for ComparatorEntry c comparators for Volume vol dictionaries iterators add vol lookup word, c prepareNext 
public Entry next Entry current next prepareNext return current 
private void prepareNext if iterators isEmpty IteratorEntry i iterators get 0 if i hasNext currentVolCount MAX_FROM_VOL next i next if seen contains next seen add next currentVolCount else next null prepareNext else currentVolCount 0 iterators remove 0 prepareNext else next null 
public void remove throw new UnsupportedOperationException 
SuppressWarnings "rawtypes" MapString, String getInterwikiMap if interwikiMap null interwikiMap new HashMapString, String if siteinfo null Log d TAG, "Siteinfo not null" List interwiki List siteinfo get "interwikimap" if interwiki null Log d TAG, "Interwiki map not null" for Object item interwiki Map interwikiItem Map item String prefix String interwikiItem get "prefix" String url String interwikiItem get "url" interwikiMap put prefix, url return interwikiMap 
public static void setMode int region, int wave, int mode if mtSetRegion null try if DeviceInfo EINK_NOOK_120 mEpdController null mEpdController EpdControllerConstructors[0] newInstance new Object[] n2MainActivity Object regionParams RegionParamsConstructor newInstance new Object[] 0, 0, 600, 800, enumsWave[wave] mtSetRegion invoke mEpdController, "aarddict", enumsRegion[region], regionParams, enumsMode[mode] catch Exception e System err println "Failed SetMode" System err println e toString strN2EpdInit "Failed setMode " e toString e printStackTrace 
OpeningProgressDialog Context context super context setCancelable false setIndeterminate false setProgressStyle ProgressDialog STYLE_HORIZONTAL setProgress 0 setMessage context getString R string msgLoading 
public int compare Volume d1, Volume d2 UUID id1 d1 getDictionaryId UUID id2 d2 getDictionaryId if id1 equals id2 if id1 equals preferred return d1 header volume d2 header volume else if id1 equals preferred return 1 if id2 equals preferred return 1 return 0 
PreferredDictionaryComparator UUID preferred this preferred preferred 
public RandomAccessFile String fileName, String mode throws FileNotFoundException super fileName, mode 
public final long readSpec char spec throws IOException if spec 'L' spec 'I' return readUnsignedInt if spec 'Q' return readUnsignedLong if spec 'H' return readUnsignedShort if spec 'l' spec 'i' return readInt if spec 'q' return readLong if spec 'h' return this readShort throw new IOException "Unsupported spec character " spec 
public final long readUnsignedInt throws IOException int ch1 this read int ch2 this read int ch3 this read int ch4 this read if ch1 ch2 ch3 ch4 0 throw new EOFException return long ch1 24 ch2 16 ch3 8 ch4 0 0xFFFFFFFFL 
public final long readUnsignedLong throws IOException int ch1 this read int ch2 this read int ch3 this read int ch4 this read int ch5 this read int ch6 this read int ch7 this read int ch8 this read if ch1 ch2 ch3 ch4 ch5 ch6 ch7 ch8 0 throw new EOFException return long ch1 56 ch2 48 ch3 40 ch4 32 ch5 24 ch6 16 ch7 8 ch8 0 0xFFFFFFFFFFFFFFFFL 
public final String readUTF8 int length throws IOException byte[] s new byte[length] this read s return Volume utf8 s 
public final UUID readUUID throws IOException byte[] s new byte[16] this read s return Volume uuid s 
public ScrollXY int x, int y this x x this y y 
Override public String toString return String format "ScrollXY d, d ", x, y 
JavascriptInterface public int getNumberOfComparators return EntryComparators ALL length 
JavascriptInterface public boolean match String section, String candidate, int strength ComparatorEntry c EntryComparators ALL[strength] Entry e1 new Entry null, section trim Entry e2 new Entry null, candidate trim boolean result c compare e1, e2 0 Log d TAG, String format "Match section s candidate s strength s match? s", section, candidate, strength, result return result 
public void testSimpleSplitPlainWord LookupWord result LookupWord splitWordSimple "abc" assertEquals "abc", result word assertNull result section assertNull result nameSpace 
public void testSimpleSplitWithNS LookupWord result LookupWord splitWordSimple "wabc" assertEquals "abc", result word assertEquals "w", result nameSpace assertNull result section 
public void testSimpleSplitWithSection LookupWord result LookupWord splitWordSimple "abc#def" assertEquals "abc", result word assertEquals "def", result section assertNull result nameSpace 
public void testSimpleSplitWithSectionAndNS LookupWord result LookupWord splitWordSimple "wabc#def" assertEquals "abc", result word assertEquals "def", result section assertEquals "w", result nameSpace 
public void testSimpleSplitWithUnderscore throws URISyntaxException LookupWord result LookupWord splitWordSimple "w_1a_b#c_d" assertEquals "a b", result word assertEquals "c_d", result section assertEquals "w_1", result nameSpace 
public void testURISplitPlainWord throws URISyntaxException LookupWord result LookupWord splitWordAsURI "abc" assertEquals "abc", result word assertNull result section assertNull result nameSpace 
public void testURISplitWithBadURLEncoding try LookupWord splitWordAsURI "wab c" catch URISyntaxException e return fail 
public void testURISplitWithNS throws URISyntaxException LookupWord result LookupWord splitWordAsURI "wabc" assertEquals "abc", result word assertEquals "w", result nameSpace assertNull result section 
public void testURISplitWithSection throws URISyntaxException LookupWord result LookupWord splitWordAsURI "abc#def" assertEquals "abc", result word assertEquals "def", result section assertNull result nameSpace 
public void testURISplitWithSectionAndNS throws URISyntaxException LookupWord result LookupWord splitWordAsURI "wabc#def" assertEquals "abc", result word assertEquals "def", result section assertEquals "w", result nameSpace 
public void testURISplitWithUnderscore throws URISyntaxException LookupWord result LookupWord splitWordAsURI "wa_b#c_d" assertEquals "a b", result word assertEquals "c_d", result section assertEquals "w", result nameSpace 
public void testURISplitWithURLEncoding throws URISyntaxException LookupWord result LookupWord splitWordAsURI "wabc201232F456#def20ghi" assertEquals "abc 123456", result word assertEquals "def ghi", result section assertEquals "w", result nameSpace 
private void assertFormat throws FormatException, IOException Log d TAG, "Checking signature " if this header signature equals "aard" throw new InvalidSignatureException Log d TAG, "Checking format version " if this header version 1 throw new InvalidFormatVersionException Log d TAG, "Checking offsets sanity " long fileSize file length if header articleOffset fileSize header index1Offset fileSize header index2Offset fileSize throw new CorruptedFileException Log d TAG, "Checking metadata length sanity " if header metaLength 1 23 throw new MetadataTooBigException Log d TAG, "Sanity check ok" 
static T int binarySearch List? extends T l, T key, Comparator? super T c int lo 0 int hi l size while lo hi int mid lo hi 2 T midVal l get mid int cmp c compare midVal, key if cmp 0 lo mid 1 else hi mid return lo 
public void close throws IOException file close 
static String decompress byte[] bytes String type null long t0 System currentTimeMillis try String result decompressZlib bytes type "zlib" return result catch Exception e1 try String result decompressBz2 bytes type "bz2" return result catch IOException e2 String result utf8 bytes type "uncompressed" return result finally Log d TAG, "Decompressed " type " in " System currentTimeMillis t0 
static String decompressBz2 byte[] bytes throws IOException BZip2CompressorInputStream in new BZip2CompressorInputStream new ByteArrayInputStream bytes int n 0 ByteArrayOutputStream out new ByteArrayOutputStream bytes length5 byte[] buf new byte[1024] try while 1 n in read buf out write buf, 0, n finally in close out close return utf8 out toByteArray 
static String decompressZlib byte[] bytes throws IOException, DataFormatException Inflater decompressor new Inflater decompressor setInput bytes ByteArrayOutputStream out new ByteArrayOutputStream try byte[] buf new byte[1024] while decompressor finished int count decompressor inflate buf out write buf, 0, count finally out close return utf8 out toByteArray 
Override public boolean equals Object obj if this obj return true if super equals obj return false if getClass obj getClass return false Volume other Volume obj if sha1sum null if other sha1sum null return false else if sha1sum equals other sha1sum return false return true 
Override public Entry get int index Entry entry entryCache get index if entry null return entry try IndexItem indexItem readIndexItem index String title readKey indexItem keyPointer entry new Entry this getId , title, indexItem articlePointer entryCache put index, entry return entry catch IOException e throw new RuntimeException e 
public String getArticleURL String title String template getArticleURLTemplate if template null return template replace "$1", Uri encode title return null 
public String getArticleURLTemplate return articleURLTemplate 
public UUID getDictionaryId return header uuid 
public CharSequence getDisplayTitle boolean withVolumeNumber String title if this metadata title null title this origFile getName else title this metadata title StringBuilder s new StringBuilder title if this metadata lang null s append String format " s ", this metadata lang else if this metadata sitelang null s append String format " s ", this metadata sitelang else if this metadata index_language null this metadata article_language null s append String format " ss ", this metadata index_language, this metadata article_language if this header of 1 withVolumeNumber s append String format " Vol s", this header volume return s toString 
public String getId return sha1sum 
SuppressWarnings "unchecked" private String[] getServerAndArticlePath String[] result new String[] null, null if metadata siteinfo null Map String, Object general Map String, Object this metadata siteinfo get "general" if general null Object server general get "server" Object articlePath general get "articlepath" if server null result[0] server toString if articlePath null result[1] articlePath toString return result 
Override public int hashCode return sha1sum hashCode 
private void init RandomAccessFile file, File cacheDir, MapUUID, Metadata knownMeta throws IOException, FormatException this file file this header new Header file this assertFormat this sha1sum header sha1sum if knownMeta containsKey header uuid this metadata knownMeta get header uuid else String uuidStr header uuid toString File metadataCacheFile new File cacheDir, uuidStr if metadataCacheFile exists try long t0 System currentTimeMillis this metadata mapper readValue metadataCacheFile, Metadata class knownMeta put header uuid, this metadata Log d TAG, format "Loaded meta for s from cache in s", metadataCacheFile getName , System currentTimeMillis t0 catch Exception e Log e TAG, format "Failed to restore meta from cache file s ", metadataCacheFile getName , e if this metadata null long t0 System currentTimeMillis byte[] rawMeta new byte[ int header metaLength] file read rawMeta String metadataStr decompress rawMeta this metadata mapper readValue metadataStr, Metadata class Log d TAG, format "Read meta for in s", header uuid, System currentTimeMillis t0 knownMeta put header uuid, this metadata try mapper writeValue metadataCacheFile, this metadata Log d TAG, format "Wrote metadata to cache file s", metadataCacheFile getName catch IOException e Log e TAG, format "Failed to write metadata to cache file s", metadataCacheFile getName , e initArticleURLTemplate 
private void initArticleURLTemplate String[] serverAndArticlePath getServerAndArticlePath String server serverAndArticlePath[0] String articlePath serverAndArticlePath[1] if server null articlePath null if server startsWith "" broken server url in metadata, missing schema, assume http server "http"server articleURLTemplate server articlePath else Log d TAG, "Not enough metadata to generate article url template" 
IteratorEntry lookup final LookupWord lookupWord, final ComparatorEntry comparator if lookupWord isEmpty return EMPTY_ITERATOR final String section lookupWord section final Entry lookupEntry new Entry this getId , lookupWord word final int initialIndex binarySearch this, lookupEntry, comparator IteratorEntry iterator new IteratorEntry int index initialIndex Entry nextEntry prepareNext private void prepareNext if index header indexCount Entry matchedEntry get index nextEntry 0 comparator compare matchedEntry, lookupEntry ? matchedEntry null index else nextEntry null public boolean hasNext return nextEntry null public Entry next Entry current nextEntry current section section prepareNext return current public void remove throw new UnsupportedOperationException return iterator 
Article readArticle long pointer throws IOException Article a articleCache get pointer if a null return a Header h this header long pos h articleOffset pointer RandomAccessFile f this file f seek pos long articleLength f readSpec h articleLengthSpec byte[] articleBytes new byte[ int articleLength] f read articleBytes String serializedArticle decompress articleBytes a Article fromJsonStr serializedArticle a dictionaryUUID h uuid a volumeId h sha1sum a pointer pointer articleCache put pointer, a return a 
IndexItem readIndexItem long i throws IOException Header h this header long pos h index1Offset i h index1ItemSize RandomAccessFile f this file f seek pos IndexItem indexItem new IndexItem indexItem keyPointer f readSpec h keyPointerSpec indexItem articlePointer f readSpec h articlePointerSpec return indexItem 
String readKey long pointer throws IOException Header h this header long pos h index2Offset pointer RandomAccessFile f this file f seek pos int keyLength int f readSpec h keyLengthSpec return f readUTF8 keyLength 
Override public int size return int header indexCount 
public static String toHex byte[] data char[] chars new char[data length 2] for int i 0 i data length i chars[i 2] HEX_DIGITS[ data[i] 4 0xf] chars[i 2 1] HEX_DIGITS[data[i] 0xf] return new String chars 
public String toString return String format "s ss s ", this metadata title, this header volume, this header of, this sha1sum 
static String utf8 byte[] signature try return new String signature, "UTF8" catch UnsupportedEncodingException e e printStackTrace return "" 
public void verify VerifyProgressListener listener throws IOException, NoSuchAlgorithmException FileInputStream fis new FileInputStream origFile fis skip 44 byte[] buff new byte[1 16] MessageDigest m MessageDigest getInstance "SHA1" int readCount long totalReadCount 0 double totalBytes origFile length 44 boolean proceed true while readCountfis read buff 1 m update buff, 0, readCount totalReadCount readCount proceed listener updateProgress this, totalReadCounttotalBytes fis close if proceed String calculated Volume toHex m digest Log d TAG, "calculated " calculated " actual " sha1sum listener verified this, calculated equals this sha1sum 
public Volume File file, File cacheDir, MapUUID, Metadata knownMeta throws IOException, FormatException this origFile file init new RandomAccessFile file, "r" , cacheDir, knownMeta 
public CorruptedFileException super "Corrupted file" 
public FormatException String detailMessage super detailMessage 
public InvalidFormatVersionException super "Invalid file format version" 
public InvalidSignatureException super "Not a dictionary file" 
public MetadataTooBigException super "Metadata is too big" 
private void initialize String code "1 0" try PackageInfo p getPackageManager getPackageInfo getPackageName , 0 code p versionName catch NameNotFoundException e e printStackTrace TextView versionCode TextView findViewById R id versionCode versionCode setText code RelativeLayout licenses RelativeLayout findViewById R id layoutLicense RelativeLayout source RelativeLayout findViewById R id layoutSource RelativeLayout version RelativeLayout findViewById R id layoutVersion licenses setOnClickListener this source setOnClickListener this version setOnClickListener this 
Override public void onClick View view switch view getId case R id layoutLicense NOTE In order to comply legally with open source licenses, it is advised that you leave this code so that the License Activity may be viewed by the user startActivity new Intent this, LicenseActivity class break case R id layoutSource startActivity new Intent Intent ACTION_VIEW, Uri parse "httptwitter comRestainoAnthony" , this, MainActivity class finish break case R id layoutVersion mEasterEggCounter if mEasterEggCounter 10 startActivity new Intent Intent ACTION_VIEW, Uri parse "httpimgs xkcd comcomicscompiling png" , this, MainActivity class finish mEasterEggCounter 0 break 
Override protected void onCreate Bundle savedInstanceState super onCreate savedInstanceState setContentView R layout about_settings Toolbar toolbar Toolbar findViewById R id toolbar setSupportActionBar toolbar getSupportActionBar setDisplayHomeAsUpEnabled true initialize 
Override public boolean onOptionsItemSelected MenuItem item finish return true 
private AdBlock Context context if mBlockedDomainsList isEmpty Constants FULL_VERSION loadBlockedDomainsList context mBlockAds PreferenceManager getInstance getAdBlockEnabled 
private static String getDomainName String url throws URISyntaxException int index url indexOf '', 8 if index 1 url url substring 0, index URI uri new URI url String domain uri getHost if domain null return url return domain startsWith "www " ? domain substring 4 domain 
public static AdBlock getInstance Context context if mInstance null mInstance new AdBlock context return mInstance 
public boolean isAd String url if mBlockAds url null return false String domain try domain getDomainName url catch URISyntaxException e Log d TAG, "URL '" url "' is invalid", e return false boolean isOnBlacklist mBlockedDomainsList contains domain toLowerCase mLocale if isOnBlacklist Log d TAG, "URL '" url "' is an ad" return isOnBlacklist 
private void loadBlockedDomainsList final Context context Thread thread new Thread new Runnable Override public void run AssetManager asset context getAssets try BufferedReader reader new BufferedReader new InputStreamReader asset open BLOCKED_DOMAINS_LIST_FILE_NAME String line while line reader readLine null mBlockedDomainsList add line trim toLowerCase mLocale catch IOException e Log wtf TAG, "Reading blocked domains list from file '" BLOCKED_DOMAINS_LIST_FILE_NAME "' failed ", e thread start 
public void updatePreference mBlockAds PreferenceManager getInstance getAdBlockEnabled 
private void initialize mPreferences PreferenceManager getInstance RelativeLayout rAllowPopups, rAllowCookies, rAllowIncognitoCookies, rRestoreTabs LinearLayout lRenderPicker, lUrlContent rAllowPopups RelativeLayout findViewById R id rAllowPopups rAllowCookies RelativeLayout findViewById R id rAllowCookies rAllowIncognitoCookies RelativeLayout findViewById R id rAllowIncognitoCookies rRestoreTabs RelativeLayout findViewById R id rRestoreTabs lRenderPicker LinearLayout findViewById R id layoutRendering lUrlContent LinearLayout findViewById R id rUrlBarContents cbAllowPopups CheckBox findViewById R id cbAllowPopups cbAllowCookies CheckBox findViewById R id cbAllowCookies cbAllowIncognitoCookies CheckBox findViewById R id cbAllowIncognitoCookies cbRestoreTabs CheckBox findViewById R id cbRestoreTabs cbAllowPopups setChecked mPreferences getPopupsEnabled cbAllowCookies setChecked mPreferences getCookiesEnabled cbAllowIncognitoCookies setChecked mPreferences getIncognitoCookiesEnabled cbRestoreTabs setChecked mPreferences getRestoreLostTabsEnabled mRenderText TextView findViewById R id renderText mUrlText TextView findViewById R id urlText switch mPreferences getRenderingMode case 0 mRenderText setText mContext getString R string name_normal break case 1 mRenderText setText mContext getString R string name_inverted break case 2 mRenderText setText mContext getString R string name_grayscale break case 3 mRenderText setText mContext getString R string name_inverted_grayscale break mUrlOptions this getResources getStringArray R array url_content_array int option mPreferences getUrlBoxContentChoice mUrlText setText mUrlOptions[option] LayoutClickListener listener new LayoutClickListener CheckListener cListener new CheckListener rAllowPopups setOnClickListener listener rAllowCookies setOnClickListener listener rAllowIncognitoCookies setOnClickListener listener rRestoreTabs setOnClickListener listener lRenderPicker setOnClickListener listener lUrlContent setOnClickListener listener cbAllowPopups setOnCheckedChangeListener cListener cbAllowCookies setOnCheckedChangeListener cListener cbAllowIncognitoCookies setOnCheckedChangeListener cListener cbRestoreTabs setOnCheckedChangeListener cListener 
Override protected void onCreate Bundle savedInstanceState super onCreate savedInstanceState setContentView R layout advanced_settings Toolbar toolbar Toolbar findViewById R id toolbar setSupportActionBar toolbar getSupportActionBar setDisplayHomeAsUpEnabled true mContext this initialize 
Override public boolean onOptionsItemSelected MenuItem item finish return true 
private void renderPicker AlertDialog Builder picker new AlertDialog Builder mContext picker setTitle getResources getString R string rendering_mode CharSequence[] chars mContext getString R string name_normal , mContext getString R string name_inverted , mContext getString R string name_grayscale , mContext getString R string name_inverted_grayscale int n mPreferences getRenderingMode picker setSingleChoiceItems chars, n, new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which mPreferences setRenderingMode which switch which case 0 mRenderText setText mContext getString R string name_normal break case 1 mRenderText setText mContext getString R string name_inverted break case 2 mRenderText setText mContext getString R string name_grayscale break case 3 mRenderText setText mContext getString R string name_inverted_grayscale break picker setNeutralButton getResources getString R string action_ok , new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which picker show 
private void urlBoxPicker AlertDialog Builder picker new AlertDialog Builder mContext picker setTitle getResources getString R string url_contents int n mPreferences getUrlBoxContentChoice picker setSingleChoiceItems mUrlOptions, n, new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which mPreferences setUrlBoxContentChoice which if which mUrlOptions length mUrlText setText mUrlOptions[which] picker setNeutralButton getResources getString R string action_ok , new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which picker show 
Override public void onCheckedChanged CompoundButton buttonView, boolean isChecked switch buttonView getId case R id cbAllowPopups mPreferences setPopupsEnabled isChecked break case R id cbAllowCookies mPreferences setCookiesEnabled isChecked break case R id cbAllowIncognitoCookies mPreferences setIncognitoCookiesEnabled isChecked break case R id cbRestoreTabs mPreferences setRestoreLostTabsEnabled isChecked break 
Override public void onClick View v switch v getId case R id rAllowPopups cbAllowPopups setChecked cbAllowPopups isChecked break case R id rAllowIncognitoCookies cbAllowIncognitoCookies setChecked cbAllowIncognitoCookies isChecked break case R id rAllowCookies cbAllowCookies setChecked cbAllowCookies isChecked break case R id rRestoreTabs cbRestoreTabs setChecked cbRestoreTabs isChecked break case R id layoutRendering renderPicker break case R id rUrlBarContents urlBoxPicker break 
public AnimatedProgressBar Context context, AttributeSet attrs, int defStyleAttr super context, attrs, defStyleAttr init context, attrs 
private method used to create and run the animation used to change the progress param initialWidth is the width at which the progress starts at param maxWidth is the maximum width total width of the view param deltaWidth is the amount by which the width of the progress view will change private void animateView final int initialWidth, final int maxWidth, final int deltaWidth Animation fill new Animation Override protected void applyTransformation float interpolatedTime, Transformation t int width initialWidth int deltaWidth interpolatedTime if width maxWidth mDrawWidth width invalidate if 1 0f interpolatedTime 0 0005 if mProgress 100 fadeOut Override public boolean willChangeBounds return false fill setDuration 500 fill setInterpolator new DecelerateInterpolator this startAnimation fill 
fades in the progress bar private void fadeIn ObjectAnimator fadeIn ObjectAnimator ofFloat this, "alpha", 1 0f fadeIn setDuration 200 fadeIn setInterpolator new DecelerateInterpolator fadeIn start 
fades out the progress bar private void fadeOut ObjectAnimator fadeOut ObjectAnimator ofFloat this, "alpha", 0 0f fadeOut setDuration 200 fadeOut setInterpolator new DecelerateInterpolator fadeOut start 
Returns the current progress value between 0 and 100 return progress of the view public int getProgress return mProgress 
Initialize the AnimatedProgressBar param context is the context passed by the constructor param attrs is the attribute set passed by the constructor private void init final Context context, AttributeSet attrs TypedArray array context getTheme obtainStyledAttributes attrs, R styleable AnimatedProgressBar, 0, 0 int backgroundColor try Retrieve the style of the progress bar that the user hopefully set int DEFAULT_BACKGROUND_COLOR 0x424242 int DEFAULT_PROGRESS_COLOR 0x2196f3 backgroundColor array getColor R styleable AnimatedProgressBar_backgroundColor, DEFAULT_BACKGROUND_COLOR mProgressColor array getColor R styleable AnimatedProgressBar_progressColor, DEFAULT_PROGRESS_COLOR mBidirectionalAnimate array getBoolean R styleable AnimatedProgressBar_bidirectionalAnimate, false finally array recycle LayoutInflater inflater LayoutInflater context getSystemService Context LAYOUT_INFLATER_SERVICE inflater inflate R layout animated_progress_bar, this, true this setBackgroundColor backgroundColor set the background color for this view 
Override protected void onDraw Canvas canvas mPaint setColor mProgressColor mPaint setStrokeWidth 10 mRect right mRect left mDrawWidth canvas drawRect mRect, mPaint 
Override protected void onRestoreInstanceState Parcelable state if state instanceof Bundle Bundle bundle Bundle state this mProgress bundle getInt "progressState" state bundle getParcelable "instanceState" super onRestoreInstanceState state 
Override protected Parcelable onSaveInstanceState Bundle bundle new Bundle bundle putParcelable "instanceState", super onSaveInstanceState bundle putInt "progressState", mProgress return bundle 
sets the progress as an integer value between 0 and 100 Values above or below that interval will be adjusted to their nearest value within the interval, i e setting a value of 150 will have the effect of setting the progress to 100 You cannot trick us param progress an integer between 0 and 100 public void setProgress int progress if progress 100 progress cannot be greater than 100 progress 100 else if progress 0 progress cannot be less than 0 progress 0 if this getAlpha 1 0f fadeIn int mWidth this getMeasuredWidth Set the drawing bounds for the ProgressBar mRect left 0 mRect top 0 mRect bottom this getBottom this getTop if progress mProgress mBidirectionalAnimate if the we only animate the view in one direction then reset the view width if it is less than the previous progress mDrawWidth 0 else if progress mProgress we don't need to go any farther if the progress is unchanged if progress 100 fadeOut return mProgress progress save the progress final int deltaWidth mWidth mProgress 100 mDrawWidth calculate amount the width has to change animateView mDrawWidth, mWidth, deltaWidth animate the width change 
public ArticleTextExtractor addNegative String neg setNegative negativeStr "" neg return this 
public ArticleTextExtractor addPositive String pos return setPositive positiveStr "" pos 
public void addScore Element el, int score int old getScore el setScore el, score old 
public ArticleTextExtractor addUnlikely String unlikelyMatches return setUnlikely unlikelyStr "" unlikelyMatches 
public ArticleTextExtractor setUnlikely "com bxmentmunity dis quscuss e xtra[]?mail foot" "headermenure markply rsssh areoutbox sponsor" "a dllgegaterchivettachment pag erination popupprint" "loginsi debargnngle " setPositive " ^ bodycontenth?entrymainpageposttextblogstoryhaupt " "arti clekel instapaper_body" setNegative "nav $igation usercom mentbx ^com contact" "footmasthead me diata outbrainpromorelatedscroll sho utboxpping " "sidebarsponsortagstoolwidgetplayerdisclaimertocinfoboxvcard" 
private int calcWeight Element e int weight 0 if POSITIVE matcher e className find weight 35 if POSITIVE matcher e id find weight 40 if UNLIKELY matcher e className find weight 20 if UNLIKELY matcher e id find weight 20 if NEGATIVE matcher e className find weight 50 if NEGATIVE matcher e id find weight 50 String style e attr "style" if style null style isEmpty NEGATIVE_STYLE matcher style find weight 50 return weight 
private int calcWeightForChild Element child, String ownText int c SHelper count ownText, "quot" c SHelper count ownText, "lt" c SHelper count ownText, "gt" c SHelper count ownText, "px" int val if c 5 val 30 else val int Math round ownText length 25 0 addScore child, val return val 
public String cleanTitle String title StringBuilder res new StringBuilder int index title lastIndexOf "" if index 0 title length 2 index title title substring 0, index 1 int counter 0 String[] strs title split "\\" for String part strs if IGNORED_TITLE_PARTS contains part toLowerCase Locale getDefault trim continue if counter strs length 1 res length part length continue if counter 0 res append "" res append part counter return SHelper innerTrim res toString 
public Element determineImageSource Element el, ListImageResult images int maxWeight 0 Element maxNode null Elements els el select "img" if els isEmpty els el parent select "img" double score 1 for Element e els String sourceUrl e attr "src" if sourceUrl isEmpty isAdImage sourceUrl continue int weight 0 int height 0 try height Integer parseInt e attr "height" if height 50 weight 20 else weight 20 catch Exception ex ex printStackTrace int width 0 try width Integer parseInt e attr "width" if width 50 weight 20 else weight 20 catch Exception ex ex printStackTrace String alt e attr "alt" if alt length 35 weight 20 String title e attr "title" if title length 35 weight 20 String rel boolean noFollow false if e parent null rel e parent attr "rel" if rel null rel contains "nofollow" noFollow rel contains "nofollow" weight 40 weight int weight score if weight maxWeight maxWeight weight maxNode e score score 2 ImageResult image new ImageResult sourceUrl, weight, title, height, width, alt, noFollow images add image Collections sort images, new ImageComparator return maxNode 
protected String extractCanonicalUrl Document doc String url SHelper replaceSpaces doc select "head link[relcanonical]" attr "href" if url isEmpty url SHelper replaceSpaces doc select "head meta[propertyogurl]" attr "content" if url isEmpty url SHelper replaceSpaces doc select "head meta[nametwitterurl]" attr "content" return url 
public JResult extractContent JResult res, Document doc, OutputFormatter formatter throws NullPointerException if doc null throw new NullPointerException "missing document" res setTitle extractTitle doc res setDescription extractDescription doc res setCanonicalUrl extractCanonicalUrl doc now remove the clutter prepareDocument doc init elements CollectionElement nodes getNodes doc int maxWeight 0 Element bestMatchElement null for Element entry nodes int currentWeight getWeight entry if currentWeight maxWeight maxWeight currentWeight bestMatchElement entry if maxWeight 200 break if bestMatchElement null ListImageResult images new ArrayList Element imgEl determineImageSource bestMatchElement, images if imgEl null res setImageUrl SHelper replaceSpaces imgEl attr "src" TODO remove parent container of image if it is contained in bestMatchElement to avoid image subtitles flooding in res setImages images clean before grabbing text String text formatter getFormattedText bestMatchElement text removeTitleFromText text, res getTitle this fails for short facebook post and probably tweets text length res getDescription length if text length res getTitle length res setText text print "best element", bestMatchElement res setTextList formatter getTextList bestMatchElement if res getImageUrl isEmpty res setImageUrl extractImageUrl doc res setRssUrl extractRssUrl doc res setVideoUrl extractVideoUrl doc res setFaviconUrl extractFaviconUrl doc res setKeywords extractKeywords doc return res 
protected String extractDescription Document doc String description SHelper innerTrim doc select "head meta[namedescription]" attr "content" if description isEmpty description SHelper innerTrim doc select "head meta[propertyogdescription]" attr "content" if description isEmpty description SHelper innerTrim doc select "head meta[nametwitterdescription]" attr "content" return description 
protected String extractFaviconUrl Document doc String faviconUrl SHelper replaceSpaces doc select "head link[relicon]" attr "href" if faviconUrl isEmpty faviconUrl SHelper replaceSpaces doc select "head link[rel^shortcut],link[rel$icon]" attr "href" return faviconUrl 
Tries to extract an image url from metadata if determineImageSource failed return image url or empty str protected String extractImageUrl Document doc use open graph tag to get image String imageUrl SHelper replaceSpaces doc select "head meta[propertyogimage]" attr "content" if imageUrl isEmpty imageUrl SHelper replaceSpaces doc select "head meta[nametwitterimage]" attr "content" if imageUrl isEmpty prefer link over thumbnailmeta if empty imageUrl SHelper replaceSpaces doc select "link[relimage_src]" attr "href" if imageUrl isEmpty imageUrl SHelper replaceSpaces doc select "head meta[namethumbnail]" attr "content" return imageUrl 
protected CollectionString extractKeywords Document doc String content SHelper innerTrim doc select "head meta[namekeywords]" attr "content" if content null if content startsWith "[" content endsWith "]" content content substring 1, content length 1 String[] split content split "\\s,\\s" if split length 1 split length 0 "" equals split[0] return Arrays asList split return Collections emptyList 
protected String extractRssUrl Document doc return SHelper replaceSpaces doc select "link[relalternate]" select "link[typeapplicationrssxml]" attr "href" 
protected String extractTitle Document doc String title cleanTitle doc title if title isEmpty title SHelper innerTrim doc select "head title" text if title isEmpty title SHelper innerTrim doc select "head meta[nametitle]" attr "content" if title isEmpty title SHelper innerTrim doc select "head meta[propertyogtitle]" attr "content" if title isEmpty title SHelper innerTrim doc select "head meta[nametwittertitle]" attr "content" return title 
protected String extractVideoUrl Document doc return SHelper replaceSpaces doc select "head meta[propertyogvideo]" attr "content" 
return a set of all important nodes public CollectionElement getNodes Document doc SetElement nodes new HashSet 64 int score 100 for Element el doc select "body" select "" if NODES matcher el tagName matches nodes add el setScore el, score score score 2 return nodes 
public int getScore Element el int old 0 try old Integer parseInt el attr "gravityScore" catch Exception ex ex printStackTrace return old 
Weights current element By matching it with positive candidates and weighting child nodes Since it's impossible to predict which exactly names, ids or class names will be used in HTML, major role is played by child nodes param e Element to weight, along with child nodes protected int getWeight Element e int weight calcWeight e weight int Math round e ownText length 100 0 10 weight weightChildNodes e return weight 
private boolean isAdImage String imageUrl return SHelper count imageUrl, "ad" 2 
Prepares document Currently only stipping unlikely candidates, since from time to time they're getting more score than good ones especially in cases when major text is short param doc document to prepare Passed as reference, and changed inside of function protected void prepareDocument Document doc stripUnlikelyCandidates doc removeScriptsAndStyles doc 
private Document removeScriptsAndStyles Document doc Elements scripts doc getElementsByTag "script" for Element item scripts item remove Elements noscripts doc getElementsByTag "noscript" for Element item noscripts item remove Elements styles doc getElementsByTag "style" for Element style styles style remove return doc 
Match only exact matching as longestSubstring can be too fuzzy public String removeTitleFromText String text, String title don't do this as its terrible to read int index1 text toLowerCase indexOf title toLowerCase if index1 0 text text substring index1 title length return text trim return text 
public ArticleTextExtractor setNegative String negativeStr this negativeStr negativeStr NEGATIVE Pattern compile negativeStr return this 
public void setOutputFormatter OutputFormatter formatter this formatter formatter 
public ArticleTextExtractor setPositive String positiveStr this positiveStr positiveStr POSITIVE Pattern compile positiveStr return this 
public void setScore Element el, int score el attr "gravityScore", Integer toString score 
public ArticleTextExtractor setUnlikely String unlikelyStr this unlikelyStr unlikelyStr UNLIKELY Pattern compile unlikelyStr return this 
Removes unlikely candidates from HTML Currently takes id and class name and matches them against list of patterns param doc document to strip unlikely candidates from protected void stripUnlikelyCandidates Document doc for Element child doc select "body" select "" String className child className toLowerCase Locale getDefault String id child id toLowerCase Locale getDefault if NEGATIVE matcher className find NEGATIVE matcher id find print "REMOVE", child child remove 
Weights a child nodes of given Element During tests some difficulties were met For instanance, not every single document has nested paragraph tags inside of the major article tag Sometimes people are adding one more nesting level So, we're adding 4 points for every 100 symbols contained in tag nested inside of the current weighted element, but only 3 points for every element that's nested 2 levels deep This way we give more chances to extract the element that has less nested levels, increasing probability of the correct extraction param rootEl Element, who's child nodes will be weighted protected int weightChildNodes Element rootEl int weight 0 Element caption null ListElement pEls new ArrayList 5 for Element child rootEl children String ownText child ownText int ownTextLength ownText length if ownTextLength 20 continue if ownTextLength 200 weight Math max 50, ownTextLength 10 if child tagName equals "h1" child tagName equals "h2" weight 30 else if child tagName equals "div" child tagName equals "p" weight calcWeightForChild child, ownText if child tagName equals "p" ownTextLength 50 pEls add child if child className toLowerCase Locale getDefault equals "caption" caption child use caption and image if caption null weight 30 if pEls size 2 for Element subEl rootEl children if "h1h2h3h4h5h6" contains subEl tagName weight 20 headerEls add subEl else if "tablelitdth" contains subEl tagName addScore subEl, 30 if "p" contains subEl tagName addScore subEl, 30 return weight 
Override public int compare ImageResult o1, ImageResult o2 Returns the highest weight first return o2 weight compareTo o1 weight 
private void loadFileList File path File file if path null file path else file mPath try file mkdirs catch SecurityException e e printStackTrace if file exists mFileList file listFiles else mFileList new File[0] Arrays sort mFileList, new SortName if mFileList null mFileNameList new String[0] mFileList new File[0] else mFileNameList new String[mFileList length] for int n 0 n mFileList length n mFileNameList[n] mFileList[n] getName 
Override public void onClick View v switch v getId case R id importBackup loadFileList null onCreateDialog DIALOG_LOAD_FILE break case R id importFromBrowser mBookmarkManager importBookmarksFromBrowser BookmarkActivity this break case R id exportBackup mBookmarkManager exportBookmarks break 
Override public void onCreate Bundle savedInstanceState super onCreate savedInstanceState setContentView R layout bookmark_settings Toolbar toolbar Toolbar findViewById R id toolbar setSupportActionBar toolbar getSupportActionBar setDisplayHomeAsUpEnabled true LinearLayout exportBackup LinearLayout findViewById R id exportBackup LinearLayout importBackup LinearLayout findViewById R id importBackup LinearLayout importFromBrowser LinearLayout findViewById R id importFromBrowser TextView importBookmarks TextView findViewById R id isImportBrowserAvailable mBookmarkManager BookmarkManager getInstance getApplicationContext PreferenceManager mPreferences PreferenceManager getInstance boolean systemBrowser mPreferences getSystemBrowserPresent exportBackup setOnClickListener this importBackup setOnClickListener this importFromBrowser setOnClickListener this if systemBrowser importBookmarks setText getResources getString R string stock_browser_available else importBookmarks setText getResources getString R string stock_browser_unavailable 
protected Dialog onCreateDialog int id Dialog dialog final AlertDialog Builder builder new Builder this switch id case DIALOG_LOAD_FILE builder setTitle R string title_chooser if mFileList null dialog builder create return dialog builder setItems mFileNameList, new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which if mFileList[which] isDirectory loadFileList mFileList[which] builder setItems mFileNameList, this builder show else mBookmarkManager importBookmarksFromFile mFileList[which], BookmarkActivity this break dialog builder show return dialog 
Override public boolean onOptionsItemSelected MenuItem item finish return true 
Override public int compare File a, File b if a isDirectory b isDirectory return a getName compareTo b getName if a isDirectory return 1 if b isDirectory return 1 if a isFile b isFile return a getName compareTo b getName else return 1 
This method adds the the HistoryItem item to permanent bookmark storage param item public synchronized boolean addBookmark HistoryItem item File bookmarksFile new File mContext getFilesDir , FILE_BOOKMARKS if item getUrl null mBookmarkMap containsKey item getUrl return false try BufferedWriter bookmarkWriter new BufferedWriter new FileWriter bookmarksFile, true JSONObject object new JSONObject object put TITLE, item getTitle object put URL, item getUrl object put FOLDER, item getFolder object put ORDER, item getOrder bookmarkWriter write object toString bookmarkWriter newLine bookmarkWriter close mBookmarkMap put item getUrl , 1 catch IOException JSONException e e printStackTrace return true 
This method adds the list of HistoryItems to permanent bookmark storage param list public synchronized void addBookmarkList ListHistoryItem list File bookmarksFile new File mContext getFilesDir , FILE_BOOKMARKS try BufferedWriter bookmarkWriter new BufferedWriter new FileWriter bookmarksFile, true for HistoryItem item list if item getUrl null mBookmarkMap containsKey item getUrl JSONObject object new JSONObject object put TITLE, item getTitle object put URL, item getUrl object put FOLDER, item getFolder object put ORDER, item getOrder bookmarkWriter write object toString bookmarkWriter newLine mBookmarkMap put item getUrl , 1 bookmarkWriter close catch IOException JSONException e e printStackTrace 
private BookmarkManager Context context mContext context mBookmarkMap getBookmarkUrls 
This method deletes the bookmark with the given url param url public synchronized boolean deleteBookmark String url ListHistoryItem list if url null return false mBookmarkMap remove url list getBookmarks false File bookmarksFile new File mContext getFilesDir , FILE_BOOKMARKS boolean bookmarkDeleted false try BufferedWriter fileWriter new BufferedWriter new FileWriter bookmarksFile, false for HistoryItem item list if item getUrl equalsIgnoreCase url JSONObject object new JSONObject object put TITLE, item getTitle object put URL, item getUrl object put FOLDER, item getFolder object put ORDER, item getOrder fileWriter write object toString fileWriter newLine else bookmarkDeleted true fileWriter close catch IOException JSONException e e printStackTrace return bookmarkDeleted 
This method exports the stored bookmarks to a text file in the device's external download directory public synchronized void exportBookmarks ListHistoryItem bookmarkList getBookmarks true File bookmarksExport new File Environment getExternalStoragePublicDirectory Environment DIRECTORY_DOWNLOADS , "BookmarksExport txt" int counter 0 while bookmarksExport exists counter bookmarksExport new File Environment getExternalStoragePublicDirectory Environment DIRECTORY_DOWNLOADS , "BookmarksExport" counter " txt" try BufferedWriter bookmarkWriter new BufferedWriter new FileWriter bookmarksExport, false for HistoryItem item bookmarkList JSONObject object new JSONObject object put TITLE, item getTitle object put URL, item getUrl object put FOLDER, item getFolder object put ORDER, item getOrder bookmarkWriter write object toString bookmarkWriter newLine bookmarkWriter close Toast makeText mContext, mContext getString R string bookmark_export_path " " bookmarksExport getPath , Toast LENGTH_SHORT show catch IOException JSONException e e printStackTrace 
This method returns a list of all stored bookmarks return public synchronized ListHistoryItem getBookmarks boolean sort ListHistoryItem bookmarks new ArrayList File bookmarksFile new File mContext getFilesDir , FILE_BOOKMARKS try BufferedReader bookmarksReader new BufferedReader new FileReader bookmarksFile String line while line bookmarksReader readLine null JSONObject object new JSONObject line HistoryItem item new HistoryItem item setTitle object getString TITLE item setUrl object getString URL item setFolder object getString FOLDER item setOrder object getInt ORDER item setImageId R drawable ic_bookmark bookmarks add item bookmarksReader close catch IOException JSONException e e printStackTrace if sort Collections sort bookmarks, new SortIgnoreCase return bookmarks 
This method returns a list of bookmarks located in the specified folder param folder return public synchronized ListHistoryItem getBookmarksFromFolder String folder ListHistoryItem bookmarks new ArrayList File bookmarksFile new File mContext getFilesDir , FILE_BOOKMARKS try BufferedReader bookmarksReader new BufferedReader new FileReader bookmarksFile String line while line bookmarksReader readLine null JSONObject object new JSONObject line if object getString FOLDER equals folder HistoryItem item new HistoryItem item setTitle object getString TITLE item setUrl object getString URL item setFolder object getString FOLDER item setOrder object getInt ORDER item setImageId R drawable ic_bookmark bookmarks add item bookmarksReader close catch IOException JSONException e e printStackTrace return bookmarks 
Method is used internally for searching the bookmarks return private synchronized SortedMapString, Integer getBookmarkUrls SortedMapString, Integer map new TreeMap String CASE_INSENSITIVE_ORDER File bookmarksFile new File mContext getFilesDir , FILE_BOOKMARKS try BufferedReader bookmarksReader new BufferedReader new FileReader bookmarksFile String line while line bookmarksReader readLine null JSONObject object new JSONObject line map put object getString URL , 1 bookmarksReader close catch JSONException IOException e e printStackTrace return map 
This method returns a list of all folders return public synchronized ListHistoryItem getFolders ListHistoryItem folders new ArrayList SortedMapString, Integer folderMap new TreeMap String CASE_INSENSITIVE_ORDER File bookmarksFile new File mContext getFilesDir , FILE_BOOKMARKS try BufferedReader bookmarksReader new BufferedReader new FileReader bookmarksFile String line while line bookmarksReader readLine null JSONObject object new JSONObject line String folderName object getString FOLDER if folderName isEmpty folderMap containsKey folderName HistoryItem item new HistoryItem item setTitle folderName item setUrl Constants FOLDER folderName folderMap put folderName, 1 folders add item bookmarksReader close catch IOException JSONException e e printStackTrace return folders 
public static BookmarkManager getInstance Context context if mInstance null mInstance new BookmarkManager context return mInstance 
This method imports all bookmarks that are included in the device's permanent bookmark storage public synchronized void importBookmarksFromBrowser Context context if PreferenceManager getInstance getSystemBrowserPresent ListHistoryItem bookmarkList new ArrayList String[] columns new String[] Browser BookmarkColumns TITLE, Browser BookmarkColumns URL String selection Browser BookmarkColumns BOOKMARK " 1" Cursor cursor mContext getContentResolver query Browser BOOKMARKS_URI, columns, selection, null, null String title, url int number 0 if cursor moveToFirst do title cursor getString 0 url cursor getString 1 if title isEmpty title Utils getDomainName url number bookmarkList add new HistoryItem url, title while cursor moveToNext cursor close addBookmarkList bookmarkList Utils showToast mContext, number " " mContext getResources getString R string message_import else Utils createInformativeDialog context, mContext getResources getString R string title_error , mContext getResources getString R string dialog_import_error 
This method imports the bookmarks from a backup file that is located on external storage param dir param file public synchronized void importBookmarksFromFile File file, Context context if file null return ListHistoryItem list new ArrayList try BufferedReader bookmarksReader new BufferedReader new FileReader file String line int number 0 while line bookmarksReader readLine null JSONObject object new JSONObject line HistoryItem item new HistoryItem item setTitle object getString TITLE item setUrl object getString URL item setFolder object getString FOLDER item setOrder object getInt ORDER list add item number bookmarksReader close addBookmarkList list Utils showToast mContext, number " " mContext getResources getString R string message_import catch IOException JSONException e e printStackTrace Utils createInformativeDialog context, mContext getResources getString R string title_error , mContext getResources getString R string import_bookmark_error 
This method overwrites the entire bookmark file with the list of bookmarks This is useful when an edit has been made to one or more bookmarks in the list param list public synchronized void overwriteBookmarks ListHistoryItem list File bookmarksFile new File mContext getFilesDir , FILE_BOOKMARKS try BufferedWriter bookmarkWriter new BufferedWriter new FileWriter bookmarksFile, false for HistoryItem item list JSONObject object new JSONObject object put TITLE, item getTitle object put URL, item getUrl object put FOLDER, item getFolder object put ORDER, item getOrder bookmarkWriter write object toString bookmarkWriter newLine bookmarkWriter close catch IOException JSONException e e printStackTrace 
public int compare HistoryItem o1, HistoryItem o2 if o1 null o2 null o1 getTitle null o2 getTitle null return 0 return o1 getTitle toLowerCase Locale getDefault compareTo o2 getTitle toLowerCase Locale getDefault 
public void addItemToHistory final String title, final String url Runnable update new Runnable Override public void run if isSystemBrowserAvailable mPreferences getSyncHistoryEnabled try Browser updateVisitedHistory getContentResolver , url, true catch NullPointerException ignored try if mHistoryDatabase null mHistoryDatabase HistoryDatabase getInstance mActivity mHistoryDatabase visitHistoryItem url, title catch IllegalStateException e Log e Constants TAG, "IllegalStateException in updateHistory" catch NullPointerException e Log e Constants TAG, "NullPointerException in updateHistory" catch SQLiteException e Log e Constants TAG, "SQLiteException in updateHistory" if url null url startsWith Constants FILE new Thread update start 
private void changeToolbarBackground Bitmap favicon Palette from favicon generate new Palette PaletteAsyncListener Override public void onGenerated Palette palette OR with opaque black to remove transparency glitches int color 0xff000000 palette getVibrantColor mActivity getResources getColor R color primary_color int finalColor Lighten up the dark color if it is too dark if isColorTooDark color finalColor mixTwoColors mActivity getResources getColor R color primary_color , color, 0 25f else finalColor color ValueAnimator anim ValueAnimator ofObject new ArgbEvaluator , mBackground getColor , finalColor anim addUpdateListener new AnimatorUpdateListener Override public void onAnimationUpdate ValueAnimator animation int color Integer animation getAnimatedValue mBackground setColor color getWindow setBackgroundDrawable mBackground mToolbarLayout setBackgroundColor color anim setDuration 300 anim start 
private boolean checkForTor boolean useProxy mPreferences getUseProxy OrbotHelper oh new OrbotHelper this if oh isOrbotInstalled mPreferences getCheckedForTor mPreferences setCheckedForTor true DialogInterface OnClickListener dialogClickListener new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which switch which case DialogInterface BUTTON_POSITIVE mPreferences setUseProxy true initializeTor break case DialogInterface BUTTON_NEGATIVE mPreferences setUseProxy false break AlertDialog Builder builder new AlertDialog Builder this builder setMessage R string use_tor_prompt setPositiveButton R string yes, dialogClickListener setNegativeButton R string no, dialogClickListener show return true else if oh isOrbotInstalled useProxy return true else mPreferences setUseProxy false return false 
SuppressLint "NewApi" SuppressWarnings "deprecation" public void clearCookies TODO Break out web storage deletion into its own optionaction TODO clear web storage for all sites that are visited in Incognito mode WebStorage storage WebStorage getInstance storage deleteAllData CookieManager c CookieManager getInstance if Build VERSION SDK_INT Build VERSION_CODES LOLLIPOP c removeAllCookies null else CookieSyncManager createInstance this c removeAllCookie 
SuppressWarnings "deprecation" public void clearHistory this deleteDatabase HistoryDatabase DATABASE_NAME WebViewDatabase m WebViewDatabase getInstance this m clearFormData m clearHttpAuthUsernamePassword if API 18 m clearUsernamePassword WebIconDatabase getInstance removeAllIcons if mSystemBrowser try Browser clearHistory getContentResolver catch NullPointerException ignored Utils trimCache this 
public void closeActivity finish 
private void closeBrowser mBrowserFrame setBackgroundColor mBackgroundColor if mPreferences getClearCacheExit mCurrentView null isIncognito mCurrentView clearCache true Log d Constants TAG, "Cache Cleared" if mPreferences getClearHistoryExitEnabled isIncognito clearHistory Log d Constants TAG, "History Cleared" if mPreferences getClearCookiesExitEnabled isIncognito clearCookies Log d Constants TAG, "Cookies Cleared" mCurrentView null for int n 0 n mWebViews size n if mWebViews get n null mWebViews get n onDestroy mWebViews clear mTitleAdapter notifyDataSetChanged finish 
public void closeDrawers mDrawerLayout closeDrawers 
Override public void closeEmptyTab if mCurrentView null mCurrentView getWebView copyBackForwardList getSize 0 closeCurrentTab 
private synchronized void deleteTab int position if position mWebViews size return int current mDrawerListLeft getCheckedItemPosition LightningView reference mWebViews get position if reference null return if reference getUrl null reference getUrl startsWith Constants FILE isIncognito mPreferences setSavedUrl reference getUrl boolean isShown reference isShown if isShown mBrowserFrame setBackgroundColor mBackgroundColor if current position mWebViews remove position mDrawerListLeft setItemChecked current 1, true reference onDestroy else if mWebViews size position 1 if current position showTab mWebViews get position 1 mWebViews remove position mDrawerListLeft setItemChecked position, true else mWebViews remove position reference onDestroy else if mWebViews size 1 if current position showTab mWebViews get position 1 mWebViews remove position mDrawerListLeft setItemChecked position 1, true else mWebViews remove position reference onDestroy else if mCurrentView getUrl null mCurrentView getUrl startsWith Constants FILE mCurrentView getUrl equals mHomepage closeActivity else mWebViews remove position if mPreferences getClearCacheExit mCurrentView null isIncognito mCurrentView clearCache true Log d Constants TAG, "Cache Cleared" if mPreferences getClearHistoryExitEnabled isIncognito clearHistory Log d Constants TAG, "History Cleared" if mPreferences getClearCookiesExitEnabled isIncognito clearCookies Log d Constants TAG, "Cookies Cleared" reference pauseTimers reference onDestroy mCurrentView null mTitleAdapter notifyDataSetChanged finish mTitleAdapter notifyDataSetChanged if mIsNewIntent isShown mIsNewIntent false closeActivity Log d Constants TAG, "deleted tab" 
Takes in the id of which bookmark was selected and shows a dialog that allows the user to rename and change the url of the bookmark param id which id in the list was chosen public synchronized void editBookmark final int id final AlertDialog Builder homePicker new AlertDialog Builder mActivity homePicker setTitle getResources getString R string title_edit_bookmark final EditText getTitle new EditText mActivity getTitle setHint getResources getString R string hint_title getTitle setText mBookmarkList get id getTitle getTitle setSingleLine final EditText getUrl new EditText mActivity getUrl setHint getResources getString R string hint_url getUrl setText mBookmarkList get id getUrl getUrl setSingleLine LinearLayout layout new LinearLayout mActivity layout setOrientation LinearLayout VERTICAL layout addView getTitle layout addView getUrl homePicker setView layout homePicker setPositiveButton getResources getString R string action_ok , new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which mBookmarkList get id setTitle getTitle getText toString mBookmarkList get id setUrl getUrl getText toString mBookmarkManager overwriteBookmarks mBookmarkList Collections sort mBookmarkList, new SortIgnoreCase notifyBookmarkDataSetChanged if mCurrentView null if mCurrentView getUrl startsWith Constants FILE mCurrentView getUrl endsWith "bookmarks html" openBookmarkPage mCurrentView getWebView homePicker show 
method that shows a dialog asking what string the user wishes to search for It highlights the text entered private void findInPage final AlertDialog Builder finder new AlertDialog Builder mActivity finder setTitle getResources getString R string action_find final EditText getHome new EditText this getHome setHint getResources getString R string search_hint finder setView getHome finder setPositiveButton getResources getString R string search_hint , new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which String query getHome getText toString if query length 0 showSearchInterfaceBar query finder show 
Override returns the Activity instance for this activity, very helpful when creating things in other classes I think public Activity getActivity return mActivity 
Override a stupid method that returns the bitmap image to display in place of a loading video public Bitmap getDefaultVideoPoster if mDefaultVideoPoster null mDefaultVideoPoster BitmapFactory decodeResource getResources , android R drawable ic_media_play return mDefaultVideoPoster 
static String getDomainName String url throws URISyntaxException URI uri new URI url String domain uri getHost if domain null return url return domain startsWith "www " ? domain substring 4 domain 
private void getImage ImageView image, HistoryItem web new DownloadImageTask image, web execute web getUrl 
Override public int getMenu return R menu main 
public boolean getSystemBrowser Cursor c null String[] columns new String[] "url", "title" boolean browserFlag try Uri bookmarks Browser BOOKMARKS_URI c getContentResolver query bookmarks, columns, null, null, null catch SQLiteException IllegalStateException NullPointerException e e printStackTrace if c null Log d "Browser", "System Browser Available" browserFlag true else Log e "Browser", "System Browser Unavailable" browserFlag false if c null c close mPreferences setSystemBrowserPresent browserFlag return browserFlag 
SuppressLint "InflateParams" Override dumb method that returns the loading progress for a video public View getVideoLoadingProgressView if mVideoProgressView null LayoutInflater inflater LayoutInflater from this mVideoProgressView inflater inflate R layout video_loading_progress, null return mVideoProgressView 
public void handleNewIntent Intent intent String url null if intent null url intent getDataString int num 0 if intent null intent getExtras null num intent getExtras getInt getPackageName " Origin" if num 1 mCurrentView loadUrl url else if url null if url startsWith Constants FILE Utils showToast this, getResources getString R string message_blocked_local url null newTab url, true mIsNewIntent true 
it hides the action bar, seriously what else were you expecting Override public void hideActionBar if mFullScreen if mBrowserFrame findViewById R id toolbar_layout null mUiLayout removeView mToolbarLayout mBrowserFrame addView mToolbarLayout mToolbarLayout bringToFront Log d Constants TAG, "Move view to browser frame" if mToolbarLayout getVisibility View GONE Animation hide AnimationUtils loadAnimation mActivity, R anim slide_up hide setAnimationListener new AnimationListener Override public void onAnimationStart Animation animation Override public void onAnimationEnd Animation animation mToolbarLayout setVisibility View GONE Override public void onAnimationRepeat Animation animation mToolbarLayout startAnimation hide Log d Constants TAG, "Hide" 
SuppressLint "NewApi" SuppressWarnings "deprecation" private synchronized void initialize setContentView R layout activity_main Toolbar toolbar Toolbar findViewById R id toolbar setSupportActionBar toolbar ActionBar actionBar getSupportActionBar mPreferences PreferenceManager getInstance mDarkTheme mPreferences getUseDarkTheme isIncognito mActivity this mWebViews clear mClickHandler new ClickHandler this mBrowserFrame FrameLayout findViewById R id content_frame mToolbarLayout LinearLayout findViewById R id toolbar_layout initialize background ColorDrawable mBackground setColor ColorDrawable mToolbarLayout getBackground getColor mUiLayout LinearLayout findViewById R id ui_layout mProgressBar AnimatedProgressBar findViewById R id progress_view RelativeLayout newTab RelativeLayout findViewById R id new_tab_button mDrawerLeft LinearLayout findViewById R id left_drawer Drawer stutters otherwise mDrawerLeft setLayerType View LAYER_TYPE_HARDWARE, null mDrawerLayout DrawerLayout findViewById R id drawer_layout mDrawerListLeft ListView findViewById R id left_drawer_list mDrawerRight LinearLayout findViewById R id right_drawer mDrawerRight setLayerType View LAYER_TYPE_HARDWARE, null mDrawerListRight ListView findViewById R id right_drawer_list setNavigationDrawerWidth mDrawerLayout setDrawerListener new DrawerLocker mWebpageBitmap Utils getWebpageBitmap getResources , mDarkTheme mHomepage mPreferences getHomepage mTitleAdapter new LightningViewAdapter this, R layout tab_list_item, mWebViews mDrawerListLeft setAdapter mTitleAdapter mDrawerListLeft setOnItemClickListener new DrawerItemClickListener mDrawerListLeft setOnItemLongClickListener new DrawerItemLongClickListener mDrawerListRight setOnItemClickListener new BookmarkItemClickListener mDrawerListRight setOnItemLongClickListener new BookmarkItemLongClickListener mHistoryDatabase HistoryDatabase getInstance getApplicationContext set display options of the ActionBar actionBar setDisplayShowTitleEnabled false actionBar setDisplayShowHomeEnabled false actionBar setDisplayShowCustomEnabled true actionBar setCustomView R layout toolbar_content View v actionBar getCustomView LayoutParams lp v getLayoutParams lp width LayoutParams MATCH_PARENT v setLayoutParams lp mArrowDrawable new DrawerArrowDrawable this mArrowImage ImageView actionBar getCustomView findViewById R id arrow Use hardware acceleration for the animation mArrowImage setLayerType View LAYER_TYPE_HARDWARE, null mArrowImage setImageDrawable mArrowDrawable LinearLayout arrowButton LinearLayout actionBar getCustomView findViewById R id arrow_button arrowButton setOnClickListener this RelativeLayout back RelativeLayout findViewById R id action_back back setOnClickListener this RelativeLayout forward RelativeLayout findViewById R id action_forward forward setOnClickListener this create the search EditText in the ToolBar mSearch AutoCompleteTextView actionBar getCustomView findViewById R id search mUntitledTitle getString R string untitled mBackgroundColor getResources getColor R color primary_color if Build VERSION SDK_INT Build VERSION_CODES LOLLIPOP mDeleteIcon getResources getDrawable R drawable ic_action_delete mRefreshIcon getResources getDrawable R drawable ic_action_refresh mCopyIcon getResources getDrawable R drawable ic_action_copy else Theme theme getTheme mDeleteIcon getResources getDrawable R drawable ic_action_delete, theme mRefreshIcon getResources getDrawable R drawable ic_action_refresh, theme mCopyIcon getResources getDrawable R drawable ic_action_copy, theme int iconBounds Utils convertDpToPixels 24 mDeleteIcon setBounds 0, 0, iconBounds, iconBounds mRefreshIcon setBounds 0, 0, iconBounds, iconBounds mCopyIcon setBounds 0, 0, iconBounds, iconBounds mIcon mRefreshIcon SearchClass search new SearchClass mSearch setCompoundDrawables null, null, mRefreshIcon, null mSearch setOnKeyListener search new KeyListener mSearch setOnFocusChangeListener search new FocusChangeListener mSearch setOnEditorActionListener search new EditorActionListener mSearch setOnTouchListener search new TouchListener mSystemBrowser getSystemBrowser Thread initialize new Thread new Runnable Override public void run mBookmarkManager BookmarkManager getInstance mActivity getApplicationContext mBookmarkList mBookmarkManager getBookmarks true if mBookmarkList size 0 mPreferences getDefaultBookmarks for String[] array BookmarkManager DEFAULT_BOOKMARKS HistoryItem bookmark new HistoryItem array[0], array[1] if mBookmarkManager addBookmark bookmark mBookmarkList add bookmark Collections sort mBookmarkList, new SortIgnoreCase mPreferences setDefaultBookmarks false mBookmarkAdapter new BookmarkViewAdapter mActivity, R layout bookmark_list_item, mBookmarkList mDrawerListRight setAdapter mBookmarkAdapter initializeSearchSuggestions mSearch initialize run newTab setOnClickListener this newTab setOnLongClickListener new OnLongClickListener Override public boolean onLongClick View v String url mPreferences getSavedUrl if url null newTab url, true Toast makeText mActivity, R string deleted_tab, Toast LENGTH_SHORT show mPreferences setSavedUrl null return true mDrawerLayout setDrawerShadow R drawable drawer_right_shadow, GravityCompat END mDrawerLayout setDrawerShadow R drawable drawer_left_shadow, GravityCompat START initializeTabs if API Build VERSION_CODES JELLY_BEAN_MR2 WebIconDatabase getInstance open getDir "icons", MODE_PRIVATE getPath checkForTor 
public void initializePreferences if mPreferences null mPreferences PreferenceManager getInstance mFullScreen mPreferences getFullScreenEnabled mColorMode mPreferences getColorModeEnabled mColorMode mDarkTheme if isIncognito mColorMode mDarkTheme mWebpageBitmap null changeToolbarBackground mWebpageBitmap else if isIncognito mCurrentView null mDarkTheme mCurrentView getFavicon null changeToolbarBackground mCurrentView getFavicon if mFullScreen mBrowserFrame findViewById R id toolbar_layout null mUiLayout removeView mToolbarLayout mBrowserFrame addView mToolbarLayout mToolbarLayout bringToFront else if mBrowserFrame findViewById R id toolbar_layout null mBrowserFrame removeView mToolbarLayout mUiLayout addView mToolbarLayout, 0 if mPreferences getHideStatusBarEnabled getWindow setFlags WindowManager LayoutParams FLAG_FULLSCREEN, WindowManager LayoutParams FLAG_FULLSCREEN else getWindow clearFlags WindowManager LayoutParams FLAG_FULLSCREEN switch mPreferences getSearchChoice case 0 mSearchText mPreferences getSearchUrl if mSearchText startsWith Constants HTTP mSearchText startsWith Constants HTTPS mSearchText Constants GOOGLE_SEARCH break case 1 mSearchText Constants GOOGLE_SEARCH break case 2 mSearchText Constants ASK_SEARCH break case 3 mSearchText Constants BING_SEARCH break case 4 mSearchText Constants YAHOO_SEARCH break case 5 mSearchText Constants STARTPAGE_SEARCH break case 6 mSearchText Constants STARTPAGE_MOBILE_SEARCH break case 7 mSearchText Constants DUCK_SEARCH break case 8 mSearchText Constants DUCK_LITE_SEARCH break case 9 mSearchText Constants BAIDU_SEARCH break case 10 mSearchText Constants YANDEX_SEARCH break updateCookiePreference if mPreferences getUseProxy initializeTor else try WebkitProxy resetProxy BrowserApp class getName , getApplicationContext catch Exception e e printStackTrace 
method to generate search suggestions for the AutoCompleteTextView from previously searched URLs private void initializeSearchSuggestions final AutoCompleteTextView getUrl getUrl setThreshold 1 getUrl setDropDownWidth 1 getUrl setDropDownAnchor R id toolbar_layout getUrl setOnItemClickListener new OnItemClickListener Override public void onItemClick AdapterView? arg0, View arg1, int arg2, long arg3 try String url url TextView arg1 findViewById R id url getText toString if url startsWith mActivity getString R string suggestion url TextView arg1 findViewById R id title getText toString else getUrl setText url searchTheWeb url InputMethodManager imm InputMethodManager getSystemService Context INPUT_METHOD_SERVICE imm hideSoftInputFromWindow getUrl getWindowToken , 0 if mCurrentView null mCurrentView requestFocus catch NullPointerException e Log e "Browser Error ", "NullPointerException on item click" getUrl setSelectAllOnFocus true mSearchAdapter new SearchAdapter mActivity, mDarkTheme, isIncognito getUrl setAdapter mSearchAdapter 
private void initializeTor OrbotHelper oh new OrbotHelper this if oh isOrbotRunning oh requestOrbotStart this try String host mPreferences getProxyHost int port mPreferences getProxyPort WebkitProxy setProxy BrowserApp class getName , getApplicationContext , host, port catch Exception e Log d Constants TAG, "error enabling web proxying", e 
public static boolean isColorTooDark int color final byte RED_CHANNEL 16 final byte GREEN_CHANNEL 8 final byte BLUE_CHANNEL 0 int r int float color RED_CHANNEL 0xff 0 3f 0xff int g int float color GREEN_CHANNEL 0xff 0 59 0xff int b int float color 0xff 0 11 0xff int gr r g b 0xff int gray gr gr GREEN_CHANNEL gr RED_CHANNEL return gray 0x727272 
Override public boolean isIncognito return false 
public boolean isSystemBrowserAvailable return mSystemBrowser 
private boolean isTablet return getResources getConfiguration screenLayout Configuration SCREENLAYOUT_SIZE_MASK Configuration SCREENLAYOUT_SIZE_XLARGE 
Override handles a long click on the page, parameter String url is the url that should have been obtained from the WebView touch node thingy, if it is null, this method tries to deal with it and find a workaround public void longClickPage final String url HitTestResult result null if mCurrentView getWebView null result mCurrentView getWebView getHitTestResult if url null if result null if result getType HitTestResult SRC_IMAGE_ANCHOR_TYPE result getType HitTestResult IMAGE_TYPE DialogInterface OnClickListener dialogClickListener new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which switch which case DialogInterface BUTTON_POSITIVE newTab url, false break case DialogInterface BUTTON_NEGATIVE mCurrentView loadUrl url break case DialogInterface BUTTON_NEUTRAL if API 8 Utils downloadFile mActivity, url, mCurrentView getUserAgent , "attachment", false break AlertDialog Builder builder new AlertDialog Builder mActivity dialog builder setTitle url replace Constants HTTP, "" setMessage getResources getString R string dialog_image setPositiveButton getResources getString R string action_new_tab , dialogClickListener setNegativeButton getResources getString R string action_open , dialogClickListener setNeutralButton getResources getString R string action_download , dialogClickListener show else DialogInterface OnClickListener dialogClickListener new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which switch which case DialogInterface BUTTON_POSITIVE newTab url, false break case DialogInterface BUTTON_NEGATIVE mCurrentView loadUrl url break case DialogInterface BUTTON_NEUTRAL ClipboardManager clipboard ClipboardManager getSystemService CLIPBOARD_SERVICE ClipData clip ClipData newPlainText "label", url clipboard setPrimaryClip clip break AlertDialog Builder builder new AlertDialog Builder mActivity dialog builder setTitle url setMessage getResources getString R string dialog_link setPositiveButton getResources getString R string action_new_tab , dialogClickListener setNegativeButton getResources getString R string action_open , dialogClickListener setNeutralButton getResources getString R string action_copy , dialogClickListener show else DialogInterface OnClickListener dialogClickListener new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which switch which case DialogInterface BUTTON_POSITIVE newTab url, false break case DialogInterface BUTTON_NEGATIVE mCurrentView loadUrl url break case DialogInterface BUTTON_NEUTRAL ClipboardManager clipboard ClipboardManager getSystemService CLIPBOARD_SERVICE ClipData clip ClipData newPlainText "label", url clipboard setPrimaryClip clip break AlertDialog Builder builder new AlertDialog Builder mActivity dialog builder setTitle url setMessage getResources getString R string dialog_link setPositiveButton getResources getString R string action_new_tab , dialogClickListener setNegativeButton getResources getString R string action_open , dialogClickListener setNeutralButton getResources getString R string action_copy , dialogClickListener show else if result null if result getExtra null final String newUrl result getExtra if result getType HitTestResult SRC_IMAGE_ANCHOR_TYPE result getType HitTestResult IMAGE_TYPE DialogInterface OnClickListener dialogClickListener new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which switch which case DialogInterface BUTTON_POSITIVE newTab newUrl, false break case DialogInterface BUTTON_NEGATIVE mCurrentView loadUrl newUrl break case DialogInterface BUTTON_NEUTRAL if API 8 Utils downloadFile mActivity, newUrl, mCurrentView getUserAgent , "attachment", false break AlertDialog Builder builder new AlertDialog Builder mActivity dialog builder setTitle newUrl replace Constants HTTP, "" setMessage getResources getString R string dialog_image setPositiveButton getResources getString R string action_new_tab , dialogClickListener setNegativeButton getResources getString R string action_open , dialogClickListener setNeutralButton getResources getString R string action_download , dialogClickListener show else DialogInterface OnClickListener dialogClickListener new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which switch which case DialogInterface BUTTON_POSITIVE newTab newUrl, false break case DialogInterface BUTTON_NEGATIVE mCurrentView loadUrl newUrl break case DialogInterface BUTTON_NEUTRAL ClipboardManager clipboard ClipboardManager getSystemService CLIPBOARD_SERVICE ClipData clip ClipData newPlainText "label", newUrl clipboard setPrimaryClip clip break AlertDialog Builder builder new AlertDialog Builder mActivity dialog builder setTitle newUrl setMessage getResources getString R string dialog_link setPositiveButton getResources getString R string action_new_tab , dialogClickListener setNegativeButton getResources getString R string action_open , dialogClickListener setNeutralButton getResources getString R string action_copy , dialogClickListener show 
public static int mixTwoColors int color1, int color2, float amount final byte ALPHA_CHANNEL 24 final byte RED_CHANNEL 16 final byte GREEN_CHANNEL 8 final byte BLUE_CHANNEL 0 final float inverseAmount 1 0f amount int r int float color1 RED_CHANNEL 0xff amount float color2 RED_CHANNEL 0xff inverseAmount 0xff int g int float color1 GREEN_CHANNEL 0xff amount float color2 GREEN_CHANNEL 0xff inverseAmount 0xff int b int float color1 0xff amount float color2 0xff inverseAmount 0xff return 0xff ALPHA_CHANNEL r RED_CHANNEL g GREEN_CHANNEL b 
protected synchronized boolean newTab String url, boolean show Limit number of tabs for limited version of app if Constants FULL_VERSION mWebViews size 10 Utils showToast this, this getString R string max_tabs return false mIsNewIntent false LightningView startingTab new LightningView mActivity, url, mDarkTheme if mIdGenerator 0 startingTab resumeTimers mIdGenerator mWebViews add startingTab mTitleAdapter notifyDataSetChanged if show mDrawerListLeft setItemChecked mWebViews size 1, true showTab startingTab return true 
refreshes the underlying list of the Bookmark adapter since the bookmark adapter doesn't always change when notifyDataChanged gets called private void notifyBookmarkDataSetChanged mBookmarkAdapter clear mBookmarkAdapter addAll mBookmarkList mBookmarkAdapter notifyDataSetChanged 
Override used to allow uploading into the browser protected void onActivityResult int requestCode, int resultCode, Intent intent if API Build VERSION_CODES LOLLIPOP if requestCode 1 if null mUploadMessage return Uri result intent null resultCode RESULT_OK ? null intent getData mUploadMessage onReceiveValue result mUploadMessage null if requestCode 1 mFilePathCallback null super onActivityResult requestCode, resultCode, intent return Uri[] results null Check that the response is a good one if resultCode Activity RESULT_OK if intent null If there is not data, then we may have taken a photo if mCameraPhotoPath null results new Uri[] Uri parse mCameraPhotoPath else String dataString intent getDataString if dataString null results new Uri[] Uri parse dataString mFilePathCallback onReceiveValue results mFilePathCallback null 
Override public void onBackPressed if mDrawerLayout isDrawerOpen mDrawerLeft mDrawerLayout closeDrawer mDrawerLeft else if mDrawerLayout isDrawerOpen mDrawerRight mDrawerLayout closeDrawer mDrawerRight else if mCurrentView null Log d Constants TAG, "onBackPressed" if mSearch hasFocus mCurrentView requestFocus else if mCurrentView canGoBack if mCurrentView isShown onHideCustomView else mCurrentView goBack else deleteTab mDrawerListLeft getCheckedItemPosition else Log e Constants TAG, "This shouldn't happen ever" super onBackPressed 
Override public void onClick View v switch v getId case R id action_back if mCurrentView null if mCurrentView canGoBack mCurrentView goBack else deleteTab mDrawerListLeft getCheckedItemPosition break case R id action_forward if mCurrentView null if mCurrentView canGoForward mCurrentView goForward break case R id arrow_button if mSearch null mSearch hasFocus mCurrentView requestFocus else mDrawerLayout openDrawer mDrawerLeft break case R id new_tab_button newTab null, true break case R id button_next mCurrentView getWebView findNext false break case R id button_back mCurrentView getWebView findNext true break case R id button_quit mCurrentView getWebView clearMatches mSearchBar setVisibility View GONE break 
Override protected void onCreate Bundle savedInstanceState super onCreate savedInstanceState initialize 
Override public boolean onCreateOptionsMenu Menu menu return super onCreateOptionsMenu menu 
Override handles javascript requests to create a new window in the browser public void onCreateWindow boolean isUserGesture, Message resultMsg if resultMsg null return if newTab "", true WebView WebViewTransport transport WebView WebViewTransport resultMsg obj transport setWebView mCurrentView getWebView resultMsg sendToTarget 
Override protected void onDestroy Log d Constants TAG, "onDestroy" if mHistoryDatabase null mHistoryDatabase close super onDestroy 
Override public void onHideCustomView if mCustomView null mCustomViewCallback null mCurrentView null return Log d Constants TAG, "onHideCustomView" mCurrentView setVisibility View VISIBLE try mCustomView setKeepScreenOn false catch SecurityException e Log e Constants TAG, "WebView is not allowed to keep the screen on" setFullscreen mPreferences getHideStatusBarEnabled FrameLayout decor FrameLayout getWindow getDecorView if decor null decor removeView mFullscreenContainer if API 19 try mCustomViewCallback onCustomViewHidden catch Throwable ignored mFullscreenContainer null mCustomView null if mVideoView null mVideoView setOnErrorListener null mVideoView setOnCompletionListener null mVideoView null setRequestedOrientation mOriginalOrientation 
Override public boolean onKeyDown int keyCode, KeyEvent event if keyCode KeyEvent KEYCODE_ENTER if mSearch hasFocus searchTheWeb mSearch getText toString else if keyCode KeyEvent KEYCODE_MENU Build VERSION SDK_INT 16 Build MANUFACTURER compareTo "LGE" 0 Workaround for stupid LG devices that crash return true return super onKeyDown keyCode, event 
Override public boolean onKeyLongPress int keyCode, KeyEvent event if keyCode KeyEvent KEYCODE_BACK showCloseDialog mDrawerListLeft getCheckedItemPosition return true 
Override public boolean onKeyUp int keyCode, KeyEvent event if keyCode KeyEvent KEYCODE_MENU Build VERSION SDK_INT 16 Build MANUFACTURER compareTo "LGE" 0 Workaround for stupid LG devices that crash openOptionsMenu return true return super onKeyUp keyCode, event 
Override handles long presses for the browser, tries to get the url of the item that was clicked and sends it it can be null to the click handler that does cool stuff with it public void onLongPress if mClickHandler null mClickHandler new ClickHandler mActivity Message click mClickHandler obtainMessage if click null click setTarget mClickHandler mCurrentView getWebView requestFocusNodeHref click 
creates a new tab with the passed in URL if it isn't null Override protected void onNewIntent Intent intent super onNewIntent intent 
Override public boolean onOptionsItemSelected MenuItem item Handle action buttons switch item getItemId case android R id home if mDrawerLayout isDrawerOpen mDrawerRight mDrawerLayout closeDrawer mDrawerRight return true case R id action_back if mCurrentView null if mCurrentView canGoBack mCurrentView goBack return true case R id action_forward if mCurrentView null if mCurrentView canGoForward mCurrentView goForward return true case R id action_new_tab newTab null, true return true case R id action_incognito startActivity new Intent this, IncognitoActivity class return true case R id action_share if mCurrentView getUrl startsWith Constants FILE Intent shareIntent new Intent android content Intent ACTION_SEND shareIntent setType "textplain" shareIntent putExtra android content Intent EXTRA_SUBJECT, mCurrentView getTitle String shareMessage mCurrentView getUrl shareIntent putExtra android content Intent EXTRA_TEXT, shareMessage startActivity Intent createChooser shareIntent, getResources getString R string dialog_title_share return true case R id action_bookmarks openBookmarks return true case R id action_copy if mCurrentView null if mCurrentView getUrl startsWith Constants FILE ClipboardManager clipboard ClipboardManager getSystemService CLIPBOARD_SERVICE ClipData clip ClipData newPlainText "label", mCurrentView getUrl clipboard setPrimaryClip clip Utils showToast mActivity, mActivity getResources getString R string message_link_copied return true case R id action_settings startActivity new Intent this, SettingsActivity class return true case R id action_history openHistory return true case R id action_add_bookmark if mCurrentView getUrl startsWith Constants FILE HistoryItem bookmark new HistoryItem mCurrentView getUrl , mCurrentView getTitle if mBookmarkManager addBookmark bookmark mBookmarkList add bookmark Collections sort mBookmarkList, new SortIgnoreCase notifyBookmarkDataSetChanged mSearchAdapter refreshBookmarks return true case R id action_find findInPage return true case R id action_reading_mode Intent read new Intent this, ReadingActivity class read putExtra Constants LOAD_READING_URL, mCurrentView getUrl startActivity read return true default return super onOptionsItemSelected item 
Override protected void onPause super onPause Log d Constants TAG, "onPause" if mCurrentView null mCurrentView pauseTimers mCurrentView onPause 
Override protected void onResume super onResume Log d Constants TAG, "onResume" if mSearchAdapter null mSearchAdapter refreshPreferences mSearchAdapter refreshBookmarks if mCurrentView null mCurrentView resumeTimers mCurrentView onResume mHistoryDatabase HistoryDatabase getInstance getApplicationContext mBookmarkList mBookmarkManager getBookmarks true notifyBookmarkDataSetChanged initializePreferences if mWebViews null for int n 0 n mWebViews size n if mWebViews get n null mWebViews get n initializePreferences this else mWebViews remove n supportInvalidateOptionsMenu 
Override public void onShowCustomView View view, int requestedOrientation, CustomViewCallback callback if view null return if mCustomView null callback null callback onCustomViewHidden return try view setKeepScreenOn true catch SecurityException e Log e Constants TAG, "WebView is not allowed to keep the screen on" mOriginalOrientation getRequestedOrientation FrameLayout decor FrameLayout getWindow getDecorView mFullscreenContainer new FullscreenHolder this mCustomView view mFullscreenContainer addView mCustomView, COVER_SCREEN_PARAMS decor addView mFullscreenContainer, COVER_SCREEN_PARAMS setFullscreen true mCurrentView setVisibility View GONE if view instanceof FrameLayout if FrameLayout view getFocusedChild instanceof VideoView mVideoView VideoView FrameLayout view getFocusedChild mVideoView setOnErrorListener new VideoCompletionListener mVideoView setOnCompletionListener new VideoCompletionListener mCustomViewCallback callback 
SuppressWarnings "deprecation" Override public void onTrimMemory int level if level TRIM_MEMORY_MODERATE Build VERSION SDK_INT Build VERSION_CODES KITKAT Log d Constants TAG, "Low Memory, Free Memory" for LightningView view mWebViews view getWebView freeMemory 
Override open the HTML bookmarks page, parameter view is the WebView that should show the page public void openBookmarkPage WebView view StringBuilder bookmarkBuilder new StringBuilder bookmarkBuilder append BookmarkPage HEADING IteratorHistoryItem iter mBookmarkList iterator HistoryItem helper while iter hasNext helper iter next bookmarkBuilder append BookmarkPage PART1 bookmarkBuilder append helper getUrl bookmarkBuilder append BookmarkPage PART2 bookmarkBuilder append helper getUrl bookmarkBuilder append BookmarkPage PART3 bookmarkBuilder append helper getTitle bookmarkBuilder append BookmarkPage PART4 bookmarkBuilder append BookmarkPage END File bookmarkWebPage new File mActivity getFilesDir , BookmarkPage FILENAME try FileWriter bookWriter new FileWriter bookmarkWebPage, false bookWriter write bookmarkBuilder toString bookWriter close catch IOException e e printStackTrace view loadUrl Constants FILE bookmarkWebPage 
helper function that opens the bookmark drawer private void openBookmarks if mDrawerLayout isDrawerOpen mDrawerLeft mDrawerLayout closeDrawers mDrawerLayout openDrawer mDrawerRight 
Override opens a file chooser param ValueCallback is the message from the WebView indicating a file chooser should be opened public void openFileChooser ValueCallbackUri uploadMsg mUploadMessage uploadMsg Intent i new Intent Intent ACTION_GET_CONTENT i addCategory Intent CATEGORY_OPENABLE i setType "" startActivityForResult Intent createChooser i, getString R string title_file_chooser , 1 
function that opens the HTML history page in the browser private void openHistory use a thread so that history retrieval doesn't block the UI Thread history new Thread new Runnable Override public void run mCurrentView loadUrl HistoryPage getHistoryPage mActivity mSearch setText "" history run 
handle presses on the refresh icon in the search bar, if the page is loading, stop the page, if it is done loading refresh the page See setIsFinishedLoading and setIsLoading for displaying the correct icon public void refreshOrStop if mCurrentView null if mCurrentView getProgress 100 mCurrentView stopLoading else mCurrentView reload 
public void restoreOrNewTab mIdGenerator 0 String url null if getIntent null url getIntent getDataString if url null if url startsWith Constants FILE Utils showToast this, getResources getString R string message_blocked_local url null if mPreferences getRestoreLostTabsEnabled String mem mPreferences getMemoryUrl mPreferences setMemoryUrl "" String[] array Utils getArray mem int count 0 for String urlString array if urlString length 0 if url null url compareTo urlString 0 url null newTab urlString, true count if url null newTab url, true else if count 0 newTab null, true else newTab url, true 
public void saveOpenTabs if mPreferences getRestoreLostTabsEnabled String s "" for int n 0 n mWebViews size n if mWebViews get n getUrl null s s mWebViews get n getUrl "$SEPARATOR$" mPreferences setMemoryUrl s 
searches the web for the query fixing any and all problems with the input checks if it is a search, url, etc void searchTheWeb String query if query equals "" return String SEARCH mSearchText query query trim mCurrentView stopLoading if query startsWith "www " query Constants HTTP query else if query startsWith "ftp " query "ftp" query boolean containsPeriod query contains " " boolean isIPAddress TextUtils isDigitsOnly query replace " ", "" query replace " ", "" length 4 query contains " " boolean aboutScheme query contains "about" boolean validURL query startsWith "ftp" query startsWith Constants HTTP query startsWith Constants FILE query startsWith Constants HTTPS isIPAddress boolean isSearch query contains " " containsPeriod aboutScheme if isIPAddress query startsWith Constants HTTP query startsWith Constants HTTPS query Constants HTTP query if isSearch try query URLEncoder encode query, "UTF8" catch UnsupportedEncodingException e e printStackTrace mCurrentView loadUrl SEARCH query else if validURL mCurrentView loadUrl Constants HTTP query else mCurrentView loadUrl query 
turns on fullscreen mode in the app param enabled whether to enable fullscreen or not public void setFullscreen boolean enabled Window win getWindow WindowManager LayoutParams winParams win getAttributes final int bits WindowManager LayoutParams FLAG_FULLSCREEN if enabled winParams flags bits else winParams flags ~bits if mCustomView null mCustomView setSystemUiVisibility View SYSTEM_UI_FLAG_VISIBLE else mBrowserFrame setSystemUiVisibility View SYSTEM_UI_FLAG_VISIBLE win setAttributes winParams 
This tells the search bar that the page is finished loading and it should display the refresh icon public void setIsFinishedLoading if mSearch hasFocus mIcon mRefreshIcon mSearch setCompoundDrawables null, null, mRefreshIcon, null 
This method lets the search bar know that the page is currently loading and that it should display the stop icon to indicate to the user that pressing it stops the page from loading public void setIsLoading if mSearch hasFocus mIcon mDeleteIcon mSearch setCompoundDrawables null, null, mDeleteIcon, null 
private void setNavigationDrawerWidth int width getResources getDisplayMetrics widthPixels Utils convertDpToPixels 56 int maxWidth if isTablet maxWidth Utils convertDpToPixels 320 else maxWidth Utils convertDpToPixels 300 if width maxWidth DrawerLayout LayoutParams params android support v4 widget DrawerLayout LayoutParams mDrawerLeft getLayoutParams params width maxWidth mDrawerLeft setLayoutParams params mDrawerLeft requestLayout DrawerLayout LayoutParams paramsRight android support v4 widget DrawerLayout LayoutParams mDrawerRight getLayoutParams paramsRight width maxWidth mDrawerRight setLayoutParams paramsRight mDrawerRight requestLayout else DrawerLayout LayoutParams params android support v4 widget DrawerLayout LayoutParams mDrawerLeft getLayoutParams params width width mDrawerLeft setLayoutParams params mDrawerLeft requestLayout DrawerLayout LayoutParams paramsRight android support v4 widget DrawerLayout LayoutParams mDrawerRight getLayoutParams paramsRight width width mDrawerRight setLayoutParams paramsRight mDrawerRight requestLayout 
Override obviously it shows the action bar if it's hidden public void showActionBar if mFullScreen if mBrowserFrame findViewById R id toolbar_layout null mUiLayout removeView mToolbarLayout mBrowserFrame addView mToolbarLayout mToolbarLayout bringToFront Log d Constants TAG, "Move view to browser frame" if mToolbarLayout getVisibility View VISIBLE Animation show AnimationUtils loadAnimation mActivity, R anim slide_down show setAnimationListener new AnimationListener Override public void onAnimationStart Animation animation Override public void onAnimationEnd Animation animation mToolbarLayout setVisibility View VISIBLE Override public void onAnimationRepeat Animation animation mToolbarLayout startAnimation show Log d Constants TAG, "Show" 
private void showCloseDialog final int position AlertDialog Builder builder new AlertDialog Builder mActivity ArrayAdapterString adapter new ArrayAdapter mActivity, android R layout simple_dropdown_item_1line adapter add mActivity getString R string close_tab adapter add mActivity getString R string close_all_tabs builder setAdapter adapter, new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which switch which case 0 deleteTab position break case 1 closeBrowser break default break builder show 
Override public void showFileChooser ValueCallbackUri[] filePathCallback if mFilePathCallback null mFilePathCallback onReceiveValue null mFilePathCallback filePathCallback Intent takePictureIntent new Intent MediaStore ACTION_IMAGE_CAPTURE if takePictureIntent resolveActivity getActivity getPackageManager null Create the File where the photo should go File photoFile null try photoFile Utils createImageFile takePictureIntent putExtra "PhotoPath", mCameraPhotoPath catch IOException ex Error occurred while creating the File Log e Constants TAG, "Unable to create Image File", ex Continue only if the File was successfully created if photoFile null mCameraPhotoPath "file" photoFile getAbsolutePath takePictureIntent putExtra MediaStore EXTRA_OUTPUT, Uri fromFile photoFile else takePictureIntent null Intent contentSelectionIntent new Intent Intent ACTION_GET_CONTENT contentSelectionIntent addCategory Intent CATEGORY_OPENABLE contentSelectionIntent setType "image" Intent[] intentArray if takePictureIntent null intentArray new Intent[] takePictureIntent else intentArray new Intent[0] Intent chooserIntent new Intent Intent ACTION_CHOOSER chooserIntent putExtra Intent EXTRA_INTENT, contentSelectionIntent chooserIntent putExtra Intent EXTRA_TITLE, "Image Chooser" chooserIntent putExtra Intent EXTRA_INITIAL_INTENTS, intentArray mActivity startActivityForResult chooserIntent, 1 
private void showSearchInterfaceBar String text if mCurrentView null mCurrentView find text mSearchBar RelativeLayout findViewById R id search_bar mSearchBar setVisibility View VISIBLE TextView tw TextView findViewById R id search_query tw setText "'" text "'" ImageButton up ImageButton findViewById R id button_next up setOnClickListener this ImageButton down ImageButton findViewById R id button_back down setOnClickListener this ImageButton quit ImageButton findViewById R id button_quit quit setOnClickListener this 
displays the WebView contained in the LightningView Also handles the removal of previous views param view the LightningView to show private synchronized void showTab LightningView view Set the background color so the color mode color doesn't show through mBrowserFrame setBackgroundColor mBackgroundColor if view null return mBrowserFrame removeAllViews if mCurrentView null mCurrentView setForegroundTab false mCurrentView onPause mCurrentView view mCurrentView setForegroundTab true if mCurrentView getWebView null updateUrl mCurrentView getUrl , true updateProgress mCurrentView getProgress else updateUrl "", true updateProgress 0 mBrowserFrame addView mCurrentView getWebView , MATCH_PARENT Remove browser frame background to reduce overdraw mBrowserFrame setBackgroundColor 0 mCurrentView requestFocus mCurrentView onResume Use a delayed handler to make the transition smooth otherwise it will get caught up with the showTab code and cause a janky motion final Handler handler new Handler handler postDelayed new Runnable Override public void run mDrawerLayout closeDrawers , 150 
Override public void toggleActionBar if mFullScreen if mToolbarLayout getVisibility View VISIBLE showActionBar else hideActionBar 
Override public void update mTitleAdapter notifyDataSetChanged 
Override public void updateProgress int n if n 100 setIsFinishedLoading else setIsLoading mProgressBar setProgress n 
Override public void updateUrl String url, boolean shortUrl if url null mSearch null mSearch hasFocus return if shortUrl url startsWith Constants FILE switch mPreferences getUrlBoxContentChoice case 0 Default, show only the domain url url replaceFirst Constants HTTP, "" url Utils getDomainName url mSearch setText url break case 1 URL, show the entire URL mSearch setText url break case 2 Title, show the page's title if mCurrentView null mCurrentView getTitle isEmpty mSearch setText mCurrentView getTitle else mSearch setText mUntitledTitle break else if url startsWith Constants FILE url "" mSearch setText url 
Override public void onItemClick AdapterView? parent, View view, int position, long id if mCurrentView null mCurrentView loadUrl mBookmarkList get position getUrl keep any jank from happening when the drawer is closed after the URL starts to load final Handler handler new Handler handler postDelayed new Runnable Override public void run mDrawerLayout closeDrawer mDrawerRight , 150 
Override public boolean onItemLongClick AdapterView? arg0, View arg1, final int position, long arg3 AlertDialog Builder builder new AlertDialog Builder mActivity builder setTitle mActivity getResources getString R string action_bookmarks builder setMessage getResources getString R string dialog_bookmark setCancelable true setPositiveButton getResources getString R string action_new_tab , new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int id newTab mBookmarkList get position getUrl , false mDrawerLayout closeDrawers setNegativeButton getResources getString R string action_delete , new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which if mBookmarkManager deleteBookmark mBookmarkList get position getUrl mBookmarkList remove position notifyBookmarkDataSetChanged mSearchAdapter refreshBookmarks openBookmarks setNeutralButton getResources getString R string action_edit , new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which editBookmark position AlertDialog alert builder create alert show return true 
public BookmarkViewAdapter Context context, int layoutResourceId, ListHistoryItem data super context, layoutResourceId, data this layoutResourceId layoutResourceId this context context this data data 
Override public View getView int position, View convertView, ViewGroup parent View row convertView BookmarkViewHolder holder if row null LayoutInflater inflater Activity context getLayoutInflater row inflater inflate layoutResourceId, parent, false holder new BookmarkViewHolder holder txtTitle TextView row findViewById R id textBookmark holder favicon ImageView row findViewById R id faviconBookmark row setTag holder else holder BookmarkViewHolder row getTag HistoryItem web data get position holder txtTitle setText web getTitle holder favicon setImageBitmap mWebpageBitmap if web getBitmap null getImage holder favicon, web else holder favicon setImageBitmap web getBitmap return row 
Override public void onClick View v deleteTab int v getTag 
protected Bitmap doInBackground String urls String url urls[0] Bitmap mIcon null unique path for each url that is bookmarked String hash String valueOf Utils getDomainName url hashCode File image new File mActivity getCacheDir , hash " png" String urldisplay try urldisplay Utils getProtocol url getDomainName url "favicon ico" catch URISyntaxException e e printStackTrace urldisplay "httpswww google coms2favicons?domain_url" url checks to see if the image exists if image exists try if not, download it URL urlDownload new URL urldisplay HttpURLConnection connection HttpURLConnection urlDownload openConnection connection setDoInput true connection connect InputStream in connection getInputStream if in null mIcon BitmapFactory decodeStream in and cache it if mIcon null FileOutputStream fos new FileOutputStream image mIcon compress Bitmap CompressFormat PNG, 100, fos fos flush fos close Log d Constants TAG, "Downloaded " urldisplay catch Exception e e printStackTrace else if it exists, retrieve it from the cache mIcon BitmapFactory decodeFile image getPath if mIcon null try if not, download it URL urlDownload new URL "httpswww google coms2favicons?domain_url" url HttpURLConnection connection HttpURLConnection urlDownload openConnection connection setDoInput true connection connect InputStream in connection getInputStream if in null mIcon BitmapFactory decodeStream in and cache it if mIcon null FileOutputStream fos new FileOutputStream image mIcon compress Bitmap CompressFormat PNG, 100, fos fos flush fos close catch Exception e e printStackTrace if mIcon null return mWebpageBitmap else return mIcon 
public DownloadImageTask ImageView bmImage, HistoryItem web this bmImage bmImage this mWeb web 
protected void onPostExecute Bitmap result Bitmap fav Utils padFavicon result bmImage setImageBitmap fav mWeb setBitmap fav notifyBookmarkDataSetChanged 
Override public void onItemClick AdapterView? parent, View view, int position, long id mIsNewIntent false showTab mWebViews get position 
Override public boolean onItemLongClick AdapterView? arg0, View arg1, final int position, long arg3 showCloseDialog position return true 
Override public void onDrawerClosed View v if v mDrawerRight mDrawerLayout setDrawerLockMode DrawerLayout LOCK_MODE_UNLOCKED, mDrawerLeft else mDrawerLayout setDrawerLockMode DrawerLayout LOCK_MODE_UNLOCKED, mDrawerRight 
Override public void onDrawerOpened View v if v mDrawerRight mDrawerLayout setDrawerLockMode DrawerLayout LOCK_MODE_LOCKED_CLOSED, mDrawerLeft else mDrawerLayout setDrawerLockMode DrawerLayout LOCK_MODE_LOCKED_CLOSED, mDrawerRight 
public FullscreenHolder Context ctx super ctx setBackgroundColor ctx getResources getColor android R color black 
SuppressLint "ClickableViewAccessibility" Override public boolean onTouchEvent MotionEvent evt return true 
Override public View getView final int position, View convertView, ViewGroup parent View row convertView LightningViewHolder holder if row null LayoutInflater inflater Activity context getLayoutInflater row inflater inflate layoutResourceId, parent, false holder new LightningViewHolder holder txtTitle TextView row findViewById R id textTab holder favicon ImageView row findViewById R id faviconTab holder exit ImageView row findViewById R id deleteButton holder exit setTag position row setTag holder else holder LightningViewHolder row getTag holder exit setTag position holder exit setOnClickListener mExitListener ViewCompat jumpDrawablesToCurrentState holder exit LightningView web data get position holder txtTitle setText web getTitle if web isForegroundTab holder txtTitle setTextAppearance context, R style boldText else holder txtTitle setTextAppearance context, R style normalText Bitmap favicon web getFavicon if web isForegroundTab holder favicon setImageBitmap favicon if isIncognito mColorMode changeToolbarBackground favicon else Bitmap grayscaleBitmap Bitmap createBitmap favicon getWidth , favicon getHeight , Bitmap Config ARGB_8888 Canvas c new Canvas grayscaleBitmap if colorMatrix null filter null paint null paint new Paint colorMatrix new ColorMatrix colorMatrix setSaturation 0 filter new ColorMatrixColorFilter colorMatrix paint setColorFilter filter c drawBitmap favicon, 0, 0, paint holder favicon setImageBitmap grayscaleBitmap return row 
public LightningViewAdapter Context context, int layoutResourceId, ListLightningView data super context, layoutResourceId, data this layoutResourceId layoutResourceId this context context this data data this mExitListener new CloseTabListener 
public int compare HistoryItem o1, HistoryItem o2 return o1 getTitle toLowerCase Locale getDefault compareTo o2 getTitle toLowerCase Locale getDefault 
Override public void onCompletion MediaPlayer mp onHideCustomView 
Override public boolean onError MediaPlayer mp, int what, int extra return false 
public static Context getAppContext return context 
Override public void onCreate super onCreate context getApplicationContext 
Override protected void onCreate Bundle savedInstanceState super onCreate savedInstanceState String issuer getIntent getStringExtra "issuer" String fingerprint getIntent getStringExtra "fingerprint" String subject getIntent getStringExtra "subject" String issuedOn getIntent getStringExtra "issued" String expiresOn getIntent getStringExtra "expires" String msg getIntent getStringExtra "msg" StringBuilder sb new StringBuilder if msg null sb append msg append "\n\n" if subject null sb append "Certificate " append subject append "\n\n" if issuer null sb append "Issued by " append issuer append "\n\n" if fingerprint null sb append "SHA1 Fingerprint " append fingerprint append "\n\n" if issuedOn null sb append "Issued " append issuedOn append "\n\n" if expiresOn null sb append "Expires " append expiresOn append "\n\n" showDialog sb toString 
Override protected void onDestroy super onDestroy if ad null ad cancel 
Override protected void onPause super onPause if ad null ad cancel 
private void showDialog String msg ad new AlertDialog Builder this setTitle "Certificate Info" setMessage msg show ad setOnDismissListener new OnDismissListener Override public void onDismiss DialogInterface arg0 CertDisplayActivity this finish 
public static X509Certificate[] getCleanChain X509Certificate[] chain, SystemKeyStore systemKeyStore throws CertificateException final LinkedListX509Certificate cleanChain new LinkedListX509Certificate boolean trustedChain false int i if systemKeyStore isTrustRoot chain[0] trustedChain true cleanChain add chain[0] for i 1 i chain length i if systemKeyStore isTrustRoot chain[i] trustedChain true if isValidLink chain[i], chain[i 1] cleanChain add chain[i] else break final X509Certificate trustRoot systemKeyStore getTrustRootFor chain[i 1] if trustRoot null cleanChain add trustRoot trustedChain true if trustedChain return cleanChain toArray new X509Certificate[cleanChain size ] else throw new CertificateException "Didn't find a trust anchor in chain cleanup" 
private static boolean isValidLink X509Certificate parent, X509Certificate child if parent getSubjectX500Principal equals child getIssuerX500Principal return false try child verify parent getPublicKey catch GeneralSecurityException gse return false return true 
public ClickHandler Context context try mBrowserController BrowserController context catch ClassCastException e throw new ClassCastException context " must implement BrowserController" 
Override public void handleMessage Message msg super handleMessage msg String url msg getData getString "url" mBrowserController longClickPage url 
public Converter String urlOnlyHint url urlOnlyHint 
This method detects the charset even if the first call only returns some bytes It will read until 4K bytes are reached and then try to determine the encoding throws IOException protected String detectCharset String key, ByteArrayOutputStream bos, BufferedInputStream in, String enc throws IOException Grab better encoding from stream byte[] arr new byte[K2] int nSum 0 while nSum K2 int n in read arr if n 0 break nSum n bos write arr, 0, n String str bos toString enc int encIndex str indexOf key int clength key length if encIndex 0 char startChar str charAt encIndex clength int lastEncIndex if startChar '\'' if we have charset'something' lastEncIndex str indexOf "'", encIndex clength else if startChar '\"' if we have charset"something" lastEncIndex str indexOf "\"", encIndex clength else if we have "texthtml charsetutf8" int first str indexOf "\"", encIndex clength if first 0 first Integer MAX_VALUE or "texthtml charsetutf8 " int sec str indexOf " ", encIndex clength if sec 0 sec Integer MAX_VALUE lastEncIndex Math min first, sec or "texthtml charsetutf8 ' int third str indexOf "'", encIndex clength if third 0 lastEncIndex Math min lastEncIndex, third reread byte array with different encoding assume that the encoding string cannot be greater than 40 chars if lastEncIndex encIndex clength lastEncIndex encIndex clength 40 String tmpEnc SHelper encodingCleanup str substring encIndex clength, lastEncIndex try in reset bos reset return tmpEnc catch IOException ex Log e Constants TAG, "Couldn't reset stream to reread with new encoding " tmpEnc " " ex toString return null 
public static String extractEncoding String contentType String[] values if contentType null values contentType split "" else values new String[0] String charset "" for String value values value value trim toLowerCase Locale getDefault if value startsWith "charset" charset value substring "charset" length http1 1 says ISO88591 is the default charset if charset length 0 charset ISO return charset 
public String getEncoding if encoding null return "" return encoding toLowerCase Locale getDefault 
public Converter setMaxBytes int maxBytes this maxBytes maxBytes return this 
reads bytes off the string and returns a string param is param maxBytes The max bytes that we want to read from the input stream return String public String streamToString InputStream is, int maxBytes, String enc encoding enc Http 1 1 standard is iso88591 not utf8 but we force utf8 as youtube assumes it if encoding null encoding isEmpty encoding UTF8 BufferedInputStream in null try in new BufferedInputStream is, K2 ByteArrayOutputStream output new ByteArrayOutputStream detect encoding with the help of meta tag try in mark K2 2 String tmpEnc detectCharset "charset", output, in, encoding if tmpEnc null encoding tmpEnc else Log d Constants TAG, "no charset found in first stage" detect with the help of xml beginning ala encoding"charset" tmpEnc detectCharset "encoding", output, in, encoding if tmpEnc null encoding tmpEnc else Log d Constants TAG, "no charset found in second stage" if Charset isSupported encoding throw new UnsupportedEncodingException encoding catch UnsupportedEncodingException e Log d Constants TAG, "Using default encoding" UTF8 " problem" e getMessage " encoding" encoding " " url encoding UTF8 SocketException Connection reset IOException missing CR problem on server probably some xml character thing? IOException Premature EOF socket unexpectly closed from server int bytesRead output size byte[] arr new byte[K2] while true if bytesRead maxBytes Log d Constants TAG, "Maxbyte of " maxBytes " exceeded Maybe html is now broken but try it nevertheless Url " url break int n in read arr if n 0 break bytesRead n output write arr, 0, n return output toString encoding catch IOException e Log e Constants TAG, e toString " url" url finally if in null try in close catch Exception e e printStackTrace return "" 
private void initialize RelativeLayout rHideStatusBar, rFullScreen, rWideViewPort, rOverView, rTextReflow, rTextSize, rDarkTheme LayoutClickListener clickListener new LayoutClickListener CheckBoxToggleListener toggleListener new CheckBoxToggleListener rHideStatusBar RelativeLayout findViewById R id rHideStatusBar rFullScreen RelativeLayout findViewById R id rFullScreen rWideViewPort RelativeLayout findViewById R id rWideViewPort rOverView RelativeLayout findViewById R id rOverView rTextReflow RelativeLayout findViewById R id rTextReflow rTextSize RelativeLayout findViewById R id rTextSize rDarkTheme RelativeLayout findViewById R id rDarkTheme rHideStatusBar setOnClickListener clickListener rFullScreen setOnClickListener clickListener rWideViewPort setOnClickListener clickListener rOverView setOnClickListener clickListener rTextReflow setOnClickListener clickListener rTextSize setOnClickListener clickListener rDarkTheme setOnClickListener clickListener cbHideStatusBar CheckBox findViewById R id cbHideStatusBar cbFullScreen CheckBox findViewById R id cbFullScreen cbWideViewPort CheckBox findViewById R id cbWideViewPort cbOverView CheckBox findViewById R id cbOverView cbTextReflow CheckBox findViewById R id cbTextReflow cbDarkTheme CheckBox findViewById R id cbDarkTheme cbHideStatusBar setChecked mPreferences getHideStatusBarEnabled cbFullScreen setChecked mPreferences getFullScreenEnabled cbWideViewPort setChecked mPreferences getUseWideViewportEnabled cbOverView setChecked mPreferences getOverviewModeEnabled cbTextReflow setChecked mPreferences getTextReflowEnabled cbDarkTheme setChecked mPreferences getUseDarkTheme cbHideStatusBar setOnCheckedChangeListener toggleListener cbFullScreen setOnCheckedChangeListener toggleListener cbWideViewPort setOnCheckedChangeListener toggleListener cbOverView setOnCheckedChangeListener toggleListener cbTextReflow setOnCheckedChangeListener toggleListener cbDarkTheme setOnCheckedChangeListener toggleListener 
Override protected void onCreate Bundle savedInstanceState super onCreate savedInstanceState setContentView R layout display_settings Toolbar toolbar Toolbar findViewById R id toolbar setSupportActionBar toolbar getSupportActionBar setDisplayHomeAsUpEnabled true mPreferences PreferenceManager getInstance initialize 
Override public boolean onOptionsItemSelected MenuItem item finish return true 
private void textSizePicker AlertDialog Builder picker new AlertDialog Builder DisplaySettingsActivity this picker setTitle getResources getString R string title_text_size int n mPreferences getTextSize picker setSingleChoiceItems R array text_size, n 1, new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which mPreferences setTextSize which 1 picker setNeutralButton getResources getString R string action_ok , new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which picker show 
Override public void onCheckedChanged CompoundButton buttonView, boolean isChecked switch buttonView getId case R id cbHideStatusBar mPreferences setHideStatusBarEnabled isChecked break case R id cbFullScreen mPreferences setFullScreenEnabled isChecked break case R id cbWideViewPort mPreferences setUseWideViewportEnabled isChecked break case R id cbOverView mPreferences setOverviewModeEnabled isChecked break case R id cbTextReflow mPreferences setTextReflowEnabled isChecked break case R id cbDarkTheme mPreferences setUseDarkTheme isChecked restart break 
Override public void onClick View v switch v getId case R id rHideStatusBar cbHideStatusBar setChecked cbHideStatusBar isChecked break case R id rFullScreen cbFullScreen setChecked cbFullScreen isChecked break case R id rWideViewPort cbWideViewPort setChecked cbWideViewPort isChecked break case R id rOverView cbOverView setChecked cbOverView isChecked break case R id rTextReflow cbTextReflow setChecked cbTextReflow isChecked break case R id rTextSize textSizePicker break case R id rDarkTheme cbDarkTheme setChecked cbDarkTheme isChecked break 
private static String encodePath String path char[] chars path toCharArray boolean needed false for char c chars if c '[' c ']' c '' needed true break if needed return path StringBuilder sb new StringBuilder "" for char c chars if c '[' c ']' c '' sb append '' sb append Integer toHexString c else sb append c return sb toString 
Notify the host application a download should be done, or that the data should be streamed if a streaming viewer is available param activity Activity requesting the download param url The full url to the content that should be downloaded param userAgent User agent of the downloading application param contentDisposition Contentdisposition http header, if present param mimetype The mimetype of the content reported by the server param privateBrowsing If the request is coming from a private browsing tab public static void onDownloadStart Activity activity, String url, String userAgent, String contentDisposition, String mimetype, boolean privateBrowsing if we're dealing wih AV content that's not explicitly marked for download, check if it's streamable if contentDisposition null contentDisposition regionMatches true, 0, "attachment", 0, 10 query the package manager to see if there's a registered handler that matches Intent intent new Intent Intent ACTION_VIEW intent setDataAndType Uri parse url , mimetype intent addFlags Intent FLAG_ACTIVITY_NEW_TASK ResolveInfo info activity getPackageManager resolveActivity intent, PackageManager MATCH_DEFAULT_ONLY if info null ComponentName myName activity getComponentName If we resolved to ourselves, we don't want to attempt to load the url only to try and download it again if myName getPackageName equals info activityInfo packageName myName getClassName equals info activityInfo name someone other than us knows how to handle this mime type with this scheme, don't download try activity startActivity intent return catch ActivityNotFoundException ex Best behavior is to fall back to a download in this case onDownloadStartNoStream activity, url, userAgent, contentDisposition, mimetype, privateBrowsing 
Notify the host application a download should be done, even if there is a streaming viewer available for thise type param activity Activity requesting the download param url The full url to the content that should be downloaded param userAgent User agent of the downloading application param contentDisposition Contentdisposition http header, if present param mimetype The mimetype of the content reported by the server param privateBrowsing If the request is coming from a private browsing tab package private static void onDownloadStartNoStream Activity activity, String url, String userAgent, String contentDisposition, String mimetype, boolean privateBrowsing String filename URLUtil guessFileName url, contentDisposition, mimetype Check to see if we have an SDCard String status Environment getExternalStorageState if status equals Environment MEDIA_MOUNTED int title String msg Check to see if the SDCard is busy, same as the music app if status equals Environment MEDIA_SHARED msg activity getString R string download_sdcard_busy_dlg_msg title R string download_sdcard_busy_dlg_title else msg activity getString R string download_no_sdcard_dlg_msg, filename title R string download_no_sdcard_dlg_title new AlertDialog Builder activity setTitle title setIcon android R drawable ic_dialog_alert setMessage msg setPositiveButton R string action_ok, null show return java net URI is a lot stricter than KURL so we have to encode some extra characters Fix for b 2538060 and b 1634719 WebAddress webAddress try webAddress new WebAddress url webAddress setPath encodePath webAddress getPath catch Exception e This only happens for very bad urls, we want to catch the exception here Log e LOGTAG, "Exception while trying to parse url '" url '\'', e return String addressString webAddress toString Uri uri Uri parse addressString final DownloadManager Request request try request new DownloadManager Request uri catch IllegalArgumentException e Toast makeText activity, R string cannot_download, Toast LENGTH_SHORT show return request setMimeType mimetype set downloaded file destination to sdcardDownload or, should it be set to one of several Environment DIRECTORY dirs depending on mimetype? String location PreferenceManager getInstance getDownloadDirectory request setDestinationInExternalPublicDir location, filename let this downloaded file be scanned by MediaScanner so that it can show up in Gallery app, for example request allowScanningByMediaScanner request setDescription webAddress getHost XXX Have to use the old url since the cookies were stored using the old percentencoded url String cookies CookieManager getInstance getCookie url request addRequestHeader "cookie", cookies request setNotificationVisibility DownloadManager Request VISIBILITY_VISIBLE_NOTIFY_COMPLETED if mimetype null if TextUtils isEmpty addressString return We must have long pressed on a link or image to download it We are not sure of the mimetype in this case, so do a head request new FetchUrlMimeType activity, request, addressString, cookies, userAgent start else final DownloadManager manager DownloadManager activity getSystemService Context DOWNLOAD_SERVICE new Thread "Browser download" Override public void run manager enqueue request start Toast makeText activity, R string download_pending, Toast LENGTH_SHORT show 
Override public void draw Canvas canvas Rect bounds getBounds final boolean isRtl isLayoutRtl Interpolated widths of arrow bars final float arrowSize lerp mBarSize, mTopBottomArrowSize, mProgress final float middleBarSize lerp mBarSize, mMiddleArrowSize, mProgress Interpolated size of middle bar final float middleBarCut lerp 0, mBarThickness 2, mProgress The rotation of the top and bottom bars that make the arrow head final float rotation lerp 0, ARROW_HEAD_ANGLE, mProgress The whole canvas rotates as the transition happens final float canvasRotate lerp isRtl ? 0 180, isRtl ? 180 0, mProgress final float topBottomBarOffset lerp mBarGap mBarThickness, 0, mProgress mPath rewind final float arrowEdge middleBarSize 2 draw middle bar mPath moveTo arrowEdge middleBarCut, 0 mPath rLineTo middleBarSize middleBarCut, 0 final float arrowWidth Math round arrowSize Math cos rotation final float arrowHeight Math round arrowSize Math sin rotation top bar mPath moveTo arrowEdge, topBottomBarOffset mPath rLineTo arrowWidth, arrowHeight bottom bar mPath moveTo arrowEdge, topBottomBarOffset mPath rLineTo arrowWidth, arrowHeight mPath moveTo 0, 0 mPath close canvas save Rotate the whole canvas if spinning, if not, rotate it 180 to get the arrow pointing the other way for RTL if mSpin canvas rotate canvasRotate mVerticalMirror ^ isRtl ? 1 1 , bounds centerX , bounds centerY else if isRtl canvas rotate 180, bounds centerX , bounds centerY canvas translate bounds centerX , bounds centerY canvas drawPath mPath, mPaint canvas restore 
param context used to get the configuration for the drawable from public DrawerArrowDrawable Context context final TypedArray typedArray context getTheme obtainStyledAttributes null, R styleable DrawerArrowToggle, R attr drawerArrowStyle, R style Base_Widget_AppCompat_DrawerArrowToggle mPaint setAntiAlias true mPaint setColor typedArray getColor R styleable DrawerArrowToggle_color, 0 mSize typedArray getDimensionPixelSize R styleable DrawerArrowToggle_drawableSize, 0 mBarSize typedArray getDimension R styleable DrawerArrowToggle_barSize, 0 mTopBottomArrowSize typedArray getDimension R styleable DrawerArrowToggle_topBottomBarArrowSize, 0 mBarThickness typedArray getDimension R styleable DrawerArrowToggle_thickness, 0 mBarGap typedArray getDimension R styleable DrawerArrowToggle_gapBetweenBars, 0 mSpin typedArray getBoolean R styleable DrawerArrowToggle_spinBars, true mMiddleArrowSize typedArray getDimension R styleable DrawerArrowToggle_middleBarArrowSize, 0 typedArray recycle mPaint setStyle Paint Style STROKE mPaint setStrokeJoin Paint Join ROUND mPaint setStrokeCap Paint Cap SQUARE mPaint setStrokeWidth mBarThickness 
Override public int getIntrinsicHeight return mSize 
Override public int getIntrinsicWidth return mSize 
Override public int getOpacity return PixelFormat TRANSLUCENT 
public float getProgress return mProgress 
public boolean isAutoMirrored Draws rotated 180 degrees in RTL mode return true 
protected boolean isLayoutRtl return false 
Linear interpolate between a and b with parameter t private static float lerp float a, float b, float t return a b a t 
Override public void setAlpha int i mPaint setAlpha i 
Override public void setColorFilter ColorFilter colorFilter mPaint setColorFilter colorFilter 
public void setProgress float progress mProgress progress invalidateSelf 
If set, canvas is flipped when progress reached to end and going back to start protected void setVerticalMirror boolean verticalMirror mVerticalMirror verticalMirror 
public FetchUrlMimeType Context context, DownloadManager Request request, String uri, String cookies, String userAgent mContext context getApplicationContext mRequest request mUri uri mCookies cookies mUserAgent userAgent Toast makeText mContext, R string download_pending, Toast LENGTH_SHORT show 
Override public void run User agent is likely to be null, though the AndroidHttpClient seems ok with that String mimeType null String contentDisposition null HttpURLConnection connection null try URL url new URL mUri connection HttpURLConnection url openConnection if mCookies null mCookies length 0 connection addRequestProperty "Cookie", mCookies connection setRequestProperty "UserAgent", mUserAgent connection connect We could get a redirect here, but if we do lets let the download manager take care of it, and thus trust that the server sends the right mimetype if connection getResponseCode 200 String header connection getHeaderField "ContentType" if header null mimeType header final int semicolonIndex mimeType indexOf '' if semicolonIndex 1 mimeType mimeType substring 0, semicolonIndex String contentDispositionHeader connection getHeaderField "ContentDisposition" if contentDispositionHeader null contentDisposition contentDispositionHeader catch IllegalArgumentException IOException ex if connection null connection disconnect finally if connection null connection disconnect if mimeType null if mimeType equalsIgnoreCase "textplain" mimeType equalsIgnoreCase "applicationoctetstream" String newMimeType MimeTypeMap getSingleton getMimeTypeFromExtension MimeTypeMap getFileExtensionFromUrl mUri if newMimeType null mRequest setMimeType newMimeType String filename URLUtil guessFileName mUri, contentDisposition, mimeType mRequest setDestinationInExternalPublicDir Environment DIRECTORY_DOWNLOADS, filename Start the download DownloadManager manager DownloadManager mContext getSystemService Context DOWNLOAD_SERVICE manager enqueue mRequest 
public void agent RelativeLayout view view setOnClickListener new OnClickListener Override public void onClick View v AlertDialog Builder agentPicker new AlertDialog Builder mActivity agentPicker setTitle getResources getString R string title_user_agent mAgentChoice mPreferences getUserAgentChoice agentPicker setSingleChoiceItems R array user_agent, mAgentChoice 1, new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which mPreferences setUserAgentChoice which 1 switch which 1 case 1 mAgentTextView setText getResources getString R string agent_default break case 2 mAgentTextView setText getResources getString R string agent_desktop break case 3 mAgentTextView setText getResources getString R string agent_mobile break case 4 mAgentTextView setText getResources getString R string agent_custom agentPicker break agentPicker setNeutralButton getResources getString R string action_ok , new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which TODO Autogenerated method stub agentPicker setOnCancelListener new DialogInterface OnCancelListener Override public void onCancel DialogInterface dialog TODO Autogenerated method stub Log i "Cancelled", "" agentPicker show 
public void agentPicker final AlertDialog Builder agentStringPicker new AlertDialog Builder mActivity agentStringPicker setTitle getResources getString R string title_user_agent final EditText getAgent new EditText this agentStringPicker setView getAgent agentStringPicker setPositiveButton getResources getString R string action_ok , new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which String text getAgent getText toString mPreferences setUserAgentString text mAgentTextView setText getResources getString R string agent_custom agentStringPicker show 
private void cbSearchSuggestions CheckBox view view setOnCheckedChangeListener new OnCheckedChangeListener Override public void onCheckedChanged CompoundButton buttonView, boolean isChecked mPreferences setGoogleSearchSuggestionsEnabled isChecked 
public void download RelativeLayout view view setOnClickListener new OnClickListener Override public void onClick View v AlertDialog Builder picker new AlertDialog Builder mActivity picker setTitle getResources getString R string title_download_location mDownloadLocation mPreferences getDownloadDirectory int n if mDownloadLocation contains Environment DIRECTORY_DOWNLOADS n 1 else n 2 picker setSingleChoiceItems R array download_folder, n 1, new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which switch which 1 case 1 mPreferences setDownloadDirectory Environment DIRECTORY_DOWNLOADS mDownloadTextView setText Constants EXTERNAL_STORAGE '' Environment DIRECTORY_DOWNLOADS break case 2 downPicker break picker setNeutralButton getResources getString R string action_ok , new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which picker show 
SuppressWarnings "deprecation" public void downPicker final AlertDialog Builder downLocationPicker new AlertDialog Builder mActivity LinearLayout layout new LinearLayout this downLocationPicker setTitle getResources getString R string title_download_location final EditText getDownload new EditText this getDownload setBackgroundResource 0 mDownloadLocation mPreferences getDownloadDirectory int padding Utils convertDpToPixels 10 LinearLayout LayoutParams lparams new LinearLayout LayoutParams LinearLayout LayoutParams MATCH_PARENT, LinearLayout LayoutParams MATCH_PARENT getDownload setLayoutParams lparams getDownload setTextColor Color DKGRAY getDownload setText mDownloadLocation getDownload setPadding 0, padding, padding, padding TextView v new TextView this v setTextSize TypedValue COMPLEX_UNIT_SP, 18 v setTextColor Color DKGRAY v setText Constants EXTERNAL_STORAGE '' v setPadding padding, padding, 0, padding layout addView v layout addView getDownload if API 16 layout setBackgroundDrawable getResources getDrawable android R drawable edit_text else layout setBackground getResources getDrawable android R drawable edit_text downLocationPicker setView layout downLocationPicker setPositiveButton getResources getString R string action_ok , new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which String text getDownload getText toString mPreferences setDownloadDirectory text mDownloadTextView setText Constants EXTERNAL_STORAGE '' text downLocationPicker show 
public void homepage RelativeLayout view view setOnClickListener new OnClickListener Override public void onClick View v AlertDialog Builder picker new AlertDialog Builder mActivity picker setTitle getResources getString R string home mHomepage mPreferences getHomepage int n if mHomepage contains "abouthome" n 1 else if mHomepage contains "aboutblank" n 2 else if mHomepage contains "aboutbookmarks" n 3 else n 4 picker setSingleChoiceItems R array homepage, n 1, new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which switch which 1 case 1 mPreferences setHomepage "abouthome" mHomepageText setText getResources getString R string action_homepage break case 2 mPreferences setHomepage "aboutblank" mHomepageText setText getResources getString R string action_blank break case 3 mPreferences setHomepage "aboutbookmarks" mHomepageText setText getResources getString R string action_bookmarks break case 4 homePicker break picker setNeutralButton getResources getString R string action_ok , new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which picker show 
public void homePicker final AlertDialog Builder homePicker new AlertDialog Builder mActivity homePicker setTitle getResources getString R string title_custom_homepage final EditText getHome new EditText this mHomepage mPreferences getHomepage if mHomepage startsWith "about" getHome setText mHomepage else getHome setText "httpwww google com" homePicker setView getHome homePicker setPositiveButton getResources getString R string action_ok , new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which String text getHome getText toString mPreferences setHomepage text mHomepageText setText text homePicker show 
private void initialize mSearchText TextView findViewById R id searchText switch mPreferences getSearchChoice case 0 mSearchText setText getResources getString R string custom_url break case 1 mSearchText setText "Google" break case 2 mSearchText setText "Ask" break case 3 mSearchText setText "Bing" break case 4 mSearchText setText "Yahoo" break case 5 mSearchText setText "StartPage" break case 6 mSearchText setText "StartPage Mobile " break case 7 mSearchText setText "DuckDuckGo" break case 8 mSearchText setText "DuckDuckGo Lite" break case 9 mSearchText setText "Baidu" break case 10 mSearchText setText "Yandex" mAgentTextView TextView findViewById R id agentText mHomepageText TextView findViewById R id homepageText mDownloadTextView TextView findViewById R id downloadText mAgentChoice mPreferences getUserAgentChoice mHomepage mPreferences getHomepage mDownloadLocation mPreferences getDownloadDirectory mDownloadTextView setText Constants EXTERNAL_STORAGE '' mDownloadLocation if mHomepage contains "abouthome" mHomepageText setText getResources getString R string action_homepage else if mHomepage contains "aboutblank" mHomepageText setText getResources getString R string action_blank else if mHomepage contains "aboutbookmarks" mHomepageText setText getResources getString R string action_bookmarks else mHomepageText setText mHomepage switch mAgentChoice case 1 mAgentTextView setText getResources getString R string agent_default break case 2 mAgentTextView setText getResources getString R string agent_desktop break case 3 mAgentTextView setText getResources getString R string agent_mobile break case 4 mAgentTextView setText getResources getString R string agent_custom RelativeLayout rSearchSuggestions rSearchSuggestions RelativeLayout findViewById R id rGoogleSuggestions cbSearchSuggestions CheckBox findViewById R id cbGoogleSuggestions cbSearchSuggestions setChecked mPreferences getGoogleSearchSuggestionsEnabled RelativeLayout agent RelativeLayout findViewById R id layoutUserAgent RelativeLayout download RelativeLayout findViewById R id layoutDownload RelativeLayout homepage RelativeLayout findViewById R id layoutHomepage agent agent download download homepage homepage search rSearchSuggestions rSearchSuggestions cbSearchSuggestions cbSearchSuggestions 
Override protected void onCreate Bundle savedInstanceState super onCreate savedInstanceState setContentView R layout general_settings set up ActionBar Toolbar toolbar Toolbar findViewById R id toolbar setSupportActionBar toolbar getSupportActionBar setDisplayHomeAsUpEnabled true mPreferences PreferenceManager getInstance mActivity this initialize 
Override public boolean onOptionsItemSelected MenuItem item finish return true 
private void rSearchSuggestions RelativeLayout view view setOnClickListener new OnClickListener Override public void onClick View arg0 cbSearchSuggestions setChecked cbSearchSuggestions isChecked 
public void search RelativeLayout search RelativeLayout findViewById R id layoutSearch search setOnClickListener new OnClickListener Override public void onClick View v AlertDialog Builder picker new AlertDialog Builder mActivity picker setTitle getResources getString R string title_search_engine CharSequence[] chars getResources getString R string custom_url , "Google", "Ask", "Bing", "Yahoo", "StartPage", "StartPage Mobile ", "DuckDuckGo Privacy ", "DuckDuckGo Lite Privacy ", "Baidu Chinese ", "Yandex Russian " int n mPreferences getSearchChoice picker setSingleChoiceItems chars, n, new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which mPreferences setSearchChoice which switch which case 0 searchUrlPicker break case 1 mSearchText setText "Google" break case 2 mSearchText setText "Ask" break case 3 mSearchText setText "Bing" break case 4 mSearchText setText "Yahoo" break case 5 mSearchText setText "StartPage" break case 6 mSearchText setText "StartPage Mobile " break case 7 mSearchText setText "DuckDuckGo" break case 8 mSearchText setText "DuckDuckGo Lite" break case 9 mSearchText setText "Baidu" break case 10 mSearchText setText "Yandex" picker setNeutralButton getResources getString R string action_ok , new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which picker show 
public void searchUrlPicker final AlertDialog Builder urlPicker new AlertDialog Builder this urlPicker setTitle getResources getString R string custom_url final EditText getSearchUrl new EditText this String mSearchUrl mPreferences getSearchUrl getSearchUrl setText mSearchUrl urlPicker setView getSearchUrl urlPicker setPositiveButton getResources getString R string action_ok , new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which String text getSearchUrl getText toString mPreferences setSearchUrl text mSearchText setText getResources getString R string custom_url " " text urlPicker show 
public synchronized void addHistoryItem HistoryItem item ContentValues values new ContentValues values put KEY_URL, item getUrl values put KEY_TITLE, item getTitle values put KEY_TIME_VISITED, System currentTimeMillis mDatabase insert TABLE_HISTORY, null, values 
Override public synchronized void close if mDatabase null mDatabase close super close 
public synchronized void deleteHistoryItem String url mDatabase delete TABLE_HISTORY, KEY_URL " ?", new String[] url 
public ListHistoryItem findItemsContaining String search ListHistoryItem itemList new ArrayList String selectQuery "SELECT FROM " TABLE_HISTORY " WHERE " KEY_TITLE " LIKE '" search "' OR " KEY_URL " LIKE '" search "' " "ORDER BY " KEY_TIME_VISITED " DESC LIMIT 5" Cursor cursor mDatabase rawQuery selectQuery, null int n 0 if cursor moveToFirst do HistoryItem item new HistoryItem item setID Integer parseInt cursor getString 0 item setUrl cursor getString 1 item setTitle cursor getString 2 item setImageId R drawable ic_history itemList add item n while cursor moveToNext n 5 cursor close return itemList 
public ListHistoryItem getAllHistoryItems ListHistoryItem itemList new ArrayList String selectQuery "SELECT FROM " TABLE_HISTORY " ORDER BY " KEY_TIME_VISITED " DESC" Cursor cursor mDatabase rawQuery selectQuery, null if cursor moveToFirst do HistoryItem item new HistoryItem item setID Integer parseInt cursor getString 0 item setUrl cursor getString 1 item setTitle cursor getString 2 item setImageId R drawable ic_history itemList add item while cursor moveToNext cursor close return itemList 
String getHistoryItem String url Cursor cursor mDatabase query TABLE_HISTORY, new String[] KEY_ID, KEY_URL, KEY_TITLE , KEY_URL " ?", new String[] url , null, null, null, null String m null if cursor null cursor moveToFirst m cursor getString 0 cursor close return m 
public int getHistoryItemsCount String countQuery "SELECT FROM " TABLE_HISTORY Cursor cursor mDatabase rawQuery countQuery, null int n cursor getCount cursor close return n 
public static HistoryDatabase getInstance Context context if mInstance null mInstance isClosed mInstance new HistoryDatabase context return mInstance 
public ListHistoryItem getLastHundredItems ListHistoryItem itemList new ArrayList String selectQuery "SELECT FROM " TABLE_HISTORY " ORDER BY " KEY_TIME_VISITED " DESC" Cursor cursor mDatabase rawQuery selectQuery, null int counter 0 if cursor moveToFirst do HistoryItem item new HistoryItem item setID Integer parseInt cursor getString 0 item setUrl cursor getString 1 item setTitle cursor getString 2 item setImageId R drawable ic_history itemList add item counter while cursor moveToNext counter 100 cursor close return itemList 
private HistoryDatabase Context context super context getApplicationContext , DATABASE_NAME, null, DATABASE_VERSION mDatabase this getWritableDatabase 
public boolean isClosed return mDatabase null mDatabase isOpen 
Override public void onCreate SQLiteDatabase db String CREATE_HISTORY_TABLE "CREATE TABLE " TABLE_HISTORY " " KEY_ID " INTEGER PRIMARY KEY," KEY_URL " TEXT," KEY_TITLE " TEXT," KEY_TIME_VISITED " INTEGER" " " db execSQL CREATE_HISTORY_TABLE 
Override public void onUpgrade SQLiteDatabase db, int oldVersion, int newVersion Drop older table if it exists db execSQL "DROP TABLE IF EXISTS " TABLE_HISTORY Create tables again onCreate db 
public synchronized int updateHistoryItem HistoryItem item ContentValues values new ContentValues values put KEY_URL, item getUrl values put KEY_TITLE, item getTitle values put KEY_TIME_VISITED, System currentTimeMillis return mDatabase update TABLE_HISTORY, values, KEY_ID " ?", new String[] String valueOf item getId 
public synchronized void visitHistoryItem String url, String title ContentValues values new ContentValues values put KEY_TITLE, title values put KEY_TIME_VISITED, System currentTimeMillis Cursor q mDatabase query false, TABLE_HISTORY, new String[] KEY_URL , KEY_URL " ?", new String[] url , null, null, null, "1" if q getCount 0 mDatabase update TABLE_HISTORY, values, KEY_URL " ?", new String[] url else addHistoryItem new HistoryItem url, title q close 
Override public int compareTo NonNull HistoryItem another return mTitle compareTo another mTitle 
Override public boolean equals Object o if this o return true if o null Object this getClass o getClass return false HistoryItem that HistoryItem o if mId that mId return false if mImageId that mImageId return false if mBitmap null ? mBitmap equals that mBitmap that mBitmap null return false return mTitle equals that mTitle mUrl equals that mUrl 
public Bitmap getBitmap return mBitmap 
public String getFolder return mFolder 
public int getId return this mId 
public int getImageId return this mImageId 
public int getOrder return mOrder 
public String getTitle return this mTitle 
public String getUrl return this mUrl 
Override public int hashCode int result mId result 31 result mUrl hashCode result 31 result mTitle hashCode result 31 result mBitmap null ? mBitmap hashCode 0 result 31 result mImageId return result 
public HistoryItem String url, String title, int imageId this mUrl url this mTitle title this mBitmap null this mImageId imageId 
public void setBitmap Bitmap image mBitmap image 
public void setFolder String folder mFolder folder null ? "" folder 
public void setID int id this mId id 
public void setImageId int id this mImageId id 
public void setOrder int order mOrder order 
public void setTitle String title this mTitle title null ? "" title 
public void setUrl String url this mUrl url null ? "" url 
Override public String toString return mTitle 
public static String getHistoryPage Context context StringBuilder historyBuilder new StringBuilder historyBuilder append HistoryPage HEADING ListHistoryItem historyList getWebHistory context IteratorHistoryItem it historyList iterator HistoryItem helper while it hasNext helper it next historyBuilder append HistoryPage PART1 historyBuilder append helper getUrl historyBuilder append HistoryPage PART2 historyBuilder append helper getTitle historyBuilder append HistoryPage PART3 historyBuilder append helper getUrl historyBuilder append HistoryPage PART4 historyBuilder append HistoryPage END File historyWebPage new File context getFilesDir , FILENAME try FileWriter historyWriter new FileWriter historyWebPage, false historyWriter write historyBuilder toString historyWriter close catch IOException e e printStackTrace return Constants FILE historyWebPage 
private static ListHistoryItem getWebHistory Context context HistoryDatabase databaseHandler HistoryDatabase getInstance context getApplicationContext return databaseHandler getLastHundredItems 
public HtmlFetcher clearCacheCounter cacheCounter set 0 return this 
public Converter createConverter String url return new Converter url 
protected HttpURLConnection createUrlConnection String urlAsStr, int timeout, boolean includeSomeGooseOptions throws IOException URL url new URL urlAsStr using proxy may increase latency HttpURLConnection hConn HttpURLConnection url openConnection Proxy NO_PROXY hConn setRequestProperty "UserAgent", userAgent hConn setRequestProperty "Accept", accept if includeSomeGooseOptions hConn setRequestProperty "AcceptLanguage", language hConn setRequestProperty "contentcharset", charset hConn addRequestProperty "Referer", referrer avoid the cache for testing purposes only? hConn setRequestProperty "CacheControl", cacheControl suggest respond to be gzipped or deflated which is just another compression httpstackoverflow comq3932117 hConn setRequestProperty "AcceptEncoding", "gzip, deflate" hConn setConnectTimeout timeout hConn setReadTimeout timeout return hConn 
Takes a URI that was decoded as ISO88591 and applies percentencoding to nonASCII characters Workaround for broken origin servers that send UTF8 in the Location header static String encodeUriFromHeader String badLocation StringBuilder sb new StringBuilder for char ch badLocation toCharArray if ch char 128 sb append ch else this is ONLY valid if the uri was decoded using ISO88591 sb append String format "02X", int ch return sb toString 
public JResult fetchAndExtract String url, int timeout, boolean resolve throws Exception String originalUrl url url SHelper removeHashbang url String gUrl SHelper getUrlFromUglyGoogleRedirect url if gUrl null url gUrl else gUrl SHelper getUrlFromUglyFacebookRedirect url if gUrl null url gUrl if resolve check if we can avoid resolving the URL which hits the website JResult res getFromCache url, originalUrl if res null return res String resUrl getResolvedUrl url, timeout if resUrl isEmpty Log d Constants TAG, "resolved url is empty Url is " url JResult result new JResult if cache null cache put url, result return result setUrl url if resolved url is longer then use it if resUrl null resUrl trim length url length this is necessary e g for some homebaken url resolvers which return the resolved url relative to url url SHelper useDomainOfFirstArg4Second url, resUrl check if we have the resolved URL in cache JResult res getFromCache url, originalUrl if res null return res JResult result new JResult or should we use? link rel"canonical" href"httpwww N24 denewsnewsitem_6797232 html" result setUrl url result setOriginalUrl originalUrl result setDate SHelper estimateDate url Immediately put the url into the cache as extracting content takes time if cache null cache put originalUrl, result cache put url, result String lowerUrl url toLowerCase Locale getDefault if SHelper isDoc lowerUrl SHelper isApp lowerUrl SHelper isPackage lowerUrl skip else if SHelper isVideo lowerUrl SHelper isAudio lowerUrl result setVideoUrl url else if SHelper isImage lowerUrl result setImageUrl url else extractor extractContent result, fetchAsString url, timeout if result getFaviconUrl isEmpty result setFaviconUrl SHelper getDefaultFavicon url some links are relative to root and do not include the domain of the url result setFaviconUrl fixUrl url, result getFaviconUrl result setImageUrl fixUrl url, result getImageUrl result setVideoUrl fixUrl url, result getVideoUrl result setRssUrl fixUrl url, result getRssUrl result setText lessText result getText synchronized result result notifyAll return result 
public String fetchAsString String urlAsString, int timeout, boolean includeSomeGooseOptions throws IOException HttpURLConnection hConn createUrlConnection urlAsString, timeout, includeSomeGooseOptions hConn setInstanceFollowRedirects true String encoding hConn getContentEncoding InputStream is if encoding null encoding equalsIgnoreCase "gzip" is new GZIPInputStream hConn getInputStream else if encoding null encoding equalsIgnoreCase "deflate" is new InflaterInputStream hConn getInputStream , new Inflater true else is hConn getInputStream String enc Converter extractEncoding hConn getContentType String res createConverter urlAsString streamToString is, enc Log d Constants TAG, res length " FetchAsString" urlAsString return res 
private static String fixUrl String url, String urlOrPath return SHelper useDomainOfFirstArg4Second url, urlOrPath 
public String getAccept return accept 
public SCache getCache return cache 
public String getCacheControl return cacheControl 
public int getCacheCounter return cacheCounter get 
public String getCharset return charset 
public ArticleTextExtractor getExtractor return extractor 
private JResult getFromCache String url, String originalUrl throws Exception if cache null JResult res cache get url if res null e g the cache returned a shortened url as original url now we want to store the current original url Also it can be that the cache response to url but the JResult does not contain it so overwrite it res setUrl url res setOriginalUrl originalUrl cacheCounter addAndGet 1 return res return null 
public String getLanguage return language 
public int getMaxTextLength return maxTextLength 
public String getReferrer return referrer 
On some devices we have to hack httpdevelopers sun commobilityreference techartdesign_guidelineshttp_redirection html param timeout Sets a specified timeout value, in milliseconds return the resolved url if any Or null if it couldn't resolve the url within the specified time or the same url if response code is OK public String getResolvedUrl String urlAsString, int timeout String newUrl null int responseCode 1 try HttpURLConnection hConn createUrlConnection urlAsString, timeout, true force no follow hConn setInstanceFollowRedirects false the program doesn't care what the content actually is httpjava sun comdeveloperJDCTechTips2003tt0422 html hConn setRequestMethod "HEAD" hConn connect responseCode hConn getResponseCode hConn getInputStream close if responseCode HttpURLConnection HTTP_OK return urlAsString newUrl hConn getHeaderField "Location" if responseCode 100 3 newUrl null newUrl newUrl replaceAll " ", "" some services use nonestandard utf8 in their location header if urlAsString startsWith "httpbit ly" urlAsString startsWith "httpis gd" newUrl encodeUriFromHeader newUrl fix problems if shortened twice as it is often the case after twitters' t co bullshit if furtherResolveNecessary contains SHelper extractDomain newUrl, true newUrl getResolvedUrl newUrl, timeout return newUrl else return urlAsString catch Exception ex Log e Constants TAG, "getResolvedUrl" urlAsString " Error" ex getMessage return "" finally Log e Constants TAG, responseCode " url" urlAsString " resolved" newUrl 
public String getUserAgent return userAgent 
public String lessText String text if text null return "" if maxTextLength 0 text length maxTextLength return text substring 0, maxTextLength return text 
public static void main String[] args throws Exception BufferedReader reader new BufferedReader new FileReader "urls txt" String line SetString existing new LinkedHashSet while line reader readLine null int index1 line indexOf "\"" int index2 line indexOf "\"", index1 1 String url line substring index1 1, index2 String domainStr SHelper extractDomain url, true String counterStr "" TODO more similarities if existing contains domainStr counterStr "2" else existing add domainStr String html new HtmlFetcher fetchAsString url, 20000 String outFile domainStr counterStr " html" BufferedWriter writer new BufferedWriter new FileWriter outFile writer write html writer close reader close 
public void setAccept String accept this accept accept 
public HtmlFetcher setCache SCache cache this cache cache return this 
public void setCacheControl String cacheControl this cacheControl cacheControl 
public void setCharset String charset this charset charset 
public void setExtractor ArticleTextExtractor extractor this extractor extractor 
public void setLanguage String language this language language 
public HtmlFetcher setMaxTextLength int maxTextLength this maxTextLength maxTextLength return this 
public HtmlFetcher setReferrer String referrer this referrer referrer return this 
public void setUserAgent String userAgent this userAgent userAgent 
public static String doGet Context context, String serviceEndpoint, Properties props throws Exception HttpClient httpClient new StrongHttpsClient context StringBuilder uriBuilder new StringBuilder serviceEndpoint StringBuffer sbResponse new StringBuffer EnumerationObject enumProps props keys String key, value null uriBuilder append '?' while enumProps hasMoreElements key String enumProps nextElement value String props get key uriBuilder append key uriBuilder append '' uriBuilder append java net URLEncoder encode value uriBuilder append '' HttpGet request new HttpGet uriBuilder toString HttpResponse response httpClient execute request int status response getStatusLine getStatusCode we assume that the response body contains the error message if status HttpStatus SC_OK ByteArrayOutputStream ostream new ByteArrayOutputStream response getEntity writeTo ostream Log e "HTTP CLIENT", ostream toString return null else InputStream content response getEntity getContent consume response BufferedReader reader new BufferedReader new InputStreamReader content String line while line reader readLine null sbResponse append line content close this will also close the connection return sbResponse toString 
public static String doPost Context context, String serviceEndpoint, Properties props throws Exception DefaultHttpClient httpClient new StrongHttpsClient context HttpPost request new HttpPost serviceEndpoint HttpResponse response null HttpEntity entity null StringBuffer sbResponse new StringBuffer EnumerationObject enumProps props keys String key, value null ListNameValuePair nvps new ArrayListNameValuePair while enumProps hasMoreElements key String enumProps nextElement value String props get key nvps add new BasicNameValuePair key, value Log i TAG, "adding nvp" key "" value UrlEncodedFormEntity uf new UrlEncodedFormEntity nvps, HTTP UTF_8 Log i TAG, uf toString request setEntity uf request setHeader "ContentType", POST_MIME_TYPE Log i TAG, "http post request " request toString Post, check and show the result not really spectacular, but works response httpClient execute request entity response getEntity int status response getStatusLine getStatusCode we assume that the response body contains the error message if status HttpStatus SC_OK ByteArrayOutputStream ostream new ByteArrayOutputStream entity writeTo ostream Log e TAG, " error status code" status Log e TAG, ostream toString return null else InputStream content response getEntity getContent consume response BufferedReader reader new BufferedReader new InputStreamReader content String line while line reader readLine null sbResponse append line content close this will also close the connection return sbResponse toString 
public static String uploadFile String serviceEndpoint, Properties properties, String fileParam, String file throws Exception HttpClient httpClient new DefaultHttpClient HttpPost request new HttpPost serviceEndpoint MultipartEntityBuilder entity MultipartEntityBuilder create IteratorMap EntryObject, Object i properties entrySet iterator while i hasNext Map EntryObject, Object entry Map EntryObject, Object i next String key String entry getKey String val String entry getValue entity addPart key, new StringBody val File upload new File file Log i "httpman", "upload file " upload getAbsolutePath " size" upload length entity addPart fileParam, new FileBody upload request setEntity entity build HttpResponse response httpClient execute request int status response getStatusLine getStatusCode if status HttpStatus SC_OK else return response toString 
public ImageResult String src, Integer weight, String title, int height, int width, String alt, boolean noFollow this src src this weight weight this title title this height height this width width this alt alt this noFollow noFollow 
Override public void closeActivity closeDrawers finish 
Override public int getMenu return R menu incognito 
Override public synchronized void initializeTabs super initializeTabs restoreOrNewTab newTab null, true if incognito mode use newTab null, true instead 
Override public boolean isIncognito return true 
Override protected void onCreate Bundle savedInstanceState super onCreate savedInstanceState 
Override public boolean onCreateOptionsMenu Menu menu getMenuInflater inflate R menu incognito, menu return super onCreateOptionsMenu menu 
Override protected void onNewIntent Intent intent handleNewIntent intent super onNewIntent intent 
Override protected void onPause super onPause saveOpenTabs 
Override public void updateCookiePreference mCookieManager CookieManager getInstance if Build VERSION SDK_INT Build VERSION_CODES LOLLIPOP CookieSyncManager createInstance this mCookieManager setAcceptCookie PreferenceManager getInstance getIncognitoCookiesEnabled super updateCookiePreference 
Override public void updateHistory String title, String url super updateHistory title, url addItemToHistory title, url 
public IntentUtils BrowserController controller mActivity controller getActivity 
Search for intent handlers that are specific to this URL aka, specialized apps like google maps or youtube private boolean isSpecializedHandlerAvailable Intent intent PackageManager pm mActivity getPackageManager ListResolveInfo handlers pm queryIntentActivities intent, PackageManager GET_RESOLVED_FILTER if handlers null handlers isEmpty return false for ResolveInfo resolveInfo handlers IntentFilter filter resolveInfo filter if filter null No intent filter matches this intent? Error on the side of staying in the browser, ignore continue NOTICE Use of instead of will cause the browser to launch a new intent for every URL, using OR only launches a new one if there is a nonbrowser app that can handle it if filter countDataAuthorities 0 filter countDataPaths 0 Generic handler, skip continue return true return false 
public boolean startActivityForUrl WebView tab, String url Intent intent try intent Intent parseUri url, Intent URI_INTENT_SCHEME catch URISyntaxException ex Log w "Browser", "Bad URI " url " " ex getMessage return false if mActivity getPackageManager resolveActivity intent, 0 null String packagename intent getPackage if packagename null intent new Intent Intent ACTION_VIEW, Uri parse "marketsearch?qpname" packagename intent addCategory Intent CATEGORY_BROWSABLE mActivity startActivity intent return true else return false intent addCategory Intent CATEGORY_BROWSABLE intent setComponent null if tab null intent putExtra mActivity getPackageName " Origin", 1 Matcher m ACCEPTED_URI_SCHEMA matcher url if m matches isSpecializedHandlerAvailable intent return false try if mActivity startActivityIfNeeded intent, 1 return true catch ActivityNotFoundException ex ex printStackTrace return false 
public String getCanonicalUrl return canonicalUrl 
return get date from url or guessed from text public String getDate return dateString 
public String getDescription if description null return "" return description 
public String getFaviconUrl if faviconUrl null return "" return faviconUrl 
return images list public ListImageResult getImages if images null return Collections emptyList return images 
return images count public int getImagesCount if images null return 0 return images size 
public String getImageUrl if imageUrl null return "" return imageUrl 
public CollectionString getKeywords return keywords 
public String getOriginalUrl return originalUrl 
public String getRssUrl if rssUrl null return "" return rssUrl 
public String getText if text null return "" return text 
public ListString getTextList if this textList null return new ArrayList return this textList 
public String getTitle if title null return "" return title 
public String getUrl if url null return "" return url 
public String getVideoUrl if videoUrl null return "" return videoUrl 
public JResult setCanonicalUrl String canonicalUrl this canonicalUrl canonicalUrl return this 
public JResult setDate String date this dateString date return this 
public JResult setDescription String description this description description return this 
public JResult setFaviconUrl String faviconUrl this faviconUrl faviconUrl return this 
set images list public void setImages ListImageResult images this images images 
public JResult setImageUrl String imageUrl this imageUrl imageUrl return this 
public void setKeywords CollectionString keywords this keywords keywords 
public JResult setOriginalUrl String originalUrl this originalUrl originalUrl return this 
public JResult setRssUrl String rssUrl this rssUrl rssUrl return this 
public JResult setText String text this text text return this 
public JResult setTextList ListString textList this textList textList return this 
public JResult setTitle String title this title title return this 
public JResult setUrl String url this url url return this 
public JResult setVideoUrl String videoUrl this videoUrl videoUrl return this 
Override public String toString return "title" getTitle " imageUrl" getImageUrl " text" text 
private void actionView String url startActivity new Intent Intent ACTION_VIEW, Uri parse url , this, MainActivity class finish 
Override public void onClick View v switch v getId case R id browserLicense actionView "httpwww mozilla orgMPL2 0" break case R id licenseAOSP actionView "httpwww apache orglicensesLICENSE2 0" break case R id licenseHosts actionView "httphostsfile net" break case R id licenseOrbot actionView "httpwww gnu orglicenseslgpl html" break case R id licenseSnactory actionView "httpwww apache orglicensesLICENSE2 0" break case R id licenseJsoup actionView "httpjsoup orglicense" break 
Override protected void onCreate Bundle savedInstanceState super onCreate savedInstanceState setContentView R layout license_activity Toolbar toolbar Toolbar findViewById R id toolbar setSupportActionBar toolbar getSupportActionBar setDisplayHomeAsUpEnabled true findViewById R id browserLicense setOnClickListener this findViewById R id licenseAOSP setOnClickListener this findViewById R id licenseHosts setOnClickListener this findViewById R id licenseOrbot setOnClickListener this findViewById R id licenseSnactory setOnClickListener this findViewById R id licenseJsoup setOnClickListener this 
Override public boolean onOptionsItemSelected MenuItem item finish return super onOptionsItemSelected item 
public LightningDownloadListener Activity activity mActivity activity 
Override public void onDownloadStart final String url, final String userAgent, final String contentDisposition, final String mimetype, long contentLength String fileName URLUtil guessFileName url, contentDisposition, mimetype DialogInterface OnClickListener dialogClickListener new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which switch which case DialogInterface BUTTON_POSITIVE DownloadHandler onDownloadStart mActivity, url, userAgent, contentDisposition, mimetype, false break case DialogInterface BUTTON_NEGATIVE break AlertDialog Builder builder new AlertDialog Builder mActivity dialog builder setTitle fileName setMessage mActivity getResources getString R string dialog_download setPositiveButton mActivity getResources getString R string action_download , dialogClickListener setNegativeButton mActivity getResources getString R string action_cancel , dialogClickListener show Log i Constants TAG, "Downloading" fileName 
private void cacheFavicon Bitmap icon String hash String valueOf Utils getDomainName getUrl hashCode Log d Constants TAG, "Caching icon for " Utils getDomainName getUrl File image new File mActivity getCacheDir , hash " png" try FileOutputStream fos new FileOutputStream image icon compress Bitmap CompressFormat PNG, 100, fos fos flush fos close catch IOException e e printStackTrace 
public boolean canGoBack return mWebView null mWebView canGoBack 
public boolean canGoForward return mWebView null mWebView canGoForward 
public void clearCache boolean disk if mWebView null mWebView clearCache disk 
SuppressWarnings "deprecation" SuppressLint "NewApi" public synchronized void find String text if mWebView null if API 16 mWebView findAllAsync text else mWebView findAll text 
public Activity getActivity return mActivity 
public Bitmap getFavicon return mTitle getFavicon 
public String getHomepage StringBuilder homepageBuilder new StringBuilder homepageBuilder append StartPage HEAD String icon String searchUrl switch mPreferences getSearchChoice case 0 CUSTOM SEARCH icon "fileandroid_assetlightning png" searchUrl mPreferences getSearchUrl break case 1 GOOGLE_SEARCH icon "fileandroid_assetgoogle png" "httpswww google comimagessrprlogo11w png" searchUrl Constants GOOGLE_SEARCH break case 2 ANDROID SEARCH icon "fileandroid_assetask png" searchUrl Constants ASK_SEARCH break case 3 BING_SEARCH icon "fileandroid_assetbing png" "httpupload wikimedia orgwikipediacommonsthumbbb1Bing_logo_28201329 svg500pxBing_logo_28201329 svg png" searchUrl Constants BING_SEARCH break case 4 YAHOO_SEARCH icon "fileandroid_assetyahoo png" "httpupload wikimedia orgwikipediacommonsthumb224Yahoo21_logo svg799pxYahoo21_logo svg png" searchUrl Constants YAHOO_SEARCH break case 5 STARTPAGE_SEARCH icon "fileandroid_assetstartpage png" "httpsstartpage comgraphicsstartp_logo gif" searchUrl Constants STARTPAGE_SEARCH break case 6 STARTPAGE_MOBILE icon "fileandroid_assetstartpage png" "httpsstartpage comgraphicsstartp_logo gif" searchUrl Constants STARTPAGE_MOBILE_SEARCH break case 7 DUCK_SEARCH icon "fileandroid_assetduckduckgo png" "httpsduckduckgo comassetslogo_homepage normal v101 png" searchUrl Constants DUCK_SEARCH break case 8 DUCK_LITE_SEARCH icon "fileandroid_assetduckduckgo png" "httpsduckduckgo comassetslogo_homepage normal v101 png" searchUrl Constants DUCK_LITE_SEARCH break case 9 BAIDU_SEARCH icon "fileandroid_assetbaidu png" "httpwww baidu comimgbdlogo gif" searchUrl Constants BAIDU_SEARCH break case 10 YANDEX_SEARCH icon "fileandroid_assetyandex png" "httpupload wikimedia orgwikipediacommonsthumb991Yandex svg600pxYandex svg png" searchUrl Constants YANDEX_SEARCH break default DEFAULT GOOGLE_SEARCH icon "fileandroid_assetgoogle png" searchUrl Constants GOOGLE_SEARCH break homepageBuilder append icon homepageBuilder append StartPage MIDDLE homepageBuilder append searchUrl homepageBuilder append StartPage END File homepage new File mActivity getFilesDir , "homepage html" try FileWriter hWriter new FileWriter homepage, false hWriter write homepageBuilder toString hWriter close catch IOException e e printStackTrace return Constants FILE homepage 
public int getProgress if mWebView null return mWebView getProgress else return 100 
public String getTitle return mTitle getTitle 
public String getUrl if mWebView null return mWebView getUrl else return "" 
public String getUserAgent if mWebView null return mWebView getSettings getUserAgentString else return "" 
public WebView getWebView return mWebView 
public synchronized void goBack if mWebView null mWebView goBack 
public synchronized void goForward if mWebView null mWebView goForward 
SuppressWarnings "deprecation" SuppressLint "NewApi", "SetJavaScriptEnabled" public synchronized void initializePreferences Context context mPreferences PreferenceManager getInstance mHomepage mPreferences getHomepage mAdBlock updatePreference if mSettings null mWebView null mSettings mWebView getSettings else if mSettings null return setColorMode mPreferences getRenderingMode if mBrowserController isIncognito mSettings setGeolocationEnabled mPreferences getLocationEnabled else mSettings setGeolocationEnabled false if API 19 switch mPreferences getFlashSupport case 0 mSettings setPluginState PluginState OFF break case 1 mSettings setPluginState PluginState ON_DEMAND break case 2 mSettings setPluginState PluginState ON break default break switch mPreferences getUserAgentChoice case 1 if API 16 mSettings setUserAgentString WebSettings getDefaultUserAgent context else mSettings setUserAgentString mDefaultUserAgent break case 2 mSettings setUserAgentString Constants DESKTOP_USER_AGENT break case 3 mSettings setUserAgentString Constants MOBILE_USER_AGENT break case 4 mSettings setUserAgentString mPreferences getUserAgentString mDefaultUserAgent break if mPreferences getSavePasswordsEnabled mBrowserController isIncognito if API 18 mSettings setSavePassword true mSettings setSaveFormData true else if API 18 mSettings setSavePassword false mSettings setSaveFormData false if mPreferences getJavaScriptEnabled mSettings setJavaScriptEnabled true mSettings setJavaScriptCanOpenWindowsAutomatically true if mPreferences getTextReflowEnabled mTextReflow true mSettings setLayoutAlgorithm LayoutAlgorithm NARROW_COLUMNS if API android os Build VERSION_CODES KITKAT try mSettings setLayoutAlgorithm LayoutAlgorithm TEXT_AUTOSIZING catch Exception e This shouldn't be necessary, but there are a number of KitKat devices that crash trying to set this Log e Constants TAG, "Problem setting LayoutAlgorithm to TEXT_AUTOSIZING" else mTextReflow false mSettings setLayoutAlgorithm LayoutAlgorithm NORMAL mSettings setBlockNetworkImage mPreferences getBlockImagesEnabled mSettings setSupportMultipleWindows mPreferences getPopupsEnabled mSettings setUseWideViewPort mPreferences getUseWideViewportEnabled mSettings setLoadWithOverviewMode mPreferences getOverviewModeEnabled switch mPreferences getTextSize case 1 mSettings setTextZoom 200 break case 2 mSettings setTextZoom 150 break case 3 mSettings setTextZoom 100 break case 4 mSettings setTextZoom 75 break case 5 mSettings setTextZoom 50 break if Build VERSION SDK_INT Build VERSION_CODES LOLLIPOP CookieManager getInstance setAcceptThirdPartyCookies mWebView, mPreferences getBlockThirdPartyCookiesEnabled 
SuppressWarnings "deprecation" SuppressLint "SetJavaScriptEnabled", "NewApi" public void initializeSettings WebSettings settings, Context context if API 18 settings setAppCacheMaxSize Long MAX_VALUE if API 17 settings setEnableSmoothTransition true if API 16 settings setMediaPlaybackRequiresUserGesture true if API Build VERSION_CODES LOLLIPOP mBrowserController isIncognito settings setMixedContentMode WebSettings MIXED_CONTENT_COMPATIBILITY_MODE else if API Build VERSION_CODES LOLLIPOP We're in Incognito mode, reject settings setMixedContentMode WebSettings MIXED_CONTENT_NEVER_ALLOW settings setDomStorageEnabled true settings setAppCacheEnabled true settings setCacheMode WebSettings LOAD_DEFAULT settings setDatabaseEnabled true settings setSupportZoom true settings setBuiltInZoomControls true settings setDisplayZoomControls false settings setAllowContentAccess true settings setAllowFileAccess true settings setDefaultTextEncodingName "utf8" if API 16 settings setAllowFileAccessFromFileURLs false settings setAllowUniversalAccessFromFileURLs false settings setAppCachePath context getDir "appcache", 0 getPath settings setGeolocationDatabasePath context getDir "geolocation", 0 getPath if API Build VERSION_CODES KITKAT settings setDatabasePath context getDir "databases", 0 getPath 
public synchronized void invalidate if mWebView null mWebView invalidate 
public boolean isForegroundTab return isForegroundTab 
public boolean isShown return mWebView null mWebView isShown 
SuppressWarnings "deprecation" SuppressLint "NewApi" public LightningView Activity activity, String url, boolean darkTheme mActivity activity mWebView new WebView activity mTitle new Title activity, darkTheme mAdBlock AdBlock getInstance activity getApplicationContext mWebpageBitmap Utils getWebpageBitmap activity getResources , darkTheme try mBrowserController BrowserController activity catch ClassCastException e throw new ClassCastException activity " must implement BrowserController" mIntentUtils new IntentUtils mBrowserController mWebView setDrawingCacheBackgroundColor 0x00000000 mWebView setFocusableInTouchMode true mWebView setFocusable true mWebView setAnimationCacheEnabled false mWebView setDrawingCacheEnabled false mWebView setWillNotCacheDrawing true mWebView setAlwaysDrawnWithCacheEnabled false mWebView setBackgroundColor activity getResources getColor android R color white if API 15 mWebView setBackground null mWebView getRootView setBackground null else if mWebView getRootView null mWebView getRootView setBackgroundDrawable null mWebView setScrollbarFadingEnabled true mWebView setSaveEnabled true mWebView setWebChromeClient new LightningChromeClient activity mWebView setWebViewClient new LightningWebClient activity mWebView setDownloadListener new LightningDownloadListener activity mGestureDetector new GestureDetector activity, new CustomGestureListener mWebView setOnTouchListener new TouchListener mDefaultUserAgent mWebView getSettings getUserAgentString mSettings mWebView getSettings initializeSettings mWebView getSettings , activity initializePreferences activity if url null if url trim isEmpty mWebView loadUrl url else don't load anything, the user is looking for a blank tab else if mHomepage startsWith "abouthome" mWebView loadUrl getHomepage else if mHomepage startsWith "aboutbookmarks" mBrowserController openBookmarkPage mWebView else mWebView loadUrl mHomepage 
public synchronized void loadUrl String url if mWebView null mWebView loadUrl url 
public synchronized void onDestroy if mWebView null mWebView stopLoading mWebView onPause mWebView clearHistory mWebView setVisibility View GONE mWebView removeAllViews mWebView destroyDrawingCache mWebView destroy this is causing the segfault mWebView null 
public synchronized void onPause if mWebView null mWebView onPause 
public synchronized void onResume if mWebView null mWebView onResume 
public synchronized void pauseTimers if mWebView null mWebView pauseTimers 
public synchronized void reload if mWebView null mWebView reload 
public void requestFocus if mWebView null mWebView hasFocus mWebView requestFocus 
public synchronized void resumeTimers if mWebView null mWebView resumeTimers 
public void setColorMode int mode mInvertPage false switch mode case 0 mPaint setColorFilter null setSoftwareRendering Some devices get segfaults in the WebView with Hardware Acceleration enabled, the only fix is to disable hardware rendering setNormalRendering mInvertPage false break case 1 ColorMatrixColorFilter filterInvert new ColorMatrixColorFilter mNegativeColorArray mPaint setColorFilter filterInvert setHardwareRendering mInvertPage true break case 2 ColorMatrix cm new ColorMatrix cm setSaturation 0 ColorMatrixColorFilter filterGray new ColorMatrixColorFilter cm mPaint setColorFilter filterGray setHardwareRendering break case 3 ColorMatrix matrix new ColorMatrix matrix set mNegativeColorArray ColorMatrix matrixGray new ColorMatrix matrixGray setSaturation 0 ColorMatrix concat new ColorMatrix concat setConcat matrix, matrixGray ColorMatrixColorFilter filterInvertGray new ColorMatrixColorFilter concat mPaint setColorFilter filterInvertGray setHardwareRendering mInvertPage true break 
public void setForegroundTab boolean isForeground isForegroundTab isForeground mBrowserController update 
public void setHardwareRendering mWebView setLayerType View LAYER_TYPE_HARDWARE, mPaint 
public void setNormalRendering mWebView setLayerType View LAYER_TYPE_NONE, null 
public void setSoftwareRendering mWebView setLayerType View LAYER_TYPE_SOFTWARE, null 
public void setVisibility int visible if mWebView null mWebView setVisibility visible 
public synchronized void stopLoading if mWebView null mWebView stopLoading 
Is called when the user is swiping after the doubletap, which in our case means that he is zooming Override public boolean onDoubleTapEvent MotionEvent e mCanTriggerLongPress false return false 
Override public void onLongPress MotionEvent e if mCanTriggerLongPress mBrowserController onLongPress 
Is called when something is starting being pressed, always before onLongPress Override public void onShowPress MotionEvent e mCanTriggerLongPress true 
Override public Bitmap getDefaultVideoPoster return mBrowserController getDefaultVideoPoster 
Override public View getVideoLoadingProgressView return mBrowserController getVideoLoadingProgressView 
LightningChromeClient Context context mActivity context 
Override public void onCloseWindow WebView window TODO Autogenerated method stub super onCloseWindow window 
Override public boolean onCreateWindow WebView view, boolean isDialog, boolean isUserGesture, Message resultMsg mBrowserController onCreateWindow isUserGesture, resultMsg return true 
Override public void onGeolocationPermissionsShowPrompt final String origin, final GeolocationPermissions Callback callback final boolean remember true AlertDialog Builder builder new AlertDialog Builder mActivity builder setTitle mActivity getString R string location String org if origin length 50 org origin subSequence 0, 50 " " else org origin builder setMessage org mActivity getString R string message_location setCancelable true setPositiveButton mActivity getString R string action_allow , new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int id callback invoke origin, true, remember setNegativeButton mActivity getString R string action_dont_allow , new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int id callback invoke origin, false, remember AlertDialog alert builder create alert show 
Override public void onHideCustomView mBrowserController onHideCustomView super onHideCustomView 
Override public void onProgressChanged WebView view, int newProgress if isShown mBrowserController updateProgress newProgress 
Override public void onReceivedIcon WebView view, Bitmap icon mTitle setFavicon icon mBrowserController update cacheFavicon icon 
Override public void onReceivedTitle WebView view, String title if title isEmpty mTitle setTitle title else mTitle setTitle mActivity getString R string untitled mBrowserController update mBrowserController updateHistory title, view getUrl 
Override Deprecated public void onShowCustomView View view, int requestedOrientation, CustomViewCallback callback While these lines might look like they work, in practice, Fullscreen videos won't work correctly I may test this out some more if view instanceof FrameLayout FrameLayout frame FrameLayout view if frame getFocusedChild instanceof VideoView VideoView video VideoView frame getFocusedChild video stopPlayback frame removeView video video setVisibility View GONE else mBrowserController onShowCustomView view, requestedOrientation, callback super onShowCustomView view, requestedOrientation, callback 
public boolean onShowFileChooser WebView webView, ValueCallbackUri[] filePathCallback, WebChromeClient FileChooserParams fileChooserParams mBrowserController showFileChooser filePathCallback return true 
public void openFileChooser ValueCallbackUri uploadMsg, String acceptType, String capture mBrowserController openFileChooser uploadMsg 
LightningWebClient Context context mActivity context 
Override public void onFormResubmission WebView view, NonNull final Message dontResend, final Message resend AlertDialog Builder builder new AlertDialog Builder mActivity builder setTitle mActivity getString R string title_form_resubmission builder setMessage mActivity getString R string message_form_resubmission setCancelable true setPositiveButton mActivity getString R string action_yes , new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int id resend sendToTarget setNegativeButton mActivity getString R string action_no , new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int id dontResend sendToTarget AlertDialog alert builder create alert show 
Override public void onPageFinished WebView view, String url if view isShown mBrowserController updateUrl url, true view postInvalidate if view getTitle null view getTitle isEmpty mTitle setTitle mActivity getString R string untitled else mTitle setTitle view getTitle if API android os Build VERSION_CODES KITKAT mInvertPage view evaluateJavascript Constants JAVASCRIPT_INVERT_PAGE, null mBrowserController update 
Override public void onPageStarted WebView view, String url, Bitmap favicon if isShown mBrowserController updateUrl url, false mBrowserController showActionBar mTitle setFavicon mWebpageBitmap mBrowserController update 
Override public void onReceivedHttpAuthRequest final WebView view, NonNull final HttpAuthHandler handler, final String host, final String realm AlertDialog Builder builder new AlertDialog Builder mActivity final EditText name new EditText mActivity final EditText password new EditText mActivity LinearLayout passLayout new LinearLayout mActivity passLayout setOrientation LinearLayout VERTICAL passLayout addView name passLayout addView password name setHint mActivity getString R string hint_username name setSingleLine password setInputType InputType TYPE_TEXT_VARIATION_PASSWORD password setSingleLine password setTransformationMethod new PasswordTransformationMethod password setHint mActivity getString R string hint_password builder setTitle mActivity getString R string title_sign_in builder setView passLayout builder setCancelable true setPositiveButton mActivity getString R string title_sign_in , new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int id String user name getText toString String pass password getText toString handler proceed user trim , pass trim Log d Constants TAG, "Request Login" setNegativeButton mActivity getString R string action_cancel , new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int id handler cancel AlertDialog alert builder create alert show 
Override public void onReceivedSslError WebView view, NonNull final SslErrorHandler handler, SslError error AlertDialog Builder builder new AlertDialog Builder mActivity builder setTitle mActivity getString R string title_warning builder setMessage mActivity getString R string message_untrusted_certificate setCancelable true setPositiveButton mActivity getString R string action_yes , new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int id handler proceed setNegativeButton mActivity getString R string action_no , new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int id handler cancel AlertDialog alert builder create if error getPrimaryError SslError SSL_UNTRUSTED alert show else handler proceed 
Override public void onScaleChanged final WebView view, final float oldScale, final float newScale if view isShown mTextReflow API android os Build VERSION_CODES KITKAT if mIsRunning return if Math abs mZoomScale newScale 0 01f mIsRunning view postDelayed new Runnable Override public void run mZoomScale newScale view evaluateJavascript Constants JAVASCRIPT_TEXT_REFLOW, null mIsRunning false , 100 
Override public WebResourceResponse shouldInterceptRequest WebView view, String url if mAdBlock isAd url ByteArrayInputStream EMPTY new ByteArrayInputStream "" getBytes return new WebResourceResponse "textplain", "utf8", EMPTY return null 
Override public boolean shouldOverrideUrlLoading WebView view, String url if mBrowserController isIncognito return super shouldOverrideUrlLoading view, url if url startsWith "about" return super shouldOverrideUrlLoading view, url if url contains "mailto" MailTo mailTo MailTo parse url Intent i Utils newEmailIntent mActivity, mailTo getTo , mailTo getSubject , mailTo getBody , mailTo getCc mActivity startActivity i view reload return true else if url startsWith "intent" Intent intent try intent Intent parseUri url, Intent URI_INTENT_SCHEME catch URISyntaxException ex return false if intent null try mActivity startActivity intent catch ActivityNotFoundException e Log e Constants TAG, "ActivityNotFoundException" return true return mIntentUtils startActivityForUrl mWebView, url 
public Bitmap getFavicon return mFavicon 
public String getTitle return mTitle 
public void setFavicon Bitmap favicon if favicon null mFavicon mDefaultIcon else mFavicon Utils padFavicon favicon 
public void setTitle String title if title null mTitle "" else mTitle title 
public void setTitleAndFavicon String title, Bitmap favicon mTitle title if favicon null mFavicon mDefaultIcon else mFavicon Utils padFavicon favicon 
public Title Context context, boolean darkTheme mDefaultIcon Utils getWebpageBitmap context getResources , darkTheme mFavicon mDefaultIcon mTitle mActivity getString R string action_new_tab 
SuppressLint "ClickableViewAccessibility" Override public boolean onTouch View view, MotionEvent arg1 if view null view hasFocus view requestFocus mAction arg1 getAction mY arg1 getY if mAction MotionEvent ACTION_DOWN mLocation mY else if mAction MotionEvent ACTION_UP if mY mLocation SCROLL_DOWN_THRESHOLD if mWebView getScrollY 0 mBrowserController showActionBar else mBrowserController toggleActionBar else if mY mLocation SCROLL_UP_THRESHOLD mBrowserController hideActionBar mLocation 0 mGestureDetector onTouchEvent arg1 return false 
Override public void closeActivity closeDrawers moveTaskToBack true 
Override public int getMenu return R menu main 
Override public synchronized void initializeTabs restoreOrNewTab if incognito mode use newTab null, true instead 
Override public boolean isIncognito return false 
Override protected void onCreate Bundle savedInstanceState super onCreate savedInstanceState 
Override public boolean onCreateOptionsMenu Menu menu getMenuInflater inflate R menu main, menu return super onCreateOptionsMenu menu 
Override protected void onNewIntent Intent intent handleNewIntent intent super onNewIntent intent 
Override protected void onPause super onPause saveOpenTabs 
Override public void updateCookiePreference mCookieManager CookieManager getInstance if Build VERSION SDK_INT Build VERSION_CODES LOLLIPOP CookieSyncManager createInstance this mCookieManager setAcceptCookie PreferenceManager getInstance getCookiesEnabled super updateCookiePreference 
Override public void updateHistory String title, String url super updateHistory title, url addItemToHistory title, url 
Override public boolean equals Object obj if obj null return false if getClass obj getClass return false final MapEntryK, V other MapEntryK, V obj if this key other key this key null this key equals other key return false return this value other value this value null this value equals other value 
Override public K getKey return key 
Override public V getValue return value 
Override public int hashCode int hash 7 hash 19 hash this key null ? this key hashCode 0 hash 19 hash this value null ? this value hashCode 0 return hash 
public MapEntry K key, V value this key key this value value 
Override public V setValue V value this value value return value 
Override public String toString return getKey ", " getValue 
public void onCancel DialogInterface dialog sendDecision MTMDecision DECISION_ABORT 
public void onClick DialogInterface dialog, int btnId int decision dialog dismiss switch btnId case DialogInterface BUTTON_POSITIVE decision MTMDecision DECISION_ALWAYS break case DialogInterface BUTTON_NEUTRAL decision MTMDecision DECISION_ONCE break default decision MTMDecision DECISION_ABORT sendDecision decision 
Override public void onCreate Bundle savedInstanceState Log d TAG, "onCreate" super onCreate savedInstanceState 
Override public void onResume super onResume Intent i getIntent decisionId i getIntExtra MemorizingTrustManager DECISION_INTENT_ID, MTMDecision DECISION_INVALID String cert i getStringExtra MemorizingTrustManager DECISION_INTENT_CERT Log d TAG, "onResume with " i getExtras " decId" decisionId Log d TAG, "data " i getData new AlertDialog Builder this setTitle R string mtm_accept_cert setMessage cert setPositiveButton R string mtm_decision_always, this setNeutralButton R string mtm_decision_once, this setNegativeButton R string mtm_decision_abort, this setOnCancelListener this create show 
void sendDecision int decision Log d TAG, "Sending decision " decision MemorizingTrustManager interactResult decisionId, decision finish 
Binds an Activity to the MTM for displaying the query dialog This is useful if your connection is run from a service that is triggered by user interaction in such cases the activity is visible and the user tends to ignore the service notification You should never have a hidden activity bound to MTM Use this function in onResume and see unbindDisplayActivity in onPause param act Activity to be bound public void bindDisplayActivity Activity act foregroundAct act 
private String certChainMessage final X509Certificate[] chain, CertificateException cause Throwable e cause Log d TAG, "certChainMessage for " e StringBuffer si new StringBuffer if e getCause null e e getCause si append e getLocalizedMessage si append "\n" for X509Certificate c chain si append "\n\n" si append c getSubjectDN toString si append "\nMD5 " si append certHash c, "MD5" si append "\nSHA1 " si append certHash c, "SHA1" si append "\nSigned by " si append c getIssuerDN toString return si toString 
private static String certHash final X509Certificate cert, String digest try MessageDigest md MessageDigest getInstance digest md update cert getEncoded return hexString md digest catch java security cert CertificateEncodingException e return e getMessage catch java security NoSuchAlgorithmException e return e getMessage 
public void checkCertTrusted X509Certificate[] chain, String authType, boolean isServer throws CertificateException Log d TAG, "checkCertTrusted " chain ", " authType ", " isServer " " try Log d TAG, "checkCertTrusted trying appTrustManager" if isServer appTrustManager checkServerTrusted chain, authType else appTrustManager checkClientTrusted chain, authType catch CertificateException ae if the cert is stored in our appTrustManager, we ignore expiredness ae printStackTrace if isExpiredException ae Log i TAG, "checkCertTrusted accepting expired certificate from keystore" return if isCertKnown chain[0] Log i TAG, "checkCertTrusted accepting cert already stored in keystore" return try if defaultTrustManager null throw new CertificateException Log d TAG, "checkCertTrusted trying defaultTrustManager" if isServer defaultTrustManager checkServerTrusted chain, authType else defaultTrustManager checkClientTrusted chain, authType catch CertificateException e e printStackTrace interact chain, authType, e 
public void checkClientTrusted X509Certificate[] chain, String authType throws CertificateException checkCertTrusted chain, authType, false 
public void checkServerTrusted X509Certificate[] chain, String authType throws CertificateException checkCertTrusted chain, authType, true 
private int createDecisionId MTMDecision d int myId synchronized openDecisions myId decisionId openDecisions put myId, d decisionId 1 return myId 
public X509Certificate[] getAcceptedIssuers Log d TAG, "getAcceptedIssuers " return defaultTrustManager getAcceptedIssuers 
Returns a X509TrustManager list containing a new instance of TrustManagerFactory This function is meant for convenience only You can use it as follows to integrate TrustManagerFactory for HTTPS sockets pre SSLContext sc SSLContext getInstance "TLS" sc init null, MemorizingTrustManager getInstanceList this , new java security SecureRandom HttpsURLConnection setDefaultSSLSocketFactory sc getSocketFactory pre param c Activity or Service to show the Dialog Notification public static X509TrustManager[] getInstanceList Context c return new X509TrustManager[] new MemorizingTrustManager c 
X509TrustManager getTrustManager KeyStore ks try TrustManagerFactory tmf TrustManagerFactory getInstance "X509" tmf init ks for TrustManager t tmf getTrustManagers if t instanceof X509TrustManager return X509TrustManager t catch Exception e Here, we are covering up errors It might be more useful however to throw them out of the constructor so the embedding app knows something went wrong Log e TAG, "getTrustManager " ks " ", e return null 
Returns the topmost entry of the activity stack return the Context of the currently bound UI or the master context if none is bound Context getUI return foregroundAct null ? foregroundAct master 
private static String hexString byte[] data StringBuffer si new StringBuffer for int i 0 i data length i si append String format "02x", data[i] if i data length 1 si append "" return si toString 
void init Context m master m masterHandler new Handler m getMainLooper notificationManager NotificationManager master getSystemService Context NOTIFICATION_SERVICE Application app if m instanceof Application app Application m else if m instanceof Service app Service m getApplication else if m instanceof Activity app Activity m getApplication else throw new ClassCastException "MemorizingTrustManager context must be either Activity or Service" File dir app getDir KEYSTORE_DIR, Context MODE_PRIVATE keyStoreFile new File dir File separator KEYSTORE_FILE appKeyStore loadAppKeyStore 
void interact final X509Certificate[] chain, String authType, CertificateException cause throws CertificateException prepare the MTMDecision blocker object MTMDecision choice new MTMDecision final int myId createDecisionId choice final String certMessage certChainMessage chain, cause masterHandler post new Runnable public void run Intent ni new Intent master, MemorizingActivity class ni setFlags Intent FLAG_ACTIVITY_NEW_TASK ni setData Uri parse MemorizingTrustManager class getName "" myId ni putExtra DECISION_INTENT_ID, myId ni putExtra DECISION_INTENT_CERT, certMessage we try to directly start the activity and fall back to making a notification try getUI startActivity ni catch Exception e Log e TAG, "startActivity " e startActivityNotification ni, certMessage Log d TAG, "openDecisions " openDecisions Log d TAG, "waiting on " myId try synchronized choice choice wait catch InterruptedException e e printStackTrace Log d TAG, "finished wait on " myId " " choice state switch choice state case MTMDecision DECISION_ALWAYS storeCert chain case MTMDecision DECISION_ONCE break default throw cause 
protected static void interactResult int decisionId, int choice MTMDecision d synchronized openDecisions d openDecisions get decisionId openDecisions remove decisionId if d null Log e TAG, "interactResult aborting due to stale decision reference" return synchronized d d state choice d notify 
private boolean isCertKnown X509Certificate cert try return appKeyStore getCertificateAlias cert null catch KeyStoreException e return false 
private boolean isExpiredException Throwable e do if e instanceof CertificateExpiredException return true e e getCause while e null return false 
KeyStore loadAppKeyStore KeyStore ks try ks KeyStore getInstance KeyStore getDefaultType catch KeyStoreException e Log e TAG, "getAppKeyStore ", e return null try ks load null, null ks load new java io FileInputStream keyStoreFile , "MTM" toCharArray catch java io FileNotFoundException e Log i TAG, "getAppKeyStore " keyStoreFile " file does not exist" catch Exception e Log e TAG, "getAppKeyStore " keyStoreFile " ", e return ks 
Creates an instance of the MemorizingTrustManager class You need to supply the application context This has to be one of Application Activity Service The context is used for file management, to display the dialog notification and for obtaining translated strings param m Context for the application public MemorizingTrustManager Context m init m this appTrustManager getTrustManager appKeyStore this defaultTrustManager getTrustManager null 
Changes the path for the KeyStore file The actual filename relative to the app's directory will be codeapp_idirnameiifilenameicode param dirname directory to store the KeyStore param filename file name for the KeyStore public static void setKeyStoreFile String dirname, String filename KEYSTORE_DIR dirname KEYSTORE_FILE filename 
void startActivityNotification Intent intent, String certName Notification n new Notification android R drawable ic_lock_lock, master getString R string mtm_notification , System currentTimeMillis PendingIntent call PendingIntent getActivity master, 0, intent, 0 n setLatestEventInfo master getApplicationContext , master getString R string mtm_notification , certName, call n flags Notification FLAG_AUTO_CANCEL notificationManager notify NOTIFICATION_ID, n 
void storeCert X509Certificate[] chain add all certs from chain to appKeyStore try for X509Certificate c chain appKeyStore setCertificateEntry c getSubjectDN toString , c catch KeyStoreException e Log e TAG, "storeCert " chain " ", e return reload appTrustManager appTrustManager getTrustManager appKeyStore store KeyStore to file try java io FileOutputStream fos new java io FileOutputStream keyStoreFile appKeyStore store fos, "MTM" toCharArray fos close catch Exception e Log e TAG, "storeCert " keyStoreFile " ", e 
Removes an Activity from the MTM display stack Always call this function when the Activity added with see bindDisplayActivity is hidden param act Activity to be unbound public void unbindDisplayActivity Activity act do not remove if it was overridden by a different activity if foregroundAct act foregroundAct null 
Spawns a new thread connecting to the specified URL The result of the request is displayed on the screen param urlString a HTTPS URL to connect to void connect final String urlString register the right hostname verifier if verifyhost isChecked HttpsURLConnection setDefaultHostnameVerifier defaultverifier else HttpsURLConnection setDefaultHostnameVerifier new org apache http conn ssl AllowAllHostnameVerifier new Thread public void run try URL u new URL urlString HttpsURLConnection c HttpsURLConnection u openConnection c connect setText "" c getResponseCode " " c getResponseMessage , false c disconnect catch Exception e setText e toString , false e printStackTrace start 
Reacts on the connect Button press Override public void onClick View view String url urlinput getText toString setText "Loading " url, true setProgressBarIndeterminateVisibility true connect url 
Creates the Activity and registers a MemorizingTrustManager Override public void onCreate Bundle savedInstanceState super onCreate savedInstanceState requestWindowFeature Window FEATURE_INDETERMINATE_PROGRESS setContentView R layout mtmexample set up gui elements findViewById R id connect setOnClickListener this content TextView findViewById R id content urlinput EditText findViewById R id url verifyhost CheckBox findViewById R id verifyhost register handler for background thread hdlr new Handler Here, the MemorizingTrustManager is activated for HTTPS try set location of the keystore MemorizingTrustManager setKeyStoreFile "private", "sslkeys bks" register MemorizingTrustManager for HTTPS SSLContext sc SSLContext getInstance "TLS" sc init null, MemorizingTrustManager getInstanceList this , new java security SecureRandom HttpsURLConnection setDefaultSSLSocketFactory sc getSocketFactory defaultverifier HttpsURLConnection getDefaultHostnameVerifier disable redirects to reduce possible confusion HttpsURLConnection setFollowRedirects false catch Exception e e printStackTrace 
Updates the screen content from a background thread void setText final String s, final boolean progress text s hdlr post new Runnable public void run content setText s setProgressBarIndeterminateVisibility progress 
public MyDefaultClientConnectionOperator SchemeRegistry schemes super schemes 
Override public void openConnection OperatedClientConnection conn, HttpHost target, InetAddress local, HttpContext context, HttpParams params throws IOException if conn null throw new IllegalArgumentException "Connection must not be null " if target null throw new IllegalArgumentException "Target host must not be null " local address may be null is context allowed to be null? if params null throw new IllegalArgumentException "Parameters must not be null " if conn isOpen throw new IllegalArgumentException "Connection must not be open " final Scheme schm schemeRegistry getScheme target getSchemeName final SocketFactory sf schm getSocketFactory Socket sock sf createSocket conn opening sock, target try Socket connsock sf connectSocket sock, target getHostName , schm resolvePort target getPort , local, 0, params if sock connsock sock connsock conn opening sock, target catch ConnectException ex throw new HttpHostConnectException target, ex prepareSocket sock, context, params conn openCompleted sf isSecure sock , params 
Override protected ClientConnectionOperator createConnectionOperator SchemeRegistry schreg return new MyDefaultClientConnectionOperator schreg 
public MyThreadSafeClientConnManager HttpParams params, SchemeRegistry schreg super params, schreg 
public String checkHTTP String url, Proxy Type pType, String proxyHost, int proxyPort throws KeyManagementException, UnrecoverableKeyException, NoSuchAlgorithmException, KeyStoreException, CertificateException, IOException StrongHttpsClient httpclient new StrongHttpsClient getApplicationContext if pType null do nothing httpclient useProxy false, null, null, 1 else if pType Proxy Type SOCKS httpclient useProxy true, StrongHttpsClient TYPE_SOCKS, proxyHost, proxyPort else if pType Proxy Type HTTP httpclient useProxy true, StrongHttpsClient TYPE_HTTP, proxyHost, proxyPort HttpGet httpget new HttpGet url HttpResponse response httpclient execute httpget StringBuffer sb new StringBuffer sb append response getStatusLine append "\n\n" InputStream is response getEntity getContent BufferedReader br new BufferedReader new InputStreamReader is String line null while line br readLine null sb append line return sb toString 
Called when the activity is first created Override public void onCreate Bundle savedInstanceState super onCreate savedInstanceState setContentView R layout main txtUrl EditText findViewById R id txtUrl txtView TextView findViewById R id WizardTextBody Button btn btn Button findViewById R id btnWizard1 btn setOnClickListener new OnClickListener Override public void onClick View v mProxyType null new Thread runnableNet start btn Button findViewById R id btnWizard2 btn setOnClickListener new OnClickListener Override public void onClick View v mProxyType Proxy Type HTTP new Thread runnableNet start btn Button findViewById R id btnWizard3 btn setOnClickListener new OnClickListener Override public void onClick View v mProxyType Proxy Type SOCKS new Thread runnableNet start 
Override protected void onResume super onResume OrbotHelper oc new OrbotHelper this if oc isOrbotInstalled oc promptToInstall this else if oc isOrbotRunning oc requestOrbotStart this 
private boolean isAppInstalled String uri PackageManager pm mContext getPackageManager boolean installed false try pm getPackageInfo uri, PackageManager GET_ACTIVITIES installed true catch PackageManager NameNotFoundException e installed false return installed 
public boolean isOrbotInstalled return isAppInstalled URI_ORBOT 
public boolean isOrbotRunning int procId TorServiceUtils findProcessId TOR_BIN_PATH return procId 1 
public OrbotHelper Context context mContext context 
public void promptToInstall Activity activity String uriMarket activity getString R string market_orbot show dialog install from market, fdroid or direct APK showDownloadDialog activity, activity getString R string install_orbot_ , activity getString R string you_must_have_orbot , activity getString R string yes , activity getString R string no , uriMarket 
public void requestHiddenServiceOnPort Activity activity, int port Intent intent new Intent URI_ORBOT intent setAction ACTION_REQUEST_HS intent putExtra "hs_port", port activity startActivityForResult intent, HS_REQUEST_CODE 
public void requestOrbotStart final Activity activity AlertDialog Builder downloadDialog new AlertDialog Builder activity downloadDialog setTitle R string start_orbot_ downloadDialog setMessage R string orbot_doesn_t_appear_to_be_running_would_you_like_to_start_it_up_and_connect_to_tor_ downloadDialog setPositiveButton R string yes, new DialogInterface OnClickListener public void onClick DialogInterface dialogInterface, int i Intent intent new Intent URI_ORBOT intent setAction ACTION_START_TOR activity startActivityForResult intent, 1 downloadDialog setNegativeButton R string no, new DialogInterface OnClickListener public void onClick DialogInterface dialogInterface, int i downloadDialog show 
private static AlertDialog showDownloadDialog final Activity activity, CharSequence stringTitle, CharSequence stringMessage, CharSequence stringButtonYes, CharSequence stringButtonNo, final String uriString AlertDialog Builder downloadDialog new AlertDialog Builder activity downloadDialog setTitle stringTitle downloadDialog setMessage stringMessage downloadDialog setPositiveButton stringButtonYes, new DialogInterface OnClickListener public void onClick DialogInterface dialogInterface, int i Uri uri Uri parse uriString Intent intent new Intent Intent ACTION_VIEW, uri activity startActivity intent downloadDialog setNegativeButton stringButtonNo, new DialogInterface OnClickListener public void onClick DialogInterface dialogInterface, int i return downloadDialog show 
protected void append Element node, StringBuilder sb, String tagName is select more costly then getElementsByTag? MAIN for Element e node select tagName Element tmpEl e check all elements until 'node' while tmpEl null tmpEl equals node if unlikely tmpEl continue MAIN tmpEl tmpEl parent String text node2Text e if text isEmpty text length minParagraphText text length SHelper countLetters text 2 continue sb append text sb append "\n\n" 
void appendTextSkipHidden Element e, StringBuilder accum for Node child e childNodes if unlikely child continue if child instanceof TextNode TextNode textNode TextNode child String txt textNode text accum append txt else if child instanceof Element Element element Element child if accum length 0 element isBlock lastCharIsWhitespace accum accum append " " else if element tagName equals "br" accum append " " appendTextSkipHidden element, accum 
public OutputFormatter appendUnlikelyPattern String str return setUnlikelyPattern unlikelyPattern toString "" str 
takes an element and turns the P tags into \n\n public String getFormattedText Element topNode removeNodesWithNegativeScores topNode StringBuilder sb new StringBuilder append topNode, sb, nodesToKeepCssSelector String str SHelper innerTrim sb toString if str length 100 return str no subelements if str isEmpty topNode text isEmpty str length topNode ownText length str topNode text if jsoup failed to parse the whole html now parse this smaller snippet again to avoid html tags disturbing our text return Jsoup parse str text 
Takes an element and returns a list of texts extracted from the P tags public ListString getTextList Element topNode ListString texts new ArrayList for Element element topNode select this nodesToKeepCssSelector if element hasText texts add element text return texts 
boolean lastCharIsWhitespace StringBuilder accum return accum length 0 Character isWhitespace accum charAt accum length 1 
protected String node2Text Element el StringBuilder sb new StringBuilder 200 appendTextSkipHidden el, sb return sb toString 
protected String node2TextOld Element el return el text 
public OutputFormatter int minParagraphText, ListString nodesToReplace this minParagraphText minParagraphText this nodesToReplace nodesToReplace 
If there are elements inside our top node that have a negative gravity score remove them protected void removeNodesWithNegativeScores Element topNode Elements gravityItems topNode select "[gravityScore]" for Element item gravityItems int score Integer parseInt item attr "gravityScore" if score 0 item text length minParagraphText item remove 
set elements to keep in output text public void setNodesToKeepCssSelector String nodesToKeepCssSelector this nodesToKeepCssSelector nodesToKeepCssSelector 
public OutputFormatter setUnlikelyPattern String unlikelyPattern this unlikelyPattern Pattern compile unlikelyPattern return this 
boolean unlikely Node e if e attr "class" null e attr "class" toLowerCase Locale getDefault contains "caption" return true String style e attr "style" String clazz e attr "class" return unlikelyPattern matcher style find unlikelyPattern matcher clazz find 
Constructs an HttpClient that will validate SSL connections with a PinningTrustManager param pins An array of encoded pins to match a seen certificate chain against A pin is a hexencoded hash of a X 509 certificate's SubjectPublicKeyInfo A pin can be generated using the provided pin py script python toolspin py certificate_file pem public static HttpClient getPinnedHttpClient Context context, String[] pins try SchemeRegistry schemeRegistry new SchemeRegistry schemeRegistry register new Scheme "http", PlainSocketFactory getSocketFactory , 80 schemeRegistry register new Scheme "https", new PinningSSLSocketFactory context, pins, 0 , 443 HttpParams httpParams new BasicHttpParams ClientConnectionManager connectionManager new ThreadSafeClientConnManager httpParams, schemeRegistry return new DefaultHttpClient connectionManager, httpParams catch UnrecoverableKeyException e throw new AssertionError e catch KeyManagementException e throw new AssertionError e catch NoSuchAlgorithmException e throw new AssertionError e catch KeyStoreException e throw new AssertionError e 
Constructs an HttpsURLConnection that will validate HTTPS connections against a set of specified pins param pins An array of encoded pins to match a seen certificate chain against A pin is a hexencoded hash of a X 509 certificate's SubjectPublicKeyInfo A pin can be generated using the provided pin py script python toolspin py certificate_file pem public static HttpsURLConnection getPinnedHttpsURLConnection Context context, String[] pins, URL url throws IOException try if url getProtocol equals "https" throw new IllegalArgumentException "Attempt to construct pinned nonhttps connection" TrustManager[] trustManagers new TrustManager[1] trustManagers[0] new PinningTrustManager SystemKeyStore getInstance context , pins, 0 SSLContext sslContext SSLContext getInstance "TLS" sslContext init null, trustManagers, null HttpsURLConnection urlConnection HttpsURLConnection url openConnection urlConnection setSSLSocketFactory sslContext getSocketFactory return urlConnection catch NoSuchAlgorithmException nsae throw new AssertionError nsae catch KeyManagementException e throw new AssertionError e 
public void testBadHttpClient String[] pins new String[] "40c5401d6f8cbaf08b00edefb1ee87d005b3b9cd" HttpClient client PinningHelper getPinnedHttpClient getContext , pins try client execute new HttpGet "httpswww twitter com" catch IOException ioe Log w "PinningHelperTest", ioe return fail "Accepted bad pin" 
public void testBadUrlConnection throws IOException String[] pins new String[] "40c5401d6f8cbaf08b00edefb1ee87d005b3b9cd" HttpsURLConnection connection PinningHelper getPinnedHttpsURLConnection getContext , pins, new URL "httpswww twitter com" try connection getInputStream catch IOException ioe Log w "PinningHelperTest", ioe return fail "Accepted bad pin" 
public void testGoodHttpClient throws IOException String[] pins new String[] "40c5401d6f8cbaf08b00edefb1ee87d005b3b9cd" HttpClient client PinningHelper getPinnedHttpClient getContext , pins client execute new HttpGet "httpswww google com" 
public void testGoodUrlConnection throws IOException String[] pins new String[] "40c5401d6f8cbaf08b00edefb1ee87d005b3b9cd" HttpsURLConnection connection PinningHelper getPinnedHttpsURLConnection getContext , pins, new URL "httpswww google com" connection getInputStream 
Override public Socket connectSocket final Socket sock, final String host, final int port, final InetAddress localAddress, int localPort, final HttpParams params throws IOException final SSLSocket sslSock SSLSocket sock null ? sock createSocket if localAddress null localPort 0 if localPort 0 localPort 0 sslSock bind new InetSocketAddress localAddress, localPort final int connTimeout HttpConnectionParams getConnectionTimeout params final int soTimeout HttpConnectionParams getSoTimeout params final InetSocketAddress remoteAddress new InetSocketAddress host, port sslSock connect remoteAddress, connTimeout sslSock setSoTimeout soTimeout try SSLSocketFactory STRICT_HOSTNAME_VERIFIER verify host, sslSock catch IOException iox try sslSock close catch Exception ignored throw iox return sslSock 
Override public Socket createSocket final Socket socket, final String host, int port, final boolean autoClose throws IOException if port 1 port 443 final SSLSocket sslSocket SSLSocket pinningSocketFactory createSocket socket, host, port, autoClose SSLSocketFactory STRICT_HOSTNAME_VERIFIER verify host, sslSocket return sslSocket 
Override public X509HostnameVerifier getHostnameVerifier return SSLSocketFactory STRICT_HOSTNAME_VERIFIER 
private TrustManager[] initializePinningTrustManagers SystemKeyStore keyStore, String[] pins, long enforceUntilTimestampMillis final TrustManager[] trustManagers new TrustManager[1] trustManagers[0] new PinningTrustManager keyStore, pins, enforceUntilTimestampMillis return trustManagers 
Constructs a PinningSSLSocketFactory with a set of valid pins param pins An array of encoded pins to match a seen certificate chain against A pin is a hexencoded hash of a X 509 certificate's SubjectPublicKeyInfo A pin can be generated using the provided pin py script python toolspin py certificate_file pem param enforceUntilTimestampMillis A timestamp in milliseconds when pins will stop being enforced Normal nonpinned certificate validation will continue Set this to some period after your build date, or to 0 to enforce pins forever public PinningSSLSocketFactory Context context, String[] pins, long enforceUntilTimestampMillis throws UnrecoverableKeyException, KeyManagementException, NoSuchAlgorithmException, KeyStoreException super null final SystemKeyStore keyStore SystemKeyStore getInstance context final SSLContext pinningSslContext SSLContext getInstance TLS final TrustManager[] pinningTrustManagers initializePinningTrustManagers keyStore, pins, enforceUntilTimestampMillis pinningSslContext init null, pinningTrustManagers, null this pinningSocketFactory pinningSslContext getSocketFactory 
Override public void setHostnameVerifier X509HostnameVerifier hostnameVerifier throw new IllegalArgumentException "Only strict hostname verification default " "is supported" 
public void testBadPin throws UnrecoverableKeyException, NoSuchAlgorithmException, KeyStoreException, KeyManagementException String[] pins new String[] "40c5401d6f8cbaf08b00edefb1ee87d005b3b9cd" SchemeRegistry schemeRegistry new SchemeRegistry schemeRegistry register new Scheme "http", PlainSocketFactory getSocketFactory , 80 schemeRegistry register new Scheme "https", new PinningSSLSocketFactory getContext ,pins, 0 , 443 HttpParams httpParams new BasicHttpParams ClientConnectionManager connectionManager new ThreadSafeClientConnManager httpParams, schemeRegistry DefaultHttpClient httpClient new DefaultHttpClient connectionManager, httpParams try HttpResponse response httpClient execute new HttpGet "httpswww twitter com" catch IOException ioe Log w "PinningSSLSocketFactory", ioe return fail "No errot thrown when connecting to unpinned host" 
public void testGoodPin throws IOException, UnrecoverableKeyException, NoSuchAlgorithmException, KeyStoreException, KeyManagementException String[] pins new String[] "40c5401d6f8cbaf08b00edefb1ee87d005b3b9cd" SchemeRegistry schemeRegistry new SchemeRegistry schemeRegistry register new Scheme "http", PlainSocketFactory getSocketFactory , 80 schemeRegistry register new Scheme "https", new PinningSSLSocketFactory getContext ,pins, 0 , 443 HttpParams httpParams new BasicHttpParams ClientConnectionManager connectionManager new ThreadSafeClientConnManager httpParams, schemeRegistry DefaultHttpClient httpClient new DefaultHttpClient connectionManager, httpParams HttpResponse response httpClient execute new HttpGet "httpswww google com" 
public void checkClientTrusted X509Certificate[] chain, String authType throws CertificateException throw new CertificateException "Client certificates not supported" 
private void checkPinTrust X509Certificate[] chain throws CertificateException if enforceUntilTimestampMillis 0 System currentTimeMillis enforceUntilTimestampMillis Log w "PinningTrustManager", "Certificate pins are stale, falling back to system trust " return final X509Certificate[] cleanChain CertificateChainCleaner getCleanChain chain, systemKeyStore for X509Certificate certificate cleanChain if isValidPin certificate return throw new CertificateException "No valid pins found in chain" 
public void checkServerTrusted X509Certificate[] chain, String authType throws CertificateException if cache contains chain[0] return Note We do this so that we'll never be doing worse than the default system validation It's duplicate work, however, and can be factored out if we make the verification below more complete checkSystemTrust chain, authType checkPinTrust chain cache add chain[0] 
private void checkSystemTrust X509Certificate[] chain, String authType throws CertificateException for TrustManager systemTrustManager systemTrustManagers X509TrustManager systemTrustManager checkServerTrusted chain, authType 
public void clearCache cache clear 
public X509Certificate[] getAcceptedIssuers return null 
private byte[] hexStringToByteArray String s final int len s length final byte[] data new byte[len 2] for int i 0 i len i 2 data[i 2] byte Character digit s charAt i , 16 4 Character digit s charAt i 1 , 16 return data 
private TrustManager[] initializeSystemTrustManagers SystemKeyStore keyStore try final TrustManagerFactory tmf TrustManagerFactory getInstance "X509" tmf init keyStore trustStore return tmf getTrustManagers catch NoSuchAlgorithmException nsae throw new AssertionError nsae catch KeyStoreException e throw new AssertionError e 
private boolean isValidPin X509Certificate certificate throws CertificateException try final MessageDigest digest MessageDigest getInstance "SHA1" final byte[] spki certificate getPublicKey getEncoded final byte[] pin digest digest spki for byte[] validPin this pins if Arrays equals validPin, pin return true return false catch NoSuchAlgorithmException nsae throw new CertificateException nsae 
Constructs a PinningTrustManager with a set of valid pins param keyStore A SystemKeyStore that validation will be based on param pins An array of encoded pins to match a seen certificate chain against A pin is a hexencoded hash of a X 509 certificate's SubjectPublicKeyInfo A pin can be generated using the provided pin py script python toolspin py certificate_file pem param enforceUntilTimestampMillis A timestamp in milliseconds when pins will stop being enforced Normal nonpinned certificate validation will continue Set this to some period after your build date, or to 0 to enforce pins forever public PinningTrustManager SystemKeyStore keyStore, String[] pins, long enforceUntilTimestampMillis this systemTrustManagers initializeSystemTrustManagers keyStore this systemKeyStore keyStore this enforceUntilTimestampMillis enforceUntilTimestampMillis for String pin pins this pins add hexStringToByteArray pin 
private X509Certificate[] makeChain X509Certificate certificates return certificates 
Override protected void setUp throws Exception super setUp Pinning GOOGLE_AUTHORITY trustManager new PinningTrustManager SystemKeyStore getInstance getContext , new String[] "40c5401d6f8cbaf08b00edefb1ee87d005b3b9cd" , 0 
public void testInvalidChainWithValidPin throws CertificateException, NoSuchAlgorithmException, KeyStoreException CertificateFactory certificateFactory CertificateFactory getInstance "X509" X509Certificate verisignEv X509Certificate certificateFactory generateCertificate new ByteArrayInputStream VERISIGN_CLASS_3_EV getBytes X509Certificate googleAuthority X509Certificate certificateFactory generateCertificate new ByteArrayInputStream GOOGLE_AUTHORITY getBytes X509Certificate[] chain makeChain verisignEv, googleAuthority trustManager clearCache try trustManager checkServerTrusted chain, verisignEv getPublicKey getAlgorithm catch CertificateException ce Log w "PinningTrustManagerTest", ce return fail "Trust manager didn't throw error on invalid but pinned chain" 
public void testValidChainAndPin throws CertificateException, NoSuchAlgorithmException, KeyStoreException CertificateFactory certificateFactory CertificateFactory getInstance "X509" X509Certificate googleWildcard X509Certificate certificateFactory generateCertificate new ByteArrayInputStream GOOGLE_WILDCARD getBytes X509Certificate googleAuthority X509Certificate certificateFactory generateCertificate new ByteArrayInputStream GOOGLE_AUTHORITY getBytes X509Certificate equifaxRoot X509Certificate certificateFactory generateCertificate new ByteArrayInputStream EQUIFAX_ROOT getBytes X509Certificate[] chain makeChain googleWildcard, googleAuthority, equifaxRoot trustManager clearCache trustManager checkServerTrusted chain, googleWildcard getPublicKey getAlgorithm Test cache trustManager checkServerTrusted chain, googleWildcard getPublicKey getAlgorithm 
public void testValidChainImpliedRootAndPin throws CertificateException, NoSuchAlgorithmException, KeyStoreException CertificateFactory certificateFactory CertificateFactory getInstance "X509" X509Certificate googleWildcard X509Certificate certificateFactory generateCertificate new ByteArrayInputStream GOOGLE_WILDCARD getBytes X509Certificate googleAuthority X509Certificate certificateFactory generateCertificate new ByteArrayInputStream GOOGLE_AUTHORITY getBytes X509Certificate[] chain makeChain googleWildcard, googleAuthority trustManager clearCache trustManager checkServerTrusted chain, googleWildcard getPublicKey getAlgorithm 
public void testValidChainWithGhostPin throws CertificateException, NoSuchAlgorithmException, KeyStoreException CertificateFactory certificateFactory CertificateFactory getInstance "X509" X509Certificate verisignEv X509Certificate certificateFactory generateCertificate new ByteArrayInputStream VERISIGN_CLASS_3_EV getBytes X509Certificate verisignClassThree X509Certificate certificateFactory generateCertificate new ByteArrayInputStream VERISIGN_CLASS_THREE getBytes X509Certificate googleAuthority X509Certificate certificateFactory generateCertificate new ByteArrayInputStream GOOGLE_AUTHORITY getBytes X509Certificate[] chain makeChain verisignEv, verisignClassThree, googleAuthority trustManager clearCache try trustManager checkServerTrusted chain, verisignEv getPublicKey getAlgorithm catch CertificateException ce Log w "PinningTrustManagerTest", ce return fail "Trust manager didn't throw error on valid chain with ghost pin" 
public void testValidChainWithNoPin throws CertificateException, NoSuchAlgorithmException, KeyStoreException CertificateFactory certificateFactory CertificateFactory getInstance "X509" X509Certificate verisignEv X509Certificate certificateFactory generateCertificate new ByteArrayInputStream VERISIGN_CLASS_3_EV getBytes X509Certificate verisignClassThree X509Certificate certificateFactory generateCertificate new ByteArrayInputStream VERISIGN_CLASS_THREE getBytes X509Certificate verisignRoot X509Certificate certificateFactory generateCertificate new ByteArrayInputStream VERISIGN_ROOT getBytes X509Certificate[] chain makeChain verisignEv, verisignClassThree, verisignRoot trustManager clearCache try trustManager checkServerTrusted chain, verisignEv getPublicKey getAlgorithm catch CertificateException ce Log w "PinningTrustManagerTest", ce return fail "Trust manager didn't throw error on valid but unpinned chain" 
public boolean getAdBlockEnabled return mPrefs getBoolean Name BLOCK_ADS, false 
public boolean getBlockImagesEnabled return mPrefs getBoolean Name BLOCK_IMAGES, false 
public boolean getBlockThirdPartyCookiesEnabled return mPrefs getBoolean Name BLOCK_THIRD_PARTY, false 
public boolean getCheckedForTor return mPrefs getBoolean Name INITIAL_CHECK_FOR_TOR, false 
public boolean getClearCacheExit return mPrefs getBoolean Name CLEAR_CACHE_EXIT, false 
public boolean getClearCookiesExitEnabled return mPrefs getBoolean Name CLEAR_COOKIES_EXIT, false 
public boolean getClearHistoryExitEnabled return mPrefs getBoolean Name CLEAR_HISTORY_EXIT, false 
public boolean getColorModeEnabled return mPrefs getBoolean Name ENABLE_COLOR_MODE, false 
public boolean getCookiesEnabled return mPrefs getBoolean Name COOKIES, true 
public boolean getDefaultBookmarks return mPrefs getBoolean Name DEFAULT_BOOKMARKS, true 
public String getDownloadDirectory return mPrefs getString Name DOWNLOAD_DIRECTORY, Environment DIRECTORY_DOWNLOADS 
public int getFlashSupport return mPrefs getInt Name ADOBE_FLASH_SUPPORT, 0 
public boolean getFullScreenEnabled return mPrefs getBoolean Name FULL_SCREEN, false 
public boolean getGoogleSearchSuggestionsEnabled return mPrefs getBoolean Name GOOGLE_SEARCH_SUGGESTIONS, true 
public boolean getHideStatusBarEnabled return mPrefs getBoolean Name HIDE_STATUS_BAR, false 
public String getHomepage return mPrefs getString Name HOMEPAGE, Constants HOMEPAGE 
public boolean getIncognitoCookiesEnabled return mPrefs getBoolean Name INCOGNITO_COOKIES, false 
public static PreferenceManager getInstance if mInstance null mInstance new PreferenceManager return mInstance 
public boolean getInvertColors return mPrefs getBoolean Name INVERT_COLORS, false 
public boolean getJavaScriptEnabled return mPrefs getBoolean Name JAVASCRIPT, true 
public boolean getLocationEnabled return mPrefs getBoolean Name LOCATION, false 
public String getMemoryUrl return mPrefs getString Name URL_MEMORY, "" 
public boolean getOverviewModeEnabled return mPrefs getBoolean Name OVERVIEW_MODE, true 
public boolean getPopupsEnabled return mPrefs getBoolean Name POPUPS, true 
public String getProxyHost return mPrefs getString Name USE_PROXY_HOST, "localhost" 
public int getProxyPort return mPrefs getInt Name USE_PROXY_PORT, 8118 
public int getReadingTextSize return mPrefs getInt Name READING_TEXT_SIZE, 2 
public int getRenderingMode return mPrefs getInt Name RENDERING_MODE, 0 
public boolean getRestoreLostTabsEnabled return mPrefs getBoolean Name RESTORE_LOST_TABS, true 
public String getSavedUrl return mPrefs getString Name SAVE_URL, null 
public boolean getSavePasswordsEnabled return mPrefs getBoolean Name SAVE_PASSWORDS, true 
public int getSearchChoice return mPrefs getInt Name SEARCH, 1 
public String getSearchUrl return mPrefs getString Name SEARCH_URL, Constants GOOGLE_SEARCH 
public boolean getSyncHistoryEnabled return mPrefs getBoolean Name SYNC_HISTORY, true 
public boolean getSystemBrowserPresent return mPrefs getBoolean Name SYSTEM_BROWSER_PRESENT, false 
public boolean getTextReflowEnabled return mPrefs getBoolean Name TEXT_REFLOW, false 
public int getTextSize return mPrefs getInt Name TEXT_SIZE, 3 
public int getUrlBoxContentChoice return mPrefs getInt Name URL_BOX_CONTENTS, 0 
public boolean getUseDarkTheme return mPrefs getBoolean Name DARK_THEME, false 
public boolean getUseProxy return mPrefs getBoolean Name USE_PROXY, false 
public int getUserAgentChoice return mPrefs getInt Name USER_AGENT, 1 
public String getUserAgentString String def return mPrefs getString Name USER_AGENT_STRING, def 
public boolean getUseWideViewportEnabled return mPrefs getBoolean Name USE_WIDE_VIEWPORT, true 
private PreferenceManager mPrefs BrowserApp getAppContext getSharedPreferences PREFERENCES, 0 
private void putBoolean String name, boolean value mPrefs edit putBoolean name, value apply 
private void putInt String name, int value mPrefs edit putInt name, value apply 
private void putString String name, String value mPrefs edit putString name, value apply 
public void setAdBlockEnabled boolean enable putBoolean Name BLOCK_ADS, enable 
public void setBlockImagesEnabled boolean enable putBoolean Name BLOCK_IMAGES, enable 
public void setBlockThirdPartyCookiesEnabled boolean enable putBoolean Name BLOCK_THIRD_PARTY, enable 
public void setCheckedForTor boolean check putBoolean Name INITIAL_CHECK_FOR_TOR, check 
public void setClearCacheExit boolean enable putBoolean Name CLEAR_CACHE_EXIT, enable 
public void setClearCookiesExitEnabled boolean enable putBoolean Name CLEAR_COOKIES_EXIT, enable 
public void setClearHistoryExitEnabled boolean enable putBoolean Name CLEAR_HISTORY_EXIT, enable 
public void setColorModeEnabled boolean enable putBoolean Name ENABLE_COLOR_MODE, enable 
public void setCookiesEnabled boolean enable putBoolean Name COOKIES, enable 
public void setDefaultBookmarks boolean show putBoolean Name DEFAULT_BOOKMARKS, show 
public void setDownloadDirectory String directory putString Name DOWNLOAD_DIRECTORY, directory 
public void setFlashSupport int n putInt Name ADOBE_FLASH_SUPPORT, n 
public void setFullScreenEnabled boolean enable putBoolean Name FULL_SCREEN, enable 
public void setGoogleSearchSuggestionsEnabled boolean enabled putBoolean Name GOOGLE_SEARCH_SUGGESTIONS, enabled 
public void setHideStatusBarEnabled boolean enable putBoolean Name HIDE_STATUS_BAR, enable 
public void setHomepage String homepage putString Name HOMEPAGE, homepage 
public void setIncognitoCookiesEnabled boolean enable putBoolean Name INCOGNITO_COOKIES, enable 
public void setInvertColors boolean enable putBoolean Name INVERT_COLORS, enable 
public void setJavaScriptEnabled boolean enable putBoolean Name JAVASCRIPT, enable 
public void setLocationEnabled boolean enable putBoolean Name LOCATION, enable 
public void setMemoryUrl String url putString Name URL_MEMORY, url 
public void setOverviewModeEnabled boolean enable putBoolean Name OVERVIEW_MODE, enable 
public void setPopupsEnabled boolean enable putBoolean Name POPUPS, enable 
public void setReadingTextSize int size putInt Name READING_TEXT_SIZE, 2 
public void setRenderingMode int mode putInt Name RENDERING_MODE, mode 
public void setRestoreLostTabsEnabled boolean enable putBoolean Name RESTORE_LOST_TABS, enable 
public void setSavedUrl String url putString Name SAVE_URL, url 
public void setSavePasswordsEnabled boolean enable putBoolean Name SAVE_PASSWORDS, enable 
public void setSearchChoice int choice putInt Name SEARCH, choice 
public void setSearchUrl String url putString Name SEARCH_URL, url 
public void setSyncHistoryEnabled boolean enable putBoolean Name SYNC_HISTORY, enable 
public void setSystemBrowserPresent boolean available putBoolean Name SYSTEM_BROWSER_PRESENT, available 
public void setTextReflowEnabled boolean enable putBoolean Name TEXT_REFLOW, enable 
public void setTextSize int size putInt Name TEXT_SIZE, size 
public void setUrlBoxContentChoice int choice putInt Name URL_BOX_CONTENTS, choice 
public void setUseDarkTheme boolean use putBoolean Name DARK_THEME, use 
public void setUseProxy boolean enable putBoolean Name USE_PROXY, enable 
public void setUserAgentChoice int choice putInt Name USER_AGENT, choice 
public void setUserAgentString String agent putString Name USER_AGENT_STRING, agent 
public void setUseWideViewportEnabled boolean enable putBoolean Name USE_WIDE_VIEWPORT, enable 
private void cbClearCacheExit CheckBox view view setOnCheckedChangeListener new OnCheckedChangeListener Override public void onCheckedChanged CompoundButton buttonView, boolean isChecked mPreferences setClearCacheExit isChecked 
private void cbClearCookiesExit CheckBox view view setOnCheckedChangeListener new OnCheckedChangeListener Override public void onCheckedChanged CompoundButton buttonView, boolean isChecked mPreferences setClearCookiesExitEnabled isChecked 
private void cbClearHistoryExit CheckBox view view setOnCheckedChangeListener new OnCheckedChangeListener Override public void onCheckedChanged CompoundButton buttonView, boolean isChecked mPreferences setClearHistoryExitEnabled isChecked 
private void cbLocation CheckBox view view setOnCheckedChangeListener new OnCheckedChangeListener Override public void onCheckedChanged CompoundButton buttonView, boolean isChecked mPreferences setLocationEnabled isChecked 
private void cbSavePasswords CheckBox view view setOnCheckedChangeListener new OnCheckedChangeListener Override public void onCheckedChanged CompoundButton buttonView, boolean isChecked mPreferences setSavePasswordsEnabled isChecked 
private void cbThirdParty CheckBox view view setOnCheckedChangeListener new OnCheckedChangeListener Override public void onCheckedChanged CompoundButton buttonView, boolean isChecked mPreferences setBlockThirdPartyCookiesEnabled isChecked 
public void clearCache WebView webView new WebView this webView clearCache true webView destroy Utils showToast mContext, getResources getString R string message_cache_cleared 
SuppressWarnings "deprecation" public void clearCookies TODO Break out web storage deletion into its own optionaction TODO clear web storage for all sites that are visited in Incognito mode WebStorage storage WebStorage getInstance storage deleteAllData CookieManager c CookieManager getInstance if Build VERSION SDK_INT Build VERSION_CODES LOLLIPOP c removeAllCookies null else CookieSyncManager createInstance this c removeAllCookie messageHandler sendEmptyMessage 2 
SuppressWarnings "deprecation" public void clearHistory deleteDatabase HistoryDatabase DATABASE_NAME WebViewDatabase m WebViewDatabase getInstance this m clearFormData m clearHttpAuthUsernamePassword if API 18 m clearUsernamePassword WebIconDatabase getInstance removeAllIcons if mSystemBrowser try Browser clearHistory getContentResolver catch Exception ignored Utils trimCache this messageHandler sendEmptyMessage 1 
private void initialize RelativeLayout rLocation, rSavePasswords, rClearCacheExit, rClearHistoryExit, rClearCookiesExit, rClearCache, rClearHistory, rClearCookies, rThirdParty rLocation RelativeLayout findViewById R id rLocation rSavePasswords RelativeLayout findViewById R id rSavePasswords rClearCacheExit RelativeLayout findViewById R id rClearCacheExit rClearHistoryExit RelativeLayout findViewById R id rClearHistoryExit rClearCookiesExit RelativeLayout findViewById R id rClearCookiesExit rClearCache RelativeLayout findViewById R id rClearCache rClearHistory RelativeLayout findViewById R id rClearHistory rClearCookies RelativeLayout findViewById R id rClearCookies rThirdParty RelativeLayout findViewById R id rThirdParty cbLocation CheckBox findViewById R id cbLocation cbSavePasswords CheckBox findViewById R id cbSavePasswords cbClearCacheExit CheckBox findViewById R id cbClearCacheExit cbClearHistoryExit CheckBox findViewById R id cbClearHistoryExit cbClearCookiesExit CheckBox findViewById R id cbClearCookiesExit cbThirdParty CheckBox findViewById R id cbThirdParty cbLocation setChecked mPreferences getLocationEnabled cbSavePasswords setChecked mPreferences getSavePasswordsEnabled cbClearCacheExit setChecked mPreferences getClearCacheExit cbClearHistoryExit setChecked mPreferences getClearHistoryExitEnabled cbClearCookiesExit setChecked mPreferences getClearCookiesExitEnabled cbThirdParty setChecked mPreferences getBlockThirdPartyCookiesEnabled cbThirdParty setEnabled Build VERSION SDK_INT Build VERSION_CODES LOLLIPOP rLocation rLocation rSavePasswords rSavePasswords rClearCacheExit rClearCacheExit rClearHistoryExit rClearHistoryExit rClearCookiesExit rClearCookiesExit rClearCache rClearCache rClearHistory rClearHistory rClearCookies rClearCookies rThirdParty rThirdParty cbLocation cbLocation cbSavePasswords cbSavePasswords cbClearCacheExit cbClearCacheExit cbClearHistoryExit cbClearHistoryExit cbClearCookiesExit cbClearCookiesExit cbThirdParty cbThirdParty TextView syncHistory TextView findViewById R id isBrowserAvailable RelativeLayout layoutSyncHistory RelativeLayout findViewById R id rBrowserHistory final CheckBox cbSyncHistory CheckBox findViewById R id cbBrowserHistory layoutSyncHistory setOnClickListener new OnClickListener Override public void onClick View v cbSyncHistory setChecked cbSyncHistory isChecked cbSyncHistory setOnCheckedChangeListener new OnCheckedChangeListener Override public void onCheckedChanged CompoundButton buttonView, boolean isChecked mPreferences setSyncHistoryEnabled isChecked if mSystemBrowser cbSyncHistory setChecked false cbSyncHistory setEnabled false syncHistory setText getResources getString R string stock_browser_unavailable else cbSyncHistory setEnabled true cbSyncHistory setChecked mPreferences getSyncHistoryEnabled syncHistory setText getResources getString R string stock_browser_available messageHandler new MessageHandler mContext 
Override protected void onCreate Bundle savedInstanceState super onCreate savedInstanceState setContentView R layout privacy_settings set up ActionBar Toolbar toolbar Toolbar findViewById R id toolbar setSupportActionBar toolbar getSupportActionBar setDisplayHomeAsUpEnabled true mPreferences PreferenceManager getInstance mSystemBrowser mPreferences getSystemBrowserPresent mContext this initialize 
Override public boolean onOptionsItemSelected MenuItem item finish return true 
private void rClearCache RelativeLayout view view setOnClickListener new OnClickListener Override public void onClick View v TODO Autogenerated method stub clearCache 
private void rClearCacheExit RelativeLayout view view setOnClickListener new OnClickListener Override public void onClick View v TODO Autogenerated method stub cbClearCacheExit setChecked cbClearCacheExit isChecked 
private void rClearCookies RelativeLayout view view setOnClickListener new OnClickListener Override public void onClick View v AlertDialog Builder builder new AlertDialog Builder PrivacySettingsActivity this dialog builder setTitle getResources getString R string title_clear_cookies builder setMessage getResources getString R string dialog_cookies setPositiveButton getResources getString R string action_yes , new DialogInterface OnClickListener Override public void onClick DialogInterface arg0, int arg1 Thread clear new Thread new Runnable Override public void run clearCookies clear start setNegativeButton getResources getString R string action_no , new DialogInterface OnClickListener Override public void onClick DialogInterface arg0, int arg1 show 
private void rClearCookiesExit RelativeLayout view view setOnClickListener new OnClickListener Override public void onClick View v TODO Autogenerated method stub cbClearCookiesExit setChecked cbClearCookiesExit isChecked 
private void rClearHistory RelativeLayout view view setOnClickListener new OnClickListener Override public void onClick View v AlertDialog Builder builder new AlertDialog Builder PrivacySettingsActivity this dialog builder setTitle getResources getString R string title_clear_history builder setMessage getResources getString R string dialog_history setPositiveButton getResources getString R string action_yes , new DialogInterface OnClickListener Override public void onClick DialogInterface arg0, int arg1 Thread clear new Thread new Runnable Override public void run clearHistory clear start setNegativeButton getResources getString R string action_no , new DialogInterface OnClickListener Override public void onClick DialogInterface arg0, int arg1 TODO Autogenerated method stub show 
private void rClearHistoryExit RelativeLayout view view setOnClickListener new OnClickListener Override public void onClick View v TODO Autogenerated method stub cbClearHistoryExit setChecked cbClearHistoryExit isChecked 
private void rLocation RelativeLayout view view setOnClickListener new OnClickListener Override public void onClick View v TODO Autogenerated method stub cbLocation setChecked cbLocation isChecked 
private void rSavePasswords RelativeLayout view view setOnClickListener new OnClickListener Override public void onClick View v TODO Autogenerated method stub cbSavePasswords setChecked cbSavePasswords isChecked 
private void rThirdParty RelativeLayout view view setOnClickListener new OnClickListener Override public void onClick View v TODO Autogenerated method stub if Build VERSION SDK_INT Build VERSION_CODES LOLLIPOP cbThirdParty setChecked cbThirdParty isChecked else Utils showToast mContext, mContext getString R string available_lollipop 
Override public void handleMessage Message msg switch msg what case 1 Utils showToast mHandlerContext, mHandlerContext getResources getString R string message_clear_history break case 2 Utils showToast mHandlerContext, mHandlerContext getResources getString R string message_cookies_cleared break super handleMessage msg 
public MessageHandler Context context this mHandlerContext context 
public void addProxy Proxy Type type,String host, int port Proxy proxy new Proxy type,new InetSocketAddress host, port listProxies add proxy 
Override public void connectFailed URI uri, SocketAddress address, IOException failure Log w "ProxySelector","could not connect to " address toString " " failure getMessage 
public ProxySelector super listProxies new ArrayListProxy 
Override public ListProxy select URI uri return listProxies 
private float getTextSize int size switch size case 0 return XSMALL case 1 return SMALL case 2 return MEDIUM case 3 return LARGE case 4 return XLARGE case 5 return XXLARGE default return MEDIUM 
protected boolean loadPage Intent intent if intent null return false mUrl intent getStringExtra Constants LOAD_READING_URL if mUrl null return false getSupportActionBar setTitle Utils getDomainName mUrl new PageLoader this execute mUrl return true 
Override protected void onCreate Bundle savedInstanceState mPreferences PreferenceManager getInstance mInvert mPreferences getInvertColors if mInvert this setTheme R style Theme_SettingsTheme_Dark super onCreate savedInstanceState setContentView R layout reading_view Toolbar toolbar Toolbar findViewById R id toolbar setSupportActionBar toolbar getSupportActionBar setDisplayHomeAsUpEnabled true mTitle TextView findViewById R id textViewTitle mBody TextView findViewById R id textViewBody mTextSize mPreferences getReadingTextSize mBody setTextSize getTextSize mTextSize mTitle setText getString R string untitled mBody setText getString R string loading mTitle setVisibility View INVISIBLE mBody setVisibility View INVISIBLE Intent intent getIntent if loadPage intent setText getString R string untitled , getString R string loading_failed 
Override public boolean onCreateOptionsMenu Menu menu getMenuInflater inflate R menu reading, menu return super onCreateOptionsMenu menu 
Override public boolean onOptionsItemSelected MenuItem item switch item getItemId case R id invert_item mPreferences setInvertColors mInvert Intent read new Intent this, ReadingActivity class read putExtra Constants LOAD_READING_URL, mUrl startActivity read finish break case R id text_size_item AlertDialog Builder builder new AlertDialog Builder this LayoutInflater inflater this getLayoutInflater View view inflater inflate R layout seek_layout, null final SeekBar bar SeekBar view findViewById R id text_size_seekbar bar setOnSeekBarChangeListener new OnSeekBarChangeListener Override public void onProgressChanged SeekBar view, int size, boolean user mBody setTextSize getTextSize size Override public void onStartTrackingTouch SeekBar arg0 Override public void onStopTrackingTouch SeekBar arg0 bar setMax 5 bar setProgress mTextSize builder setView view builder setTitle R string size builder setPositiveButton android R string ok, new OnClickListener Override public void onClick DialogInterface arg0, int arg1 mTextSize bar getProgress mBody setTextSize getTextSize mTextSize mPreferences setReadingTextSize bar getProgress builder show break default finish break return super onOptionsItemSelected item 
private void setText String title, String body if mTitle getVisibility View INVISIBLE mTitle setAlpha 0 0f mTitle setVisibility View VISIBLE mTitle setText title ObjectAnimator animator ObjectAnimator ofFloat mTitle, "alpha", 1 0f animator setDuration 300 animator start else mTitle setText title if mBody getVisibility View INVISIBLE mBody setAlpha 0 0f mBody setVisibility View VISIBLE mBody setText body ObjectAnimator animator ObjectAnimator ofFloat mBody, "alpha", 1 0f animator setDuration 300 animator start else mBody setText body 
Override protected Void doInBackground String params HtmlFetcher fetcher new HtmlFetcher try JResult result fetcher fetchAndExtract params[0], 5000, true mTitleText result getTitle mBodyText result getTextList catch Exception e mTitleText "" mBodyText new ArrayList e printStackTrace catch OutOfMemoryError e System gc mTitleText "" mBodyText new ArrayList e printStackTrace return null 
Override protected void onPostExecute Void result mProgressDialog dismiss if mTitleText isEmpty mBodyText isEmpty setText getString R string untitled , getString R string loading_failed else StringBuilder builder new StringBuilder for String text mBodyText builder append text append "\n\n" setText mTitleText, builder toString super onPostExecute result 
Override protected void onPreExecute super onPreExecute mProgressDialog new ProgressDialog mContext mProgressDialog setProgressStyle ProgressDialog STYLE_SPINNER mProgressDialog setCancelable false mProgressDialog setIndeterminate true mProgressDialog setMessage mContext getString R string loading mProgressDialog show 
public PageLoader Context context mContext context 
private void deleteOldCacheFiles Context context File dir new File context getCacheDir toString String[] fileList dir list new NameFilter long earliestTimeAllowed System currentTimeMillis INTERVAL_DAY for String fileName fileList File file new File dir getPath fileName if earliestTimeAllowed file lastModified file delete 
private File downloadSuggestionsForQuery String query File cacheFile new File mContext getCacheDir , query hashCode " sgg" if System currentTimeMillis INTERVAL_DAY cacheFile lastModified return cacheFile if isNetworkConnected mContext return cacheFile try URL url new URL "httpgoogle comcompletesearch?q" query "outputtoolbarhlen" HttpURLConnection connection HttpURLConnection url openConnection connection setDoInput true connection connect InputStream in connection getInputStream if in null FileOutputStream fos new FileOutputStream cacheFile int buffer while buffer in read 1 fos write buffer fos flush fos close cacheFile setLastModified System currentTimeMillis catch Exception e e printStackTrace return cacheFile 
private NetworkInfo getActiveNetworkInfo Context context ConnectivityManager connectivity ConnectivityManager context getSystemService Context CONNECTIVITY_SERVICE if connectivity null return null return connectivity getActiveNetworkInfo 
Override public int getCount if mFilteredList null return mFilteredList size else return 0 
Override public Filter getFilter if mFilter null mFilter new SearchFilter return mFilter 
Override public Object getItem int position return mFilteredList get position 
Override public long getItemId int position return 0 
public ListHistoryItem getSuggestions ListHistoryItem filteredList new ArrayList int suggestionsSize mSuggestions null ? 0 mSuggestions size int historySize mHistory null ? 0 mHistory size int bookmarkSize mBookmarks null ? 0 mBookmarks size int maxSuggestions bookmarkSize historySize 3 ? 5 bookmarkSize historySize bookmarkSize 2 ? 4 bookmarkSize historySize 1 ? 3 2 int maxHistory suggestionsSize bookmarkSize 4 ? 5 suggestionsSize bookmarkSize 1 int maxBookmarks suggestionsSize historySize 3 ? 5 suggestionsSize historySize 2 if mUseGoogle mIncognito maxHistory maxBookmarks for int n 0 n bookmarkSize n maxBookmarks n filteredList add mBookmarks get n for int n 0 n historySize n maxHistory n filteredList add mHistory get n for int n 0 n suggestionsSize n maxSuggestions n filteredList add mSuggestions get n return filteredList 
SuppressWarnings "deprecation" SuppressLint "NewApi" Override public View getView int position, View convertView, ViewGroup parent View row convertView SuggestionHolder holder if row null LayoutInflater inflater Activity mContext getLayoutInflater row inflater inflate R layout two_line_autocomplete, parent, false holder new SuggestionHolder holder mTitle TextView row findViewById R id title holder mUrl TextView row findViewById R id url holder mImage ImageView row findViewById R id suggestionIcon row setTag holder else holder SuggestionHolder row getTag HistoryItem web mFilteredList get position holder mTitle setText web getTitle holder mUrl setText web getUrl int imageId R drawable ic_bookmark switch web getImageId case R drawable ic_bookmark if mDarkTheme imageId R drawable ic_bookmark else holder mTitle setTextColor Color WHITE imageId R drawable ic_bookmark_dark break case R drawable ic_search if mDarkTheme imageId R drawable ic_search else holder mTitle setTextColor Color WHITE imageId R drawable ic_search_dark break case R drawable ic_history if mDarkTheme imageId R drawable ic_history else holder mTitle setTextColor Color WHITE imageId R drawable ic_history_dark break if API Build VERSION_CODES LOLLIPOP holder mImage setImageDrawable mContext getResources getDrawable imageId else holder mImage setImageDrawable mContext getResources getDrawable imageId, mTheme return row 
private boolean isNetworkConnected Context context NetworkInfo networkInfo getActiveNetworkInfo context return networkInfo null networkInfo isConnected 
public void refreshBookmarks mAllBookmarks mBookmarkManager getBookmarks true 
public void refreshPreferences mUseGoogle PreferenceManager getInstance getGoogleSearchSuggestionsEnabled if mUseGoogle mSuggestions null mSuggestions clear 
public SearchAdapter Context context, boolean dark, boolean incognito mDatabaseHandler HistoryDatabase getInstance context getApplicationContext mTheme context getTheme mFilteredList new ArrayList mHistory new ArrayList mBookmarks new ArrayList mSuggestions new ArrayList mBookmarkManager BookmarkManager getInstance context getApplicationContext mAllBookmarks mBookmarkManager getBookmarks true mUseGoogle PreferenceManager getInstance getGoogleSearchSuggestionsEnabled mContext context mSearchSubtitle mContext getString R string suggestion mDarkTheme dark incognito mIncognito incognito Thread delete new Thread new Runnable Override public void run deleteOldCacheFiles mContext delete start 
public void setContents ListHistoryItem list if mFilteredList null mFilteredList clear mFilteredList addAll list else mFilteredList list notifyDataSetChanged 
Override public boolean accept File dir, String filename return filename endsWith ext 
Override protected ListHistoryItem doInBackground String arg0 mIsExecuting true ListHistoryItem filter new ArrayList String query arg0[0] try query query replace " ", "" URLEncoder encode query, ENCODING catch UnsupportedEncodingException e e printStackTrace File cache downloadSuggestionsForQuery query if cache exists return filter InputStream fileInput null try fileInput new BufferedInputStream new FileInputStream cache if mFactory null mFactory XmlPullParserFactory newInstance mFactory setNamespaceAware true if mXpp null mXpp mFactory newPullParser mXpp setInput fileInput, ENCODING int eventType mXpp getEventType int counter 0 while eventType XmlPullParser END_DOCUMENT if eventType XmlPullParser START_TAG "suggestion" equals mXpp getName String suggestion mXpp getAttributeValue null, "data" filter add new HistoryItem mSearchSubtitle " \"" suggestion '"', suggestion, R drawable ic_search counter if counter 5 break eventType mXpp next catch Exception e return filter finally if fileInput null try fileInput close catch IOException e e printStackTrace return filter 
Override protected void onPostExecute ListHistoryItem result mSuggestions result mFilteredList getSuggestions notifyDataSetChanged mIsExecuting false 
Override public CharSequence convertResultToString Object resultValue return HistoryItem resultValue getUrl 
Override protected FilterResults performFiltering CharSequence constraint FilterResults results new FilterResults if constraint null return results String query constraint toString toLowerCase Locale getDefault if mUseGoogle mIncognito mIsExecuting new RetrieveSearchSuggestions execute query int counter 0 mBookmarks new ArrayList for int n 0 n mAllBookmarks size n if counter 5 break if mAllBookmarks get n getTitle toLowerCase Locale getDefault startsWith query mBookmarks add mAllBookmarks get n counter else if mAllBookmarks get n getUrl contains query mBookmarks add mAllBookmarks get n counter if mDatabaseHandler null mDatabaseHandler HistoryDatabase getInstance mContext getApplicationContext mHistory mDatabaseHandler findItemsContaining constraint toString results count 1 return results 
Override protected void publishResults CharSequence constraint, FilterResults results mFilteredList getSuggestions notifyDataSetChanged 
public void about RelativeLayout view view setOnClickListener new OnClickListener Override public void onClick View v startActivity new Intent mContext, AboutSettingsActivity class 
public void advanced RelativeLayout view view setOnClickListener new OnClickListener Override public void onClick View v startActivity new Intent mContext, AdvancedSettingsActivity class 
public void agentPicker final AlertDialog Builder agentStringPicker new AlertDialog Builder mActivity agentStringPicker setTitle getResources getString R string title_user_agent final EditText getAgent new EditText this getAgent append mPreferences getUserAgentString "" agentStringPicker setView getAgent agentStringPicker setPositiveButton getResources getString R string action_ok , new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which String text getAgent getText toString mPreferences setUserAgentString text getAgent setText getResources getString R string agent_custom agentStringPicker show 
public void clickListenerForCheckBoxes RelativeLayout layoutFlash, RelativeLayout layoutBlockAds, RelativeLayout layoutImages, RelativeLayout layoutEnableJS, RelativeLayout layoutOrbot, RelativeLayout layoutColor, final CheckBox flash, final CheckBox adblock, final CheckBox images, final CheckBox enablejs, final CheckBox orbot, final CheckBox color layoutFlash setOnClickListener new OnClickListener Override public void onClick View v if API 19 flash setChecked flash isChecked else Utils createInformativeDialog mContext, getResources getString R string title_warning , getResources getString R string dialog_adobe_dead layoutBlockAds setOnClickListener new OnClickListener Override public void onClick View v adblock setChecked adblock isChecked layoutImages setOnClickListener new OnClickListener Override public void onClick View v images setChecked images isChecked layoutEnableJS setOnClickListener new OnClickListener Override public void onClick View v enablejs setChecked enablejs isChecked layoutOrbot setOnClickListener new OnClickListener Override public void onClick View v if orbot isEnabled orbot setChecked orbot isChecked else Utils showToast mContext, getResources getString R string install_orbot layoutColor setOnClickListener new OnClickListener Override public void onClick View v color setChecked color isChecked 
public void display RelativeLayout view view setOnClickListener new OnClickListener Override public void onClick View v startActivity new Intent mContext, DisplaySettingsActivity class 
public void general RelativeLayout view view setOnClickListener new OnClickListener Override public void onClick View v startActivity new Intent mContext, GeneralSettingsActivity class 
private void getFlashChoice AlertDialog Builder builder new AlertDialog Builder mActivity builder setTitle mContext getResources getString R string title_flash builder setMessage getResources getString R string flash setCancelable true setPositiveButton getResources getString R string action_manual , new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int id mPreferences setFlashSupport 1 setNegativeButton getResources getString R string action_auto , new DialogInterface OnClickListener Override public void onClick DialogInterface dialog, int which mPreferences setFlashSupport 2 setOnCancelListener new OnCancelListener Override public void onCancel DialogInterface dialog mPreferences setFlashSupport 0 AlertDialog alert builder create alert show 
SuppressLint "NewApi" public void init set up ActionBar Toolbar toolbar Toolbar findViewById R id toolbar setSupportActionBar toolbar getSupportActionBar setDisplayHomeAsUpEnabled true mPreferences storage mPreferences PreferenceManager getInstance initialize UI RelativeLayout layoutFlash RelativeLayout findViewById R id layoutFlash RelativeLayout layoutBlockAds RelativeLayout findViewById R id layoutAdBlock layoutBlockAds setEnabled Constants FULL_VERSION RelativeLayout layoutImages RelativeLayout findViewById R id layoutImages RelativeLayout layoutEnableJS RelativeLayout findViewById R id layoutEnableJS RelativeLayout layoutOrbot RelativeLayout findViewById R id layoutUseOrbot RelativeLayout layoutColor RelativeLayout findViewById R id layoutColorMode RelativeLayout layoutBookmarks RelativeLayout findViewById R id layoutBookmarks layoutBookmarks setOnClickListener new OnClickListener Override public void onClick View v startActivity new Intent mContext, BookmarkActivity class if API 19 mPreferences setFlashSupport 0 int flashNum mPreferences getFlashSupport boolean imagesBool mPreferences getBlockImagesEnabled boolean enableJSBool mPreferences getJavaScriptEnabled CheckBox flash CheckBox findViewById R id cbFlash CheckBox adblock CheckBox findViewById R id cbAdblock adblock setEnabled Constants FULL_VERSION CheckBox images CheckBox findViewById R id cbImageBlock CheckBox enablejs CheckBox findViewById R id cbJavascript CheckBox orbot CheckBox findViewById R id cbOrbot CheckBox color CheckBox findViewById R id cbColorMode images setChecked imagesBool enablejs setChecked enableJSBool if flashNum 0 flash setChecked true else flash setChecked false adblock setChecked mPreferences getAdBlockEnabled orbot setChecked mPreferences getUseProxy color setChecked mPreferences getColorModeEnabled initCheckBox flash, adblock, images, enablejs, orbot, color clickListenerForCheckBoxes layoutFlash, layoutBlockAds, layoutImages, layoutEnableJS, layoutOrbot, layoutColor, flash, adblock, images, enablejs, orbot, color RelativeLayout general RelativeLayout findViewById R id layoutGeneral RelativeLayout display RelativeLayout findViewById R id layoutDisplay RelativeLayout privacy RelativeLayout findViewById R id layoutPrivacy RelativeLayout advanced RelativeLayout findViewById R id layoutAdvanced RelativeLayout about RelativeLayout findViewById R id layoutAbout general general display display privacy privacy advanced advanced about about 
public void initCheckBox CheckBox flash, CheckBox adblock, CheckBox images, CheckBox enablejs, CheckBox orbot, CheckBox color flash setEnabled API 19 flash setOnCheckedChangeListener new OnCheckedChangeListener Override public void onCheckedChanged CompoundButton buttonView, boolean isChecked if isChecked getFlashChoice else mPreferences setFlashSupport 0 boolean flashInstalled false try PackageManager pm getPackageManager ApplicationInfo ai pm getApplicationInfo "com adobe flashplayer", 0 if ai null flashInstalled true catch NameNotFoundException e flashInstalled false if flashInstalled isChecked Utils createInformativeDialog SettingsActivity this, getResources getString R string title_warning , getResources getString R string dialog_adobe_not_installed buttonView setChecked false mPreferences setFlashSupport 0 else if API 17 isChecked Utils createInformativeDialog SettingsActivity this, getResources getString R string title_warning , getResources getString R string dialog_adobe_unsupported adblock setOnCheckedChangeListener new OnCheckedChangeListener Override public void onCheckedChanged CompoundButton buttonView, boolean isChecked mPreferences setAdBlockEnabled isChecked images setOnCheckedChangeListener new OnCheckedChangeListener Override public void onCheckedChanged CompoundButton buttonView, boolean isChecked mPreferences setBlockImagesEnabled isChecked enablejs setOnCheckedChangeListener new OnCheckedChangeListener Override public void onCheckedChanged CompoundButton buttonView, boolean isChecked mPreferences setJavaScriptEnabled isChecked OrbotHelper oh new OrbotHelper this if oh isOrbotInstalled orbot setEnabled false orbot setOnCheckedChangeListener new OnCheckedChangeListener Override public void onCheckedChanged CompoundButton buttonView, boolean isChecked mPreferences setUseProxy isChecked color setOnCheckedChangeListener new OnCheckedChangeListener Override public void onCheckedChanged CompoundButton buttonView, boolean isChecked mPreferences setColorModeEnabled isChecked 
Override protected void onCreate Bundle savedInstanceState super onCreate savedInstanceState setContentView R layout settings mContext this mActivity this init 
Override public boolean onOptionsItemSelected MenuItem item finish return true 
public void privacy RelativeLayout view view setOnClickListener new OnClickListener Override public void onClick View v startActivity new Intent mContext, PrivacySettingsActivity class 
public static String completeDate String dateStr if dateStr null return null int index dateStr indexOf '' if index 0 index dateStr indexOf '', index 1 if index 0 return dateStr else return dateStr "01" return dateStr "0101" 
public static int count String str, String substring int c 0 int index1 str indexOf substring if index1 0 c c count str substring index1 substring length , substring return c 
public static int countLetters String str int len str length int chars 0 for int i 0 i len i if Character isLetter str charAt i chars return chars 
keep in mind simpleDateFormatter is not thread safe call completeDate before applying this formatter public static SimpleDateFormat createDateFormatter return new SimpleDateFormat "yyyyMMdd", Locale getDefault 
public static void enableAnySSL try SSLContext ctx SSLContext getInstance "TLS" ctx init new KeyManager[0], new TrustManager[] new DefaultTrustManager , new SecureRandom SSLContext setDefault ctx catch Exception ex ex printStackTrace 
see http blogs sun comCoreJavaTechTipsentrycookie_handling_in_java_se public static void enableCookieMgmt CookieManager manager new CookieManager manager setCookiePolicy CookiePolicy ACCEPT_ALL CookieHandler setDefault manager 
see http stackoverflow comquestions2529682settinguseragentofajava urlconnection public static void enableUserAgentOverwrite System setProperty "http agent", "" 
Starts reading the encoding from the first valid character until an invalid encoding character occurs public static String encodingCleanup String str StringBuilder sb new StringBuilder boolean startedWithCorrectString false for int i 0 i str length i char c str charAt i if Character isDigit c Character isLetter c c '' c '_' startedWithCorrectString true sb append c continue if startedWithCorrectString break return sb toString trim 
public static String estimateDate String url int index url indexOf "" if index 0 url url substring index 3 int year 1 int yearCounter 1 int month 1 int monthCounter 1 int day 1 String strs[] url split "" for int counter 0 counter strs length counter String str strs[counter] if str length 4 try year Integer parseInt str catch Exception ex continue if year 1970 year 3000 year 1 continue yearCounter counter else if str length 2 if monthCounter 0 counter yearCounter 1 try month Integer parseInt str catch Exception ex continue if month 1 month 12 month 1 continue monthCounter counter else if counter monthCounter 1 try day Integer parseInt str catch Exception ex ex printStackTrace if day 1 day 31 day 1 continue break if year 0 return null StringBuilder str new StringBuilder str append year if month 1 return str toString str append '' if month 10 str append '0' str append month if day 1 return str toString str append '' if day 10 str append '0' str append day return str toString 
public static String extractDomain String url, boolean aggressive if url startsWith "http" url url substring "http" length else if url startsWith "https" url url substring "https" length if aggressive if url startsWith "www " url url substring "www " length strip mobile from start if url startsWith "m " url url substring "m " length int slashIndex url indexOf "" if slashIndex 0 url url substring 0, slashIndex return url 
public static String extractHost String url return extractDomain url, false 
public static String getDefaultFavicon String url return useDomainOfFirstArg4Second url, "favicon ico" 
return the longest substring as str1 substring result[0], result[1] public static String getLongestSubstring String str1, String str2 int res[] longestSubstring str1, str2 if res null res[0] res[1] return "" return str1 substring res[0], res[1] 
public static String getUrlFromUglyFacebookRedirect String url if url startsWith "httpwww facebook coml php?u" url url substring "httpwww facebook coml php?u" length return urlDecode url return null 
public static String getUrlFromUglyGoogleRedirect String url if url startsWith "httpwww google comurl?" url url substring "httpwww google comurl?" length String arr[] urlDecode url split "\\" for String str arr if str startsWith "q" return str substring "q" length return null 
remove more than two spaces or newlines public static String innerTrim String str if str isEmpty return "" StringBuilder sb new StringBuilder boolean previousSpace false for int i 0 i str length i char c str charAt i if c ' ' int c 9 c '\n' previousSpace true continue if previousSpace sb append ' ' previousSpace false sb append c return sb toString trim 
public static boolean isApp String url return url endsWith " exe" url endsWith " bin" url endsWith " bat" url endsWith " dmg" 
public static boolean isAudio String url return url endsWith " mp3" url endsWith " ogg" url endsWith " m3u" url endsWith " wav" 
public static boolean isDoc String url return url endsWith " pdf" url endsWith " ppt" url endsWith " doc" url endsWith " swf" url endsWith " rtf" url endsWith " xls" 
public static boolean isImage String url return url endsWith " png" url endsWith " jpeg" url endsWith " gif" url endsWith " jpg" url endsWith " bmp" url endsWith " ico" url endsWith " eps" 
public static boolean isPackage String url return url endsWith " gz" url endsWith " tgz" url endsWith " zip" url endsWith " rar" url endsWith " deb" url endsWith " rpm" url endsWith " 7z" 
public static boolean isVideo String url return url endsWith " mpeg" url endsWith " mpg" url endsWith " avi" url endsWith " mov" url endsWith " mpg4" url endsWith " mp4" url endsWith " flv" url endsWith " wmv" 
public static boolean isVideoLink String url url extractDomain url, true return url startsWith "youtube com" url startsWith "video yahoo com" url startsWith "vimeo com" url startsWith "blip tv" 
public static int[] longestSubstring String str1, String str2 if str1 null str1 isEmpty str2 null str2 isEmpty return null dynamic programming save already identical length into array to understand this algo simply print identical length in every entry of the array i1, j1 then reuses information from i,j java initializes them already with 0 int[][] num new int[str1 length ][str2 length ] int maxlen 0 int lastSubstrBegin 0 int endIndex 0 for int i 0 i str1 length i for int j 0 j str2 length j if str1 charAt i str2 charAt j if i 0 j 0 num[i][j] 1 else num[i][j] 1 num[i 1][j 1] if num[i][j] maxlen maxlen num[i][j] generate substring from str1 i lastSubstrBegin i num[i][j] 1 endIndex i 1 return new int[] lastSubstrBegin, endIndex 
public static String printNode Element root, int indentation StringBuilder sb new StringBuilder for int i 0 i indentation i sb append ' ' sb append root tagName sb append "" sb append root ownText sb append "\n" for Element el root children sb append printNode el, indentation 1 sb append "\n" return sb toString 
Popular sites uses the # to indicate the importance of the following chars Ugly but true Such as facebook, twitter, gizmodo, public static String removeHashbang String url return url replaceFirst "#", "" 
public static String replaceSpaces String url if url isEmpty url url trim if url contains " " Matcher spaces SPACE matcher url url spaces replaceAll "20" return url 
public static String urlDecode String str try return URLDecoder decode str, UTF8 catch UnsupportedEncodingException ex return str 
public static String urlEncode String str try return URLEncoder encode str, UTF8 catch UnsupportedEncodingException ex return str 
param urlForDomain extract the domain from this url param path this url does not have a domain return public static String useDomainOfFirstArg4Second String urlForDomain, String path if path startsWith "http" return path if "favicon ico" equals path path "favicon ico" if path startsWith "" wikipedia special case, see tests if urlForDomain startsWith "https" return "https" path return "http" path else if path startsWith "" return "http" extractHost urlForDomain path else if path startsWith " " int slashIndex urlForDomain lastIndexOf "" if slashIndex 0 slashIndex 1 urlForDomain length urlForDomain urlForDomain substring 0, slashIndex 1 return urlForDomain path return path 
Override public X509Certificate[] getAcceptedIssuers return null 
Override public void openConnection final OperatedClientConnection conn, final HttpHost target, final InetAddress local, final HttpContext context, final HttpParams params throws IOException Socket socket null Socket sslSocket null try if conn null target null params null throw new IllegalArgumentException "Required argument may not be null" if conn isOpen throw new IllegalStateException "Connection must not be open" Scheme scheme schemeRegistry getScheme target getSchemeName SchemeSocketFactory schemeSocketFactory scheme getSchemeSocketFactory int port scheme resolvePort target getPort String host target getHostName Perform explicit SOCKS4a connection request SOCKS4a supports remote host name resolution i e , Tor resolves the hostname, which may be an onion address The Android Apache Harmony Socket class appears to support only SOCKS4 and throws an exception on an address created using INetAddress createUnresolved so the typical technique for using Java SOCKS4a5 doesn't appear to work on Android httpsandroid googlesource complatformlibcoremasterlunisrcmainjavajavanetPlainSocketImpl java See also httpwww mit edu~foleyTinFoilsrctinfoilTorLib java, for a similar implementation From httpen wikipedia orgwikiSOCKS#SOCKS4a field 1 SOCKS version number, 1 byte, must be 0x04 for this version field 2 command code, 1 byte 0x01 establish a TCPIP stream connection 0x02 establish a TCPIP port binding field 3 network byte order port number, 2 bytes field 4 deliberate invalid IP address, 4 bytes, first three must be 0x00 and the last one must not be 0x00 field 5 the user ID string, variable length, terminated with a null 0x00 field 6 the domain name of the host we want to contact, variable length, terminated with a null 0x00 socket new Socket conn opening socket, target socket setSoTimeout READ_TIMEOUT_MILLISECONDS socket connect new InetSocketAddress mProxyHost, mProxyPort , CONNECT_TIMEOUT_MILLISECONDS DataOutputStream outputStream new DataOutputStream socket getOutputStream outputStream write byte 0x04 outputStream write byte 0x01 outputStream writeShort short port outputStream writeInt 0x01 outputStream write byte 0x00 outputStream write host getBytes outputStream write byte 0x00 DataInputStream inputStream new DataInputStream socket getInputStream if inputStream readByte byte 0x00 inputStream readByte byte 0x5a throw new IOException "SOCKS4a connect failed" inputStream readShort inputStream readInt if schemeSocketFactory instanceof SSLSocketFactory sslSocket SSLSocketFactory schemeSocketFactory createLayeredSocket socket, host, port, params conn opening sslSocket, target sslSocket setSoTimeout READ_TIMEOUT_MILLISECONDS prepareSocket sslSocket, context, params conn openCompleted schemeSocketFactory isSecure sslSocket , params else conn opening socket, target socket setSoTimeout READ_TIMEOUT_MILLISECONDS prepareSocket socket, context, params conn openCompleted schemeSocketFactory isSecure socket , params TODO clarify which connection throws java net SocketTimeoutException? catch IOException e try if sslSocket null sslSocket close if socket null socket close catch IOException ioe throw e 
Override protected InetAddress[] resolveHostname final String host throws UnknownHostException throw new RuntimeException "operation not supported" 
public SocksProxyClientConnOperator SchemeRegistry registry, String proxyHost, int proxyPort super registry mProxyHost proxyHost mProxyPort proxyPort 
Override public void updateSecureConnection final OperatedClientConnection conn, final HttpHost target, final HttpContext context, final HttpParams params throws IOException throw new RuntimeException "operation not supported" 
Override protected ThreadSafeClientConnManager createClientConnectionManager if proxyHost null proxyType null Log d "StrongHTTPS", "not proxying" return new MyThreadSafeClientConnManager getParams , mRegistry else if proxyHost null proxyType equalsIgnoreCase "socks" Log d "StrongHTTPS", "proxying using " proxyType return new MyThreadSafeClientConnManager getParams , mRegistry Override protected ClientConnectionOperator createConnectionOperator SchemeRegistry schreg return new SocksProxyClientConnOperator schreg, proxyHost getHostName , proxyHost getPort else Log d "StrongHTTPS", "proxying with " proxyType return new MyThreadSafeClientConnManager getParams , mRegistry 
public void disableProxy getParams removeParameter ConnRoutePNames DEFAULT_PROXY proxyHost null 
public TrustManager getTrustManager return mTrustManager 
private KeyStore loadKeyStore throws KeyStoreException, NoSuchAlgorithmException, CertificateException, IOException KeyStore trustStore KeyStore getInstance TRUSTSTORE_TYPE load our bundled cacerts from raw assets InputStream in context getResources openRawResource R raw debiancacerts trustStore load in, TRUSTSTORE_PASSWORD toCharArray return trustStore 
public StrongHttpsClient Context context, KeyStore keystore this context context mRegistry new SchemeRegistry mRegistry register new Scheme TYPE_HTTP, 80, PlainSocketFactory getSocketFactory try mTrustManager new StrongTrustManager context, keystore TrustManagerFactory trustManagerFactory TrustManagerFactory getInstance TrustManagerFactory getDefaultAlgorithm for TrustManager trustManager trustManagerFactory getTrustManagers if trustManager instanceof X509TrustManager mTrustManager trustManagerFactory getTrustManagers [0] sFactory new StrongSSLSocketFactory context, mTrustManager, keystore, TRUSTSTORE_PASSWORD mRegistry register new Scheme "https", 443, sFactory catch Exception e throw new AssertionError e 
public void useProxy boolean enableTor, String type, String host, int port if enableTor this proxyType type HttpHost proxyHost new HttpHost host, port, type getParams setParameter ConnRoutePNames DEFAULT_PROXY, proxyHost if type equalsIgnoreCase TYPE_SOCKS this proxyHost proxyHost else getParams removeParameter ConnRoutePNames DEFAULT_PROXY proxyHost null 
private KeyManager[] createKeyManagers final KeyStore keystore, final String password throws KeyStoreException, NoSuchAlgorithmException, UnrecoverableKeyException if keystore null throw new IllegalArgumentException "Keystore may not be null" KeyManagerFactory kmfactory KeyManagerFactory getInstance KeyManagerFactory getDefaultAlgorithm kmfactory init keystore, password null ? password toCharArray null return kmfactory getKeyManagers 
Override public Socket createLayeredSocket Socket arg0, String arg1, int arg2, boolean arg3 throws IOException, UnknownHostException return LayeredSchemeSocketFactory mFactory createLayeredSocket arg0, arg1, arg2, arg3 
Override public Socket createSocket HttpParams httpParams throws IOException Socket newSocket mFactory createSocket enableStrongerDefaults newSocket return newSocket 
Defaults the SSL connection to use a strong cipher suite and TLS version param socket private void enableStrongerDefaults Socket socket if isSecure socket SSLSocket sslSocket SSLSocket socket readSSLParameters sslSocket if mEnableStongerDefaultProtocalVersion mProtocols null sslSocket setEnabledProtocols mProtocols if mEnableStongerDefaultSSLCipherSuite mCipherSuites null sslSocket setEnabledCipherSuites mCipherSuites 
public Proxy getProxy return mProxy 
public boolean isEnableStongerDefaultProtocalVersion return mEnableStongerDefaultProtocalVersion 
public boolean isEnableStongerDefaultSSLCipherSuite return mEnableStongerDefaultSSLCipherSuite 
Override public boolean isSecure Socket sock throws IllegalArgumentException return sock instanceof SSLSocket 
private void readSSLParameters SSLSocket sslSocket ListString protocolsToEnable new ArrayListString ListString supportedProtocols Arrays asList sslSocket getSupportedProtocols for String enabledProtocol OnionKitHelper ENABLED_PROTOCOLS if supportedProtocols contains enabledProtocol protocolsToEnable add enabledProtocol this mProtocols protocolsToEnable toArray new String[protocolsToEnable size ] ListString cipherSuitesToEnable new ArrayListString ListString supportedCipherSuites Arrays asList sslSocket getSupportedCipherSuites for String enabledCipherSuite OnionKitHelper ENABLED_CIPHERS if supportedCipherSuites contains enabledCipherSuite cipherSuitesToEnable add enabledCipherSuite this mCipherSuites cipherSuitesToEnable toArray new String[cipherSuitesToEnable size ] 
public void setEnableStongerDefaultProtocalVersion boolean enable this mEnableStongerDefaultProtocalVersion enable 
public void setEnableStongerDefaultSSLCipherSuite boolean enable this mEnableStongerDefaultSSLCipherSuite enable 
public void setProxy Proxy proxy mProxy proxy 
public StrongSSLSocketFactory Context context, TrustManager trustManager, KeyStore keyStore, String keyStorePassword throws KeyManagementException, UnrecoverableKeyException, NoSuchAlgorithmException, KeyStoreException, CertificateException, IOException super keyStore mTrustManager trustManager SSLContext sslContext SSLContext getInstance "TLS" TrustManager[] tm new TrustManager[] mTrustManager KeyManager[] km createKeyManagers keyStore, keyStorePassword sslContext init km, tm, new SecureRandom mFactory sslContext getSocketFactory 
static boolean checkMatchingDomain String domain, String server, CollectionString peerIdentities boolean found false for String peerIdentity peerIdentities Check if the certificate uses a wildcard This indicates that immediate subdomains are valid if peerIdentity startsWith " " Remove wildcard foo info foo info String stem peerIdentity substring 1 Remove a single label baz bar foo info bar foo info and compare if server replaceFirst "[^ ]", "" equalsIgnoreCase stem domain replaceFirst "[^ ]", "" equalsIgnoreCase stem found true break else if server equalsIgnoreCase peerIdentity domain equalsIgnoreCase peerIdentity found true break return found 
Override public X509Certificate[] getAcceptedIssuers return new X509Certificate[0] we accept anyone now, but this should return the list from our trust Root CA Store 
public String getDomain return mDomain 
public String getFingerprint X509Certificate cert, String type throws NoSuchAlgorithmException, CertificateEncodingException MessageDigest md MessageDigest getInstance type byte[] publicKey md digest cert getEncoded StringBuffer hexString new StringBuffer for int i 0 i publicKey length i String appendString Integer toHexString 0xFF publicKey[i] if appendString length 1 hexString append "0" hexString append appendString hexString append ' ' return hexString toString 
public KeyStore getKeyStore return mTrustStore 
Returns the identity of the remote server as defined in the specified certificate The identity is defined in the subjectDN of the certificate and it can also be defined in the subjectAltName extension of type "xmpp" When the extension is being used then the identity defined in the extension in going to be returned Otherwise, the value stored in the subjectDN is returned param x509Certificate the certificate the holds the identity of the remote server return the identity of the remote server as defined in the specified certificate public static CollectionString getPeerIdentity X509Certificate x509Certificate Look the identity in the subjectAltName extension if available CollectionString names getSubjectAlternativeNames x509Certificate if names isEmpty String name x509Certificate getSubjectDN getName Matcher matcher cnPattern matcher name if matcher find name matcher group 2 Create an array with the unique identity names new ArrayListString names add name return names 
public String getServer return mServer 
Returns the JID representation of an XMPP entity contained as a SubjectAltName extension in the certificate If none was found then return ttnulltt param certificate the certificate presented by the remote entity return the JID representation of an XMPP entity contained as a SubjectAltName extension in the certificate If none was found then return ttnulltt static CollectionString getSubjectAlternativeNames X509Certificate certificate ListString identities new ArrayListString try byte[] extVal certificate getExtensionValue X509Extensions SubjectAlternativeName getId Check that the certificate includes the SubjectAltName extension if extVal null return Collections emptyList ASN1OctetString octs ASN1OctetString ASN1Primitive fromByteArray extVal SuppressWarnings "rawtypes" Enumeration it DERSequence getInstance ASN1Primitive fromByteArray octs getOctets getObjects while it hasMoreElements GeneralName genName GeneralName getInstance it nextElement switch genName getTagNo case GeneralName dNSName identities add ASN1String genName getName getString break return Collections unmodifiableCollection identities catch Exception e Log e TAG, "getSubjectAlternativeNames ", e return identities 
public KeyStore getTrustStore return mTrustStore 
public String getTrustStorePassword return TRUSTSTORE_PASSWORD 
public boolean hasCheckChainCrypto return mCheckChainCrypto 
public boolean isCheckMatchingDomain return mCheckMatchingDomain 
public boolean isExpiredCheck return mExpiredCheck 
public boolean isSelfSignedAllowed return mSelfSignedAllowed 
public boolean isVerifyChain return mVerifyChain 
public boolean isVerifyRoot return mVerifyRoot 
public void setCheckChainCrypto boolean mCheckChainCrypto this mCheckChainCrypto mCheckChainCrypto 
public void setCheckMatchingDomain boolean mCheckMatchingDomain this mCheckMatchingDomain mCheckMatchingDomain 
public void setDomain String domain this mDomain domain 
public void setExpiredCheck boolean mExpiredCheck this mExpiredCheck mExpiredCheck 
public void setNotifyVerificationFail boolean notifyVerificationFail mNotifyVerificationFail notifyVerificationFail 
public void setNotifyVerificationSuccess boolean notifyVerificationSuccess mNotifyVerificationSuccess notifyVerificationSuccess 
public void setSelfSignedAllowed boolean mSelfSignedAllowed this mSelfSignedAllowed mSelfSignedAllowed 
public void setServer String server this mServer server 
public void setTrustStore KeyStore mTrustStore this mTrustStore mTrustStore 
public void setVerifyChain boolean mVerifyChain this mVerifyChain mVerifyChain 
public void setVerifyRoot boolean mVerifyRoot this mVerifyRoot mVerifyRoot 
This method is deprecated Use link StrongTrustManager#StrongTrustManager Context , link StrongTrustManager#StrongTrustManager Context, KeyStore , or link StrongTrustManager#StrongTrustManager Context, String, int instead Deprecated public StrongTrustManager Context mContext, String appName, int appIcon throws KeyStoreException, NoSuchAlgorithmException, CertificateException, IOException this mContext 
